

<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>POS Interface</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    padding: 20px;
    max-width: 1200px;
    margin: auto;
    background: var(--primary-color);
    color: var(--secondary-color);
    padding-top: 60px;
    text-align: center;
  }
  @media (max-width: 480px) {
    body { padding: 10px; }
  }

  :root {
    --primary-color: #f2e9d8;
    --secondary-color: #333333;
    --accent-color: #3f5c4b;
    --off-white: #faf8f3;
    --section-alt-bg: #f0e6d7;
    --sakura: #f6d4dc;
    --gold: #c5a253;
  }
  .navbar-container::-webkit-scrollbar { display: none; }
  .navbar-container {
    -ms-overflow-style: none;
    scrollbar-width: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    padding: 0;
    margin: 0;
    background: rgba(255,255,255,0.65);
    backdrop-filter: blur(12px);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-bottom: 1px solid rgba(255,255,255,0.3);
    z-index: 999;
  }
  .navbar {
    display: flex;
    flex-direction: row;
    white-space: nowrap;
    position: relative;
    width: 100vw;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    scroll-behavior: auto;
  }
  .nav-categories { display: flex; white-space: nowrap; }
  @media (min-width: 768px) { .nav-categories { margin: 0 auto; } }
  .navbar a {
    flex: 0 0 auto;
    padding: 14px 20px;
    color: var(--accent-color);
    text-decoration: none;
    font-weight: bold;
    border-radius: 24px;
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
  }
  @media (max-width: 480px) {
    .navbar a { padding: 10px 14px; font-size: 0.9rem; }
    .today-btn { padding: 8px 14px; }
  }
  .navbar a.active { color: white; }
 .today-btn {
  background: linear-gradient(to bottom, #d0f0e8, #a3e4ce);
  color: #1f2e2d;
  font-weight: 600;
  padding: 10px 18px;
  border: none;
  border-radius: 14px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.12),
              inset 0 1px 0 rgba(255, 255, 255, 0.4);
  backdrop-filter: blur(6px);
  transition: all 0.2s ease-in-out;
  cursor: pointer;
  font-size: 1rem;
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 10000;
}
.today-btn:hover {
  background: linear-gradient(to bottom, #b2eadd, #86dcc3);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
              inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

 
  .navbar::after { content: ""; flex: 0 0 50vw; }
  section {
    padding: 40px 20px;
    box-sizing: border-box;
    border-bottom: 1px solid #ccc;
    border-radius: 16px;
    background: var(--off-white);
    margin-bottom: 20px;
  }
  



  section:nth-child(even) { background: var(--section-alt-bg); }
  h1,h2,h3,h4,h5,h6,p { text-align: center; }
  .menu-item {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    padding: 16px;
    margin-bottom: 12px;
    border-radius: 16px;
    background: var(--off-white);
    border: 1px solid #e0e0e0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  img { max-width: 100%; height: auto; }
  .menu-item img { width: 100%; max-width: 120px; height: auto; object-fit: cover; border-radius: 12px; flex-shrink: 0; }
  .menu-item select, .menu-item button {
    margin-top: 8px;
    padding: 6px 8px;
    font-size: 0.85rem;
    height: 36px;
    border-radius: 10px;
    border: 1px solid #ccc;
  }
  /* Ensure Omakase preference dropdowns keep full width */
  #omakasePrefs select {
    width: 100%;
    max-width: 160px;
  }
  #dragonPrefs select {
    width: 100%;
    max-width: 160px;
  }
  .pokebowl-sauces select {
    width: 100%;
    max-width: 160px;
    margin-top: 4px;
  }
  .menu-item button {
    width: 2.2rem;
    height: 2.2rem;
    font-size: 1rem;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: none;
    background:#e5e5ea;
    color:#333;
    transition: background 0.2s ease;
  }
  .menu-item button:hover { background:#dcdce0; }
  .add-button { background:#b3d4ff; color:#333; }
  .add-button:hover { background:#a3c8ff; }
  .remove-button { background:#ffd6d6; color:#333; }
  .remove-button:hover { background:#ffc2c2; }
  .xbowl-summary{background:rgba(255,255,255,0.7);backdrop-filter:blur(6px);border-radius:8px;padding:4px 8px;margin:2px 0;font-size:0.8rem;}
  @media (max-width: 600px) {
    .menu-item button { width:1.8rem; height:1.8rem; font-size:0.9rem; }
    .menu-item img { max-width:80px; }
  }
  @media (max-width: 600px) { .menu-item { flex-direction: column; align-items: flex-start; } }
@media (max-width: 767px) {
  .menu-item[data-name="X-Bowl"] { aspect-ratio: auto; height: auto; }
  .menu-item[data-name="X-Bowl"] .menu-content { position: static; }
  .menu-item[data-name="X-Bowl"] img { position: static; width: 100%; height: auto; }
  .menu-item[data-name="X-Bowl"] .qty-box { position: static; transform: none; width: 100%; margin-top: 8px; }
  #xBowlMains, #xBowlToppings {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  #xBowlMains>div, #xBowlToppings>div {
    display: flex;
    align-items: center;
    flex: 0 0 calc(50% - 3px);
  }
  #xBowlMains select, #xBowlToppings select { width: 100%; }
  #xBowlMains button, #xBowlToppings button {
    width: 1.4rem;
    height: 1.4rem;
    font-size: 0.9rem;
  }
}


  .side-tools { width: 180px; }

  .checkout-panel {
  
  top: 80px; /* 与导航栏保持一定距离 */
  align-self: flex-start;
  flex: 1.4;
  max-width: 420px;
  backdrop-filter: blur(8px);
  border-radius: 16px;
  padding: 20px;
  background: linear-gradient(to bottom, #fdfaf6, #f0e6d7);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 0, 0, 0.06);
}

 




 .checkout-panel button {
  background: linear-gradient(to bottom, #d8f4e7, #a9e5cd);
  color: #1a2e28;
  font-weight: 600;
  padding: 12px;
  width: 100%;
  font-size: 1.1rem;
  border: none;
  border-radius: 14px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12),
              inset 0 1px 0 rgba(255, 255, 255, 0.4);
  backdrop-filter: blur(6px);
  transition: all 0.2s ease-in-out;
  cursor: pointer;
}
  
  .checkout-panel button:hover {
    background: linear-gradient(to bottom, #b2eadd, #86dcc3);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
              inset 0 1px 0 rgba(255, 255, 255, 0.5);
  }

  .order-type-switch {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  .order-btn input {
    display: none;
  }
  .order-btn span {
    display: block;
    padding: 8px 16px;
    border: 1px solid var(--accent-color);
    border-radius: 8px;
    cursor: pointer;
  }
  .order-btn input:checked + span {
    background: var(--accent-color);
    color: #fff;
  }

  @media (max-width: 600px) {
    .checkout-panel { width:100%; }
  }
  .orders-slide {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #403030;
    backdrop-filter: blur(8px);
    overflow: auto;
    transform: translateX(-100%);
    transition: transform 0.3s;
    z-index: 9999;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  }
  .orders-slide.visible { transform: translateX(0); }
 
  @media (max-width: 768px) {
    .orders-panel table { display:block; overflow-x:auto; white-space:nowrap; }
  }
  .orders-panel th, .orders-panel td { border:1px solid #ddd; padding:8px; text-align:left; }
  .orders-panel th { background:#f2f2f2; }
  .orders-panel ul { margin:0; padding-left:20px; }
  input, select, textarea {
    border:1px solid rgba(255,255,255,0.4);
    border-radius:8px;
    padding:6px 10px;
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(6px);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    transition:border-color 0.2s, box-shadow 0.2s;
  }
  input:hover, select:hover, textarea:hover {
    border-color:#999;
  }
  input:focus, select:focus, textarea:focus {
    outline:none;
    border-color:var(--accent-color);
    box-shadow:0 0 0 2px rgba(63,92,75,0.2);
  }
 #closeToday {
  position: sticky;
   margin-right: 15px;  
  top: 10px;
  margin-left: auto;        /* 推到右侧 */
  width: 50px;
  height: 50px;
  background-color: transparent;
  border: none;
  border-radius: 0px;
  color: white;
  font-size: 40px;
  
 
  cursor: pointer;

  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.2s ease;
}


#closeToday:hover {
  background: #ff3b30;
  color: #fff;
  border-color: #ff3b30;
  transform: scale(1.05);
}


#closeToday:hover {
  background: #ff3b30;
  color: #fff;
  border-color: #ff3b30;
  transform: scale(1.05);
}


#closeToday:hover {
    background: #e81123; /* Windows 红色 */
    border-color: #e81123; /* Hover 时边框同步变红 */
    color: white; /* Hover 时白色 X */
}

  
  .supply-row {
    display:flex;
    align-items:center;
    gap:10px;
    margin:10px 0;
  }
  img.supply-img {
    width:40px;
    height:40px;
    object-fit:cover;
    border-radius:12px;
  }
  .supply-select {
    min-width:80px;
    padding:6px 10px;
    font-size:0.95rem;
    border-radius:10px;
    border:1px solid #ccc;
    background:white;
    appearance:none;
  }

  .cart-area button {
    width:100%;
    margin-top:10px;
    padding:12px;
    font-size:1.1rem;
    background:#b3d4ff;
    color:#333;
    border:none;
    border-radius:12px;
    transition: background 0.3s ease;
  }
  .cart-area button:hover { background:#a3c8ff; }
  .hidden { display:none; }
.cart-area {
  position: fixed;
  top: 80px;
  right: 480px; /* 420 + 40px 间距，确保不挤 */
  width: 400px; /* 稍微收窄，避免总宽超出页面 */
  max-height: calc(100vh - 100px);
  overflow-y: auto;
  background: linear-gradient(to bottom right, #fdfaf6, #f0e6d7);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 0, 0, 0.06);
  backdrop-filter: blur(8px);
  border-radius: 16px;
  padding: 20px;
  z-index: 1000;
}

.checkout-panel {
  position: fixed;
  top: 80px;
  right: 20px;
  width: 400px;  /* 也稍微收窄，避免太占空间 */
  max-height: calc(100vh - 100px);
  overflow-y: auto;
  backdrop-filter: blur(8px);
  border-radius: 16px;
  padding: 20px;
  background: linear-gradient(to bottom, #fdfaf6, #f0e6d7);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 0, 0, 0.06);
  z-index: 1000;
}

@media (max-width: 768px) {
  .cart-area {
    position: static !important;
    top: auto !important;
    right: auto !important;
    width: 100% !important;
    max-height: none !important;
    overflow: visible !important;
  }

  .checkout-panel {
    position: static !important;
    top: auto !important;
    right: auto !important;
    width: 100% !important;
    max-height: none !important;
    overflow: visible !important;
  }

  .cart-panel {
    display: none; /* 如果还在用可以保留 */
  }

  .cart-toggle { display: block; }
}

  


  .center-area {
    flex: 3;
    margin-right: 60px;
    max-width: 500px; 
  }


/* Floating cart and checkout panel */
  .cart-panel {
    position: sticky;
    top: 80px;
    align-self: flex-start;
    flex: 1.4;
    max-width: 420px;
  }
  .close-btn { display:none; }
  .cart-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    background: #fff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    font-size: 1.4rem;
    cursor: pointer;
    z-index: 1100;
    display: none;
  }
  .cart-toggle .badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #ff3b30;
    color: #fff;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.75rem;
  }
  .today-toggle {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  font-size: 1.4rem;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
  border: none;
}

.emoji-wrapper {
  position: relative;  /* ✅ 必须有这行 */
  display: inline-block;
}





  #closeCartPanel {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #e5e5ea;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 1.2rem;
    cursor: pointer;
  }
  @media (max-width: 768px) {
    .cart-toggle { display: block; }
  
    .cart-panel {
      position: fixed;
      inset: 0;
      overflow-y: auto;
      background: rgba(255,255,255,0.95);
      padding: 20px;
      z-index: 1050;
      display: none;
    }
    .cart-panel.open { display: block; }
    .close-btn { display: block; }
    .cart-panel .cart-area { position: static; top: auto; }
    .pos-layout { flex-direction: column; align-items: center; }
    .center-area { width:100%; margin-right:0; }
  }

/* 默认隐藏圆按钮 */
.today-toggle {
  display: none;
}
body.today-open {
  overflow: hidden;
}

/* 手机显示圆按钮，隐藏长按钮 */
@media (max-width: 768px) {
  .today-btn { display: none; }
  .today-toggle { display: flex; }
}

/* 🔔 新订单闪烁效果 */
.new-order {
  animation: highlightBlink 1s ease-in-out;
  animation-iteration-count: 10;
}
@keyframes highlightBlink {
  0%,100% { background-color: #eaffea; }
  50% { background-color: #fff; }
}

/* 📋 Hide order buttons when orders panel is open */
body.today-open .today-btn,
body.today-open .today-toggle {
  display: none !important;
}

/* 桌面显示长按钮，确保隐藏圆按钮 */
@media (min-width: 768px) {
  .today-btn { display: block; }
  .today-toggle { display: none; }
}

dialog#deliveryModal {
  border: none;
  border-radius: 20px;
  padding: 20px 24px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  animation: popUp 0.25s ease;
}

dialog::backdrop {
  background: rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(4px);
}

.modal-select {
  width: 100%;
  padding: 10px 14px;
  font-size: 16px;
  margin: 20px 0;
  border-radius: 12px;
  border: 1px solid #ccc;
}

.modal-buttons {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}

.modal-buttons button {
  flex: 1;
  padding: 12px 0;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.modal-buttons button#confirmDelivery {
  background-color: #34c759;
  color: white;
}

.modal-buttons button:last-child {
  background-color: #e5e5ea;
  color: #333;
}

@keyframes popUp {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}




.modal-overlay {
  position: fixed;
  z-index: 9999;
  background: rgba(0,0,0,0.5);
  top: 0; left: 0;
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
}
.modal-box {
  background: #fff;
  padding: 20px 30px;
  border-radius: 8px;
  text-align: center;
}
.modal-select {
  margin: 15px 0;
  padding: 6px 12px;
  font-size: 16px;
}
.modal-buttons button {
  margin: 0 10px;
}
/* ✅ #order-modal */
#order-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  animation: popUp 0.25s ease;
}
#order-modal > div {
  background: #fff;
  border-radius: 20px;
  padding: 24px 28px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
  position: relative;
  animation: popUp 0.25s ease;
}
#order-modal h2 {
  font-size: 20px;
  margin-bottom: 15px;
}
#order-modal p {
  font-size: 16px;
  margin: 6px 0;
}
#modal-time {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;

  text-align: center;
  font-size: 14px;
  font-weight: 500;

  background-color: #f9f9f9;
  color: #333;

  border: 1px solid #ccc;
  border-radius: 16px;

  padding: 4px 8px;
  width: 90px;
  max-width: 100%;
  box-sizing: border-box;

  box-shadow: inset 0 1px 1px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  transition: all 0.2s ease;
}

#modal-time:focus {
  outline: none;
  border-color: #aaa;
  box-shadow: 0 0 0 2px rgba(100, 150, 250, 0.15);
}


#modal-confirm {
  width: 100%;
  background-color: #34c759;
  color: white;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  padding: 12px 0;
  cursor: pointer;
  margin-top: 20px;
  transition: background 0.2s ease;
}
#modal-confirm:hover {
  background-color: #28a745;
}


.form-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }
  .form-row label {
    flex: 0 0 110px;
    margin-right: 8px;
    font-weight: 500;
  }
  .form-row input,
  .form-row select {
    flex: 1;
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
 .order-type-switch {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  margin-left: 8px; /* 控制整体右移 */
}

.order-btn input {
  display: none;
}

.order-type-switch {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  margin-left: 8px; /* 右移一点 */
}

.order-btn input {
  display: none;
}

.order-btn span {
  display: block;
  padding: 8px 16px;
  border: 1px solid var(--accent-color);
  border-radius: 8px;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.5);
  color: #1a2e28;
  font-weight: 500;
  transition: background 0.2s ease, color 0.2s ease, transform 0.15s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

.order-btn span:hover {
  background: rgba(255, 255, 255, 0.7);
  transform: scale(1.03);
}

.order-btn input:checked + span {
  background: linear-gradient(to bottom, #d8f4e7, #a9e5cd);
  color: #1a2e28;
  font-weight: 600;
  border: none; /* ✅ 移除边框 */
  
}

 
.order-type-switch {
  margin-left: 88px; /* 你可以改成 12px / 16px 看效果 */
}
.checkout-panel label {
  display: block;
  text-align: left;
  font-weight: 500;
  margin-bottom: 4px;
}
.summary-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 6px 0;
}

.summary-row label {
  flex: 1;
  text-align: left;
  font-weight: 500;
  font-size: 0.95rem;
}

.discount-group,
.custom-price-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.discount-group select,
.discount-group input,
.custom-price-group input {
  padding: 6px 8px;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 8px;
  font-size: 0.95rem;
}
#addCustomPrice {
  padding: 6px 12px;
  font-size: 0.9rem;
  border-radius: 10px;
  background-color: #b3d4ff;
  color: #333;
  border: none;
   margin-top: -3px; /* 向上移动 */
  cursor: pointer;
  transition: background 0.2s ease;
}

#addCustomPrice:hover {
  background-color: #a3c8ff;
}

/* Toast notification */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100%);
  background: rgba(0,0,0,0.8);
  color: #fff;
  padding: 10px 16px;
  border-radius: 8px;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  z-index: 10000;
}
.toast.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.zsm-badge {
  display: inline-block;
  background-color: #e53935; /* 温和红色 */
  color: white;
  font-size: 14px;
  font-weight: 600;
  padding: 6px 12px;
  margin-top: 8px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  animation: fadeIn 0.4s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

</style>
</head>
<body>
<div class="navbar-container" id="navbar-container">
  <nav class="navbar" id="navbar">
    <div class="nav-categories">
      <a href="#customer-info">Klant</a>
      <a href="#bubble">Bubble Tea</a>
      <a href="#bento">Bento Box</a>
      <a href="#Ramen">Ramen</a>
      <a href="#Teppanyaki">Teppanyaki Gebakken Rijst</a>
      <a href="#Pokebowl">Pokebowl</a>
      <a href="#sushi">Omakase Sushi</a>
      <a href="#sashimi">Sashimi</a>
      <a href="#Crispy-rice-sandwich">Crispy Rice</a>
      <a href="#snack">Snack</a>
      <a href="#dessert">Dessert</a>
      <a href="#drinks">Drinks</a>
      <a href="#vegan">Vegan</a>
    </div>
    <div class="indicator" id="indicator"></div>
  </nav>
</div>

<div class="pos-layout">
  <div class="side-tools">
    <div id="todayOrders" class="orders-slide">
      <button id="closeToday">×</button>
      <div class="orders-panel">
        {% include 'orders_table.html' %}
      </div>
    </div>
  </div>
  <div class="center-area">
    <div class="product-list">
      {% include 'menu.html' %}
    </div>
  </div>
  <div id="cartPanel" class="cart-panel">
    <button id="closeCartPanel" class="close-btn">×</button>
    <div class="cart-area">
      <h2>Overzicht</h2>
      <ul id="cart"></ul>
      <div class="supply-row">
        <img alt="Stokjes" class="supply-img photo" src="{{ url_for('static', filename='images/chopsticks.png') }}"/>
        <div class="supply-content">
          <label for="chopstickCount">Aantal stokjes</label>
          <select id="chopstickCount" class="supply-select"></select>
        </div>
      </div>
      <div class="supply-row">
        <img alt="Sojasaus" class="supply-img photo" src="{{ url_for('static', filename='images/soja saus.webp') }}"/>
        <div class="supply-content">
          <label for="soyCount">Aantal sojasaus</label>
          <select id="soyCount" class="supply-select"></select>
        </div>
      </div>
      <div class="supply-row">
        <img alt="Gember" class="supply-img photo" src="{{ url_for('static', filename='images/gembeerr.png') }}"/>
        <div class="supply-content">
          <label for="gemberCount">Aantal gember</label>
          <select id="gemberCount" class="supply-select"></select>
        </div>
      </div>
      <div class="supply-row">
        <img alt="Wasabi" class="supply-img photo" src="{{ url_for('static', filename='images/wasabib.png') }}"/>
        <div class="supply-content">
          <label for="wasabiCount">Aantal wasabi</label>
          <select id="wasabiCount" class="supply-select"></select>
        </div>
      </div>
      <div class="summary-row">
  <label>Subtotaal:</label>
  <span id="summarySubtotal">€0,00</span>
</div>

<div class="summary-row">
  <label>Verpakkingskosten:</label>
  <span id="summaryPackaging">€0,00</span>
</div>

<div id="summaryDeliveryRow" class="summary-row hidden">
  <label>Bezorgkosten:</label>
  <span id="summaryDelivery">€0,00</span>
</div>

<div class="summary-row">
  <label for="discountValue">Korting:</label>
  <div class="discount-group">
    <select id="discountType">
      <option value="amount">€</option>
      <option value="percent">%</option>
    </select>
    <input id="discountValue" type="number" value="0" min="0" step="0.01" />
    <span id="summaryDiscount">€0,00</span>
  </div>
</div>

<div class="summary-row">
  <label for="customPrice">Eigen Invoer:</label>
  <div class="custom-price-group">
    <input id="customPrice" type="number" min="0" step="0.01" />
    <button id="addCustomPrice" type="button">Toevoegen</button>
  </div>
</div>

<div class="summary-row">
  <label>BTW (9%):</label>
  <span id="summaryBtw">€0,00</span>
</div>

<div class="summary-row">
  <label><strong>Totaal:</strong></label>
  <strong><span id="total">€0,00</span></strong>
</div>

<label for="remark" style="display:block;margin-top:10px;">Opmerking:</label>
<textarea id="remark" rows="2" placeholder="Bijv. geen komkomer, extra mayo"></textarea>

    </div>
    <div class="checkout-panel">
  <section id="customer-info">
    <div class="delivery-options">
      <h2 style="margin-bottom: 6px;">Besteltype</h2>
      <div class="order-type-switch">
        <label class="order-btn">
          <input type="radio" id="typePickup" name="orderType" value="pickup" checked />
          <span>Afhalen</span>
        </label>
        <label class="order-btn">
          <input type="radio" id="typeDelivery" name="orderType" value="delivery" />
          <span>Bezorging</span>
        </label>
      </div>

      <h2 style="margin-top: 16px;">Klantgegevens</h2>

      <div class="form-row">
        <label for="custName">Naam</label>
        <input id="custName" type="text" placeholder="Naam" />
      </div>

      <div class="form-row">
        <label for="custPhone">Telefoon</label>
        <input id="custPhone" type="tel" placeholder="Telefoonnummer" />
      </div>

      <!-- Pickup Fields -->
      <div id="pickupFields" style="margin-top: 10px;">
        <div class="form-row">
          <label for="pickup_time">Pickup Tijd*</label>
          <select id="pickup_time"></select>
        </div>
        <div class="form-row">
          <label for="pickupPayment">Betaalwijze*</label>
          <select id="pickupPayment">
            <option value="pin" selected>Pin</option>
            <option value="cash">Contant</option>
            <option value="oprekening">Oprekening</option>
          </select>
        </div>
      </div>

      <!-- Delivery Fields -->
      <div id="deliveryFields" class="hidden" style="margin-top:10px;">
        <div class="form-row">
          <label for="postcode">Postcode*</label>
          <input id="postcode" type="text" placeholder="1234AB" />
        </div>
        <div class="form-row">
          <label for="houseNumber">Huisnummer*</label>
          <input id="houseNumber" type="text" placeholder="1" />
        </div>
        <div class="form-row">
          <label for="street">Straat*</label>
          <input id="street" type="text" placeholder="Straat" />
        </div>
        <div class="form-row">
          <label for="city">Plaats*</label>
          <input id="city" type="text" placeholder="Plaats" />
        </div>
        <div class="form-row">
          <label for="delivery_time">Bezorgtijd</label>
          <select id="delivery_time"></select>
        </div>
        <div class="form-row">
          <label for="deliveryPayment">Betaalwijze*</label>
          <select id="deliveryPayment">
            <option value="pin" selected>Pin</option>
            <option value="cash">Contant</option>
            <option value="oprekening">Oprekening</option>
          </select>
        </div>
      </div>

      <!-- QR Code Section -->
      <div id="qrCodeContainer" class="hidden" style="margin-top:10px;">
        <p><strong>📍 Scan voor navigatie:</strong></p>
        <img id="qrCodePreview" src="" alt="QR Code" style="display:block; margin:auto;" />
        <div id="mapsLinkContainer" style="text-align:left; margin-top:4px;"></div>
      </div>
    </div>
  </section>

  

  <button id="submitOrder">Submit Order</button>
</div>
<button id="cartToggle" class="cart-toggle">🛒<span id="cartCount" class="badge">0</span></button>
<button id="toggleToday" class="today-btn">
  Bestelling Vandaag
  <span class="badge-text-only today-badge"></span>
</button>
<button id="todayToggleMobile" class="today-toggle">
  <span class="emoji-wrapper">
    📋
    <span class="badge-text-only today-badge"></span>
  </span>
</button>




<div id="xBowlAddedModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:1000;">
  <div style="background:white; padding:20px; border-radius:12px; text-align:center;">
    <p>Toegevoegd! Nieuwe maken?</p>
    <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
      <button id="xBowlAgain">Ja, graag</button>
      <button id="xBowlClose">Nee, bedankt</button>
    </div>
  </div>
</div>

<!-- 自定义新订单弹窗 -->
<div id="order-modal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:10px; padding:20px; max-width:500px; width:90%; box-shadow:0 0 20px rgba(0,0,0,0.3); position:relative;">
    
    <!-- ✅ 放在这里 -->
    <div id="zsm-badge" style="display: none; position: absolute; top: 10px; right: 10px; background: red; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;">
      Z.S.M.
    </div>

    <h2>Nieuwe bestelling</h2>
    <p><strong>Bestelnummer:</strong> <span id="modal-order-id"></span></p>
    <p><strong>Klant:</strong> <span id="modal-customer-name"></span></p>
    <p><strong>Adres:</strong> <span id="modal-address"></span></p>
    <p><strong>Gerechten:</strong><br><span id="modal-items"></span></p>
    <p><strong>Opmerking:</strong> <span id="modal-remark"></span></p>
    <p><strong>Totaal:</strong> <span id="modal-total"></span></p>
    <label><strong>Afhaal-/bezorgtijd:</strong></label><br>
    <div id="modal-time-wrapper" style="margin-bottom:15px;">
      <input type="time" id="modal-time" />
      <div id="Z.S.M.-display" class="zsm-badge" style="display:none;">Z.S.M.</div>


    </div>

    <br>
    <button id="modal-confirm" style="padding:8px 16px;">✅ Bevestigen</button>
  </div>
</div>
<dialog id="deliveryModal">
  <form method="dialog">
    <h3>Kies een bezorger</h3>
    <select id="deliverySelect" class="modal-select"></select>
    <div class="modal-buttons">
      <button id="confirmDelivery" type="button">Bevestigen</button>
      <button type="button" onclick="document.getElementById('deliveryModal').close()">Annuleer</button>
    </div>
  </form>
</dialog>



<script>
const cart = {};
const extras = {
  chopstickCount: { label: 'Stokjes', price: 0 },
  soyCount: { label: 'Sojasaus', price: 0 },
  gemberCount: { label: 'Gember', price: 0 },
  wasabiCount: { label: 'Wasabi', price: 0 }
};
let milkTeaPrice = 0;
let bubbleOptions = {base: [], smaak: [], topping: []};
let xbentoOptions = {main: [], side: [], rice: [], groente: []};
const xbowlBases=[
  {name:'Sushi rijst',price:4},
  {name:'IJsbergsla',price:5},
  {name:'Tempura crispy rijst',price:6}
];
const xbowlMains=[
  {name:'geen',price:0},
  {name:'Zalm',price:9},
  {name:'Tonijn',price:9},
  {name:'Gamba',price:8},
  {name:'Crispy chicken',price:8},
  {name:'Spicy crispy chicken',price:8},
  {name:'Teriyaki beef',price:9},
  {name:'Teriyaki chicken',price:9},
  {name:'Ribeye',price:9},
  {name:'Unagi',price:9},
  {name:'Spicy tuna',price:9},
  {name:'Krabstick',price:8}
];
const xbowlToppings=['geen','Komkommer','Avocado','Sojabonen','Mais','Zeewiersalade','Masago','Inari','Tamago'];
const XBOWL_TOPPING_PRICE=1.5;
const SAUCE_OPTIONS=['Geen','Japans mayo','Spicy mayo','Unagi saus','Spicy teriyaki saus','Korean chili saus','Cury mayo','Japans chili saus','Soy saus','Truffel mayo','Wasabi mayo'];
const POKEBOWL_IDS=['zalmBowlQty','tunaBowlQty','ebiFryBowlQty','chickenKaraageBowlQty','spicyChickenBowlQty','teriyakiChickenBowlQty','teriyakiBeefBowlQty','californiaBowlQty','vegaBowlQty','meatloverBowlQty','rainbowBowlQty','spicyTunaBowlQty','flamedZalmBowlQty','flamedTunaBowlQty','snackCount','ebiFryCount','ebikroketCount','spicyCrispyChickenCount','miniLoempiaCount','japansZalmNuggetCount','chickenLoempiaCount','gyozaCount','inktvisRingenCount'];
let currentXBowlName="";

function getOptionPrice(cat,name){
  const opt=(bubbleOptions[cat]||[]).find(o=>o.name===name);
  return opt?parseFloat(opt.price):0;
}

function getBubbleTeaPrice(){
  const type=document.getElementById('bubbleType').value;
  const flavor=document.getElementById('bubbleFlavor').value;
  const topping=document.getElementById('bubbleTopping').value;
  return getOptionPrice('base',type)+getOptionPrice('smaak',flavor)+getOptionPrice('topping',topping);
}

function updateMilkTeaDisplay(){
  milkTeaPrice=getBubbleTeaPrice();
  const item=document.querySelector('.menu-item[data-name="Bubble Tea"]');
  if(item){
    item.dataset.price=milkTeaPrice;
    const p=item.querySelector('p');
    if(p) p.textContent=`€${milkTeaPrice.toFixed(2)}`;
  }
}

function getXbentoOptionPrice(cat,name){
  const opt=(xbentoOptions[cat]||[]).find(o=>o.name===name);
  return opt?parseFloat(opt.price):0;
}

function getXbentoPrice(){
  const main=document.getElementById('xBentoMain').value;
  const side=document.getElementById('xBentoSide').value;
  const rice=document.getElementById('xBentoRice').value;
  const veg=document.getElementById('xBentoVeg').value;
  return getXbentoOptionPrice('main',main)+getXbentoOptionPrice('side',side)+getXbentoOptionPrice('rice',rice)+getXbentoOptionPrice('groente',veg);
}

function updateXbentoDisplay(){
  const price=getXbentoPrice();
  const item=document.querySelector('.menu-item[data-name="Xbento"]');
  if(item){
    item.dataset.price=price;
    const p=item.querySelector('p');
    if(p) p.textContent=`€${price.toFixed(2)}`;
  }
}

function getXBowlSelections(){
  const baseSel=document.getElementById('xBowlBase');
  const baseOpt=baseSel?baseSel.selectedOptions[0]:null;
  const mains=Array.from(document.querySelectorAll('#xBowlMains select')).map(s=>s.selectedOptions[0]).filter(o=>o&&o.value);
  const toppings=Array.from(document.querySelectorAll('#xBowlToppings select')).map(s=>s.value).filter(v=>v);
  return{baseOpt,mains,toppings};
}

function updateXBowlDisplay(){
  const {baseOpt,mains,toppings}=getXBowlSelections();
  let price=0;
  if(baseOpt&&baseOpt.dataset.price) price+=parseFloat(baseOpt.dataset.price);
  mains.forEach(o=>{price+=parseFloat(o.dataset.price||0);});
  const paidTops=toppings.filter(t=>t.toLowerCase()!=='geen');
  price+=paidTops.length*XBOWL_TOPPING_PRICE;
  const item=document.querySelector('.menu-item[data-name="X-Bowl"]');
  if(item){
    item.dataset.price=price;
    const p=document.getElementById('xBowlPrice');
    if(p) p.textContent=price?`€ ${price.toFixed(2)}`:'Prijs afhankelijk van keuzes';
    const info=document.getElementById('xBowlSummary');
    if(info){
      const mainNames=mains.map(o=>o.value).join(', ');
      const topNames=toppings.join(', ');
      let parts=[];
      if(baseOpt&&baseOpt.value) parts.push(baseOpt.value);
      if(mainNames) parts.push(mainNames);
      if(topNames) parts.push(topNames);
      const text=parts.join(' | ');
      info.textContent=text?`${text} - € ${price.toFixed(2)}`:'';
    }
  }
}

function getXBowlName(){
  const {baseOpt,mains,toppings}=getXBowlSelections();
  if(!baseOpt||!baseOpt.value||mains.length===0) return '';
  const mainNames=mains.map(o=>o.value).join(', ');
  const topNames=toppings.join(', ');
  return `X-Bowl (${baseOpt.value} | ${mainNames}${topNames?' | '+topNames:''})`;
}

function updateXBowlControls(){
  const wrap=document.getElementById('xBowlNewWrap');
  const qty=parseInt(document.getElementById('xBowlQty').value||0);
  if(isXbowlValid()&&qty>0) wrap.classList.remove('hidden');
  else wrap.classList.add('hidden');
}

function changeXbowlQty(delta){
  const sel=document.getElementById('xBowlQty');
  let val=parseInt(sel.value||0);
  const name=getXBowlName();
  if(!name) return;
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  updateXBowlDisplay();
  const price=parseFloat(document.querySelector('.menu-item[data-name="X-Bowl"]').dataset.price||0);
  if(currentXBowlName && currentXBowlName!==name && cart[currentXBowlName]){
    delete cart[currentXBowlName];
  }
  setQty(name,price,val,0.2);
  currentXBowlName=name;
  updateXBowlControls();
  if(delta>0 && val>0) showXBowlModal();
}

function createXBowlMainSelect(){
  const div=document.createElement('div');
  const sel=document.createElement('select');
  sel.innerHTML='<option value="">Hoofdingredient</option>';
  xbowlMains.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.dataset.price=o.price;opt.textContent=o.name;sel.appendChild(opt);});
  const del=document.createElement('button');del.type='button';del.textContent='❌';
  del.addEventListener('click',()=>{div.remove();ensureXBowlMain();updateXBowlDisplay();updateXBowlControls();changeXbowlQty(0);});
  sel.addEventListener('change',()=>{
    const val = sel.value.toLowerCase();
    if(sel.value && val !== 'geen' && div===document.querySelector('#xBowlMains').lastElementChild){
      if(confirm('Wil je extra portie?')){
        document.getElementById('xBowlMains').appendChild(createXBowlMainSelect());
      }
    }
    updateXBowlDisplay();
    updateXBowlControls();
    changeXbowlQty(0);
  });
  div.appendChild(sel);div.appendChild(del);return div;
}

function createXBowlToppingSelect(){
  const div=document.createElement('div');
  const sel=document.createElement('select');
  sel.innerHTML='<option value="">Topping</option>';
  xbowlToppings.forEach(n=>{const opt=document.createElement('option');opt.value=n;opt.textContent=n;sel.appendChild(opt);});
  const del=document.createElement('button');del.type='button';del.textContent='❌';
  del.addEventListener('click',()=>{div.remove();ensureXBowlTopping();updateXBowlDisplay();updateXBowlControls();changeXbowlQty(0);});
  sel.addEventListener('change',()=>{
    const val = sel.value.toLowerCase();
    if(sel.value && val !== 'geen' && div===document.querySelector('#xBowlToppings').lastElementChild){
      if(confirm('Wil je extra topping toevoegen?')){
        document.getElementById('xBowlToppings').appendChild(createXBowlToppingSelect());
      }
    }
    updateXBowlDisplay();
    updateXBowlControls();
    changeXbowlQty(0);
  });
  div.appendChild(sel);div.appendChild(del);return div;
}

function ensureXBowlMain(){
  const wrap=document.getElementById('xBowlMains');
  if(!wrap.querySelector('select')) wrap.appendChild(createXBowlMainSelect());
}

function ensureXBowlTopping(){
  const wrap=document.getElementById('xBowlToppings');
  if(!wrap.querySelector('select')) wrap.appendChild(createXBowlToppingSelect());
}

function clearXBowlSet(){
  document.getElementById('xBowlBase').value='';
  document.getElementById('xBowlMains').innerHTML='';
  document.getElementById('xBowlToppings').innerHTML='';
  document.getElementById('xBowlQty').value=0;
  ensureXBowlMain();
  ensureXBowlTopping();
  updateXBowlDisplay();
  updateXBowlControls();
  currentXBowlName="";
}

function applyCrispyPrices(prices){
  const map={
    'Zalm crispy rice sandwich': parseFloat(prices.price_zalm_crispy_rice_sandwich),
    'Spicytuna crispy rice sandwich': parseFloat(prices.price_spicytuna_crispy_rice_sandwich),
    'Ebi crispy rice sandwich': parseFloat(prices.price_ebi_crispy_rice_sandwich),
    'Beef crispy rice sandwich': parseFloat(prices.price_beef_crispy_rice_sandwich),
    'California crispy rice sandwich': parseFloat(prices.price_california_crispy_rice_sandwich),
    'Chicken crispy rice sandwich': parseFloat(prices.price_chicken_crispy_rice_sandwich)
  };
  Object.entries(map).forEach(([name,price])=>{
    if(isNaN(price)) return;
    const el=document.querySelector(`.menu-item[data-name="${name}"]`);
    if(el){
      el.dataset.price=price;
      const pe=el.querySelector('p');
      if(pe) pe.textContent=`€${price.toFixed(2)}`;
    }
  });
}

function changeBubbleQty(delta){
  const sel=document.getElementById('bubbleTeaQty');
  let val=parseInt(sel.value||0);
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  const type=document.getElementById('bubbleType').value;
  const flavor=document.getElementById('bubbleFlavor').value;
  const topping=document.getElementById('bubbleTopping').value;
  if(!type||!flavor||!topping) return;
  const name=`Bubble Tea (${type}, ${flavor}, ${topping})`;
  const price=getBubbleTeaPrice();
  setQty(name,price,val,0.2);
}

function changeXbentoQty(delta){
  const sel=document.getElementById('xBentoQty');
  let val=parseInt(sel.value||0);
  const main=document.getElementById('xBentoMain').value;
  const side=document.getElementById('xBentoSide').value;
  const rice=document.getElementById('xBentoRice').value;
  const veg=document.getElementById('xBentoVeg').value;
  if(!main||!side||!rice||!veg) return;
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  const price=getXbentoPrice();
  const name=`Xbento (${main}, ${side}, ${rice}, ${veg})`;
  setQty(name,price,val,0.2);
}

function changeOmakaseQty(delta){
  const sel=document.getElementById('sushiBentoCount');
  let val=parseInt(sel.value||0);
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  updateOmakasePrefs();
}

function updateOmakasePrefs(){
  const qty=parseInt(document.getElementById('sushiBentoCount').value||0);
  const container=document.getElementById('omakasePrefs');
  container.innerHTML='';

  const existing=(cart['Bento Sushi Omakase']&&cart['Bento Sushi Omakase'].prefs)||[];
  for(let i=1;i<=qty;i++){
    const sel=document.createElement('select');
    ['Geen voorkeur','Alleen vis','Alleen vlees','Alleen veggie'].forEach(opt=>{
      const o=document.createElement('option');o.value=opt;o.textContent=opt;sel.appendChild(o);});
    sel.value=existing[i-1]||'Geen voorkeur';
    sel.id=`omakasePref${i}`;
    sel.addEventListener('change',setOmakaseQty);
    container.appendChild(sel);
  }
  setOmakaseQty();
}

function setOmakaseQty(){
  const qty=parseInt(document.getElementById('sushiBentoCount').value||0);
  const prefs=[];

  for(let i=1;i<=qty;i++){
    prefs.push(document.getElementById(`omakasePref${i}`).value);
  }
  const price=parseFloat(document.querySelector('[data-name="Bento Sushi Omakase"]').dataset.price);
  setQty('Bento Sushi Omakase',price,qty,0.2,prefs);
}

function changeDragonQty(delta){
  const sel=document.getElementById('dragonRollCount');
  let val=parseInt(sel.value||0);
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  updateDragonPrefs();
}

function updateDragonPrefs(){
  const qty=parseInt(document.getElementById('dragonRollCount').value||0);
  const container=document.getElementById('dragonPrefs');
  container.innerHTML='';

  const existing=(cart['Dragon Roll Omakase']&&cart['Dragon Roll Omakase'].prefs)||[];
  for(let i=1;i<=qty;i++){
    const sel=document.createElement('select');
    ['Geen voorkeur','Alleen vis','Alleen vlees'].forEach(opt=>{
      const o=document.createElement('option');o.value=opt;o.textContent=opt;sel.appendChild(o);});
    sel.value=existing[i-1]||'Geen voorkeur';
    sel.id=`dragonPref${i}`;
    sel.addEventListener('change',setDragonQty);
    container.appendChild(sel);
  }
  setDragonQty();
}

function setDragonQty(){
  const qty=parseInt(document.getElementById('dragonRollCount').value||0);
  const prefs=[];
  for(let i=1;i<=qty;i++){
    prefs.push(document.getElementById(`dragonPref${i}`).value);
  }
  const price=parseFloat(document.querySelector('[data-name="Dragon Roll Omakase"]').dataset.price);
  setQty('Dragon Roll Omakase',price,qty,0.2,prefs);
}

function updatePokebowlSauces(id,name){
  const qty=parseInt(document.getElementById(id).value||0);
  const container=document.getElementById(id+'Sauces');
  if(!container) return;
  container.innerHTML='';
  const existing=(cart[name]&&cart[name].prefs)||[];
  for(let i=1;i<=qty;i++){
    const sel=document.createElement('select');
    SAUCE_OPTIONS.forEach(opt=>{const o=document.createElement('option');o.value=opt;o.textContent=opt;sel.appendChild(o);});
    sel.value=existing[i-1]||'Geen';
    sel.dataset.index=i;
    sel.addEventListener('change',()=>setPokebowlQty(id,name));
    container.appendChild(sel);
  }
  setPokebowlQty(id,name);
}

function setPokebowlQty(id,name){
  const sel=document.getElementById(id);
  const qty=parseInt(sel.value||0);
  const pack=parseFloat(sel.closest('.menu-item').dataset.packaging||0);
  const price=parseFloat(sel.closest('.menu-item').dataset.price||0);
  const container=document.getElementById(id+'Sauces');
  const prefs=[];
  for(let i=1;i<=qty;i++){
    const s=container.querySelector(`select[data-index="${i}"]`);
    prefs.push(s?s.value:'Geen');
  }
  setQty(name,price,qty,pack,prefs);
}

function isRamenValid(code){
  return document.getElementById(code+'Base').value && document.getElementById(code+'Smaak').value;
}

function isXbowlValid(){
  const base=document.getElementById('xBowlBase').value;
  const hasMain=Array.from(document.querySelectorAll('#xBowlMains select')).some(s=>s.value);
  return base&&hasMain;
}

function changeRamenQty(code,delta){
  const sel=document.getElementById(code+'Qty');
  let val=parseInt(sel.value||0);
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  const item=document.querySelector(`.menu-item[data-code="${code}"]`);
  const base=document.getElementById(code+'Base').value;
  const smaak=document.getElementById(code+'Smaak').value;
  if(!base||!smaak) return;
  const name=item.dataset.name;
  const price=parseFloat(item.dataset.price);
  const pack=parseFloat(item.dataset.packaging||0);
  const fullName=`${name} - ${base} - ${smaak}`;
  setQty(fullName,price,val,pack);
}
function populateSelect(sel){
  for(let i=0;i<=20;i++){ const opt=document.createElement('option'); opt.value=i; opt.textContent=i; sel.appendChild(opt); }
}
function createSelect(current,onChange){
  const sel=document.createElement('select');
  for(let i=0;i<=20;i++){ const opt=document.createElement('option'); opt.value=i; opt.textContent=i; if(i===current) opt.selected=true; sel.appendChild(opt); }
  sel.addEventListener('change',()=>onChange(parseInt(sel.value))); return sel;
}
function setQty(name,price,qty,packaging=0,prefs=null){
  if(qty===0){
    delete cart[name];
  } else {
    cart[name]={price,qty,packaging};
    if(prefs) cart[name].prefs=prefs; else if(cart[name]&&cart[name].prefs) delete cart[name].prefs;
  }
  updateCart();
}
function updateCart() {
  const list = document.getElementById('cart');
  list.innerHTML = '';
  let subtotal = 0;
  let packagingTotal = 0;
  let count = 0;

  Object.entries(cart).forEach(([name, item]) => {
    const li = document.createElement('li');

    const displayName = item.displayName || name;

    const rowTotal = item.qty * item.price;

    const label = document.createElement('span');
    label.textContent = `${displayName} x ${item.qty} - €${rowTotal.toFixed(2)} `;

    li.appendChild(label);

    if (item.custom) {
      const delBtn = document.createElement('button');
      delBtn.textContent = '🗑';
      delBtn.addEventListener('click', () => {
        delete cart[name];
        updateCart();
      });
      li.appendChild(delBtn);
    } else {
      const sel = createSelect(item.qty, val => {
        const menuItem = document.querySelector(`[data-name="${name}"]`);
        if (menuItem) {
          const qtyInput = menuItem.querySelector('select');
          if (qtyInput) qtyInput.value = val;
        }
        setQty(name, item.price, val, item.packaging, item.prefs);

        if (name === 'Bento Sushi Omakase') {
          document.getElementById('sushiBentoCount').value = val;
          updateOmakasePrefs();
        } else if (name === 'Dragon Roll Omakase') {
          document.getElementById('dragonRollCount').value = val;
          updateDragonPrefs();
        }
      });
      li.appendChild(sel);
    }

    if (item.prefs) {
      const title = document.createElement('div');
      title.textContent = 'Voorkeur:';
      const ul = document.createElement('ul');
      item.prefs.forEach((p, i) => {
        const liP = document.createElement('li');
        liP.textContent = `${i + 1}. ${p}`;
        ul.appendChild(liP);
      });
      li.appendChild(title);
      li.appendChild(ul);
    }

    list.appendChild(li);

    if (item.qty > 0) {
      subtotal += rowTotal;
      packagingTotal += (item.packaging || 0) * item.qty;
    }

    count += item.qty;
  });

  const delivery = document.getElementById('typeDelivery').checked ? 2.5 : 0;

  const discountType = document.getElementById('discountType').value;
  let discountVal = parseFloat(document.getElementById('discountValue').value) || 0;
  let discount = 0;
  if (discountType === 'amount') {
    discount = Math.min(discountVal, subtotal);
  } else if (discountType === 'percent') {
    discount = Math.min(discountVal, 100) / 100 * subtotal;
  }
  if (discount < 0 || isNaN(discount)) discount = 0;

  const total = subtotal + packagingTotal + delivery - discount;
  const btwBase = delivery ? total - delivery : total;
  const btw = btwBase * 0.09;

  const fmt = n => `€${n.toFixed(2).replace('.', ',')}`;

  document.getElementById('summarySubtotal').textContent = fmt(subtotal);
  document.getElementById('summaryPackaging').textContent = fmt(packagingTotal);
  document.getElementById('summaryDelivery').textContent = fmt(delivery);
  document.getElementById('summaryDeliveryRow').classList.toggle('hidden', !delivery);
  document.getElementById('summaryDiscount').textContent = discount ? `- ${fmt(discount)}` : '€0,00';
  document.getElementById('summaryBtw').textContent = fmt(btw);
  document.getElementById('total').textContent = fmt(total);

  const badge = document.getElementById('cartCount');
  if (badge) badge.textContent = count;
}


function addCustomPrice(){
  const input=document.getElementById('customPrice');
  const val=parseFloat(input.value);
  if(isNaN(val)||val<=0) return;
  const key='custom_'+Date.now();
  cart[key]={price:val,qty:1,custom:true,displayName:'Eigen Invoer'};
  input.value='';
  updateCart();
}

document.addEventListener('DOMContentLoaded',()=>{
  const skip=['bubbleTeaQty','bubbleType','bubbleFlavor','bubbleTopping','xBentoMain','xBentoSide','xBentoRice','xBentoVeg','xBowlBase','xBowlQty',
    'ebiBase','ebiSmaak','ebiQty','chickenBase','chickenSmaak','chickenQty','beefBase','beefSmaak','beefQty',
    'ribeyeBase','ribeyeSmaak','ribeyeQty','chasiuBase','chasiuSmaak','chasiuQty','zhaiBase','zhaiSmaak','zhaiQty'];
  document.querySelectorAll('.menu-item select').forEach(sel=>{
    if(!skip.includes(sel.id) && !sel.closest('#xBowlMains') && !sel.closest('#xBowlToppings')){
      populateSelect(sel);
      const parent=sel.closest('.menu-item');
      const name=parent.dataset.name;
      const price=parseFloat(parent.dataset.price);
      const pack=parseFloat(parent.dataset.packaging||0);
      if(name==='Bento Sushi Omakase'){
        sel.addEventListener('change',()=>changeOmakaseQty(0));
      } else if(name==='Dragon Roll Omakase'){
        sel.addEventListener('change',()=>changeDragonQty(0));
      } else if(POKEBOWL_IDS.includes(sel.id)){
        sel.addEventListener('change',()=>updatePokebowlSauces(sel.id,name));
        updatePokebowlSauces(sel.id,name);
      } else {
        sel.addEventListener('change',()=>{ setQty(name,price,parseInt(sel.value),pack); });
      }
    }
  });

  ['bubbleTeaQty','xBentoQty','xBowlQty'].forEach(id=>{
    const s=document.getElementById(id);
    for(let i=0;i<=20;i++){const opt=document.createElement('option');opt.value=i;opt.text=i;s.appendChild(opt);} s.value=0;
  });
  ['bubbleType','bubbleFlavor','bubbleTopping'].forEach(id=>{
    document.getElementById(id).addEventListener('change',()=>{updateMilkTeaDisplay();});
  });
  ['xBentoMain','xBentoSide','xBentoRice','xBentoVeg'].forEach(id=>{
    document.getElementById(id).addEventListener('change',()=>{updateXbentoDisplay();});
  });

  document.querySelector('.qty-plus[data-target="bubbleTeaQty"]').addEventListener('click',()=>{
    if(!document.getElementById('bubbleType').value||!document.getElementById('bubbleFlavor').value||!document.getElementById('bubbleTopping').value){alert('🧋 Kies eerst type, smaak en topping voor je bubble tea.');return;}changeBubbleQty(1);});
  document.querySelector('.qty-minus[data-target="bubbleTeaQty"]').addEventListener('click',()=>{
    if(!document.getElementById('bubbleType').value||!document.getElementById('bubbleFlavor').value||!document.getElementById('bubbleTopping').value){alert('🧋 Kies eerst type, smaak en topping voor je bubble tea.');return;}changeBubbleQty(-1);});
  document.getElementById('bubbleTeaQty').addEventListener('change',()=>{if(!document.getElementById('bubbleType').value||!document.getElementById('bubbleFlavor').value||!document.getElementById('bubbleTopping').value){alert('🧋 Kies eerst type, smaak en topping voor je bubble tea.');document.getElementById('bubbleTeaQty').value=0;return;}changeBubbleQty(0);});

  document.querySelector('.qty-plus[data-target="xBentoQty"]').addEventListener('click',()=>{
    if(!document.getElementById('xBentoMain').value||!document.getElementById('xBentoSide').value||!document.getElementById('xBentoRice').value||!document.getElementById('xBentoVeg').value){alert('🍱 Kies eerst hoofdgerecht, bijgerecht, rijstsoort en groente voor je Xbento.');return;}changeXbentoQty(1);});
  document.querySelector('.qty-minus[data-target="xBentoQty"]').addEventListener('click',()=>{
    if(!document.getElementById('xBentoMain').value||!document.getElementById('xBentoSide').value||!document.getElementById('xBentoRice').value||!document.getElementById('xBentoVeg').value){alert('🍱 Kies eerst hoofdgerecht, bijgerecht, rijstsoort en groente voor je Xbento.');return;}changeXbentoQty(-1);});
  document.getElementById('xBentoQty').addEventListener('change',()=>{if(!document.getElementById('xBentoMain').value||!document.getElementById('xBentoSide').value||!document.getElementById('xBentoRice').value||!document.getElementById('xBentoVeg').value){alert('🍱 Kies eerst hoofdgerecht, bijgerecht, rijstsoort en groente voor je Xbento.');document.getElementById('xBentoQty').value=0;return;}changeXbentoQty(0);});

  ensureXBowlMain();
  ensureXBowlTopping();
  document.getElementById('xBowlBase').addEventListener('change',()=>{updateXBowlDisplay();updateXBowlControls();changeXbowlQty(0);});
  document.getElementById('xBowlNew').addEventListener('click',clearXBowlSet);
  document.querySelector('.qty-plus[data-target="xBowlQty"]').addEventListener('click',()=>{if(!isXbowlValid()){alert('🥗 Basis en hoofdingrediënt vereist.');return;}changeXbowlQty(1);});
  document.querySelector('.qty-minus[data-target="xBowlQty"]').addEventListener('click',()=>{if(!isXbowlValid()){alert('🥗 Basis en hoofdingrediënt vereist.');return;}changeXbowlQty(-1);});
  document.getElementById('xBowlQty').addEventListener('change',()=>{if(!isXbowlValid()){alert('🥗 Basis en hoofdingrediënt vereist.');document.getElementById('xBowlQty').value=0;return;}changeXbowlQty(0);});

  const ramenIds=['ebiQty','chickenQty','beefQty','ribeyeQty','chasiuQty','zhaiQty'];
  document.querySelectorAll('.qty-plus').forEach(btn=>{
    if(['bubbleTeaQty','xBentoQty','xBowlQty',...ramenIds].includes(btn.dataset.target)) return;
    btn.addEventListener('click',()=>{
      const sel=document.getElementById(btn.dataset.target);
      let val=parseInt(sel.value);
      if(val<20) val++;
      sel.value=val;
      const parent=sel.closest('.menu-item');
      if(parent.dataset.name==='Bento Sushi Omakase'){
        changeOmakaseQty(0);
      } else if(parent.dataset.name==='Dragon Roll Omakase'){
        changeDragonQty(0);
      } else if(POKEBOWL_IDS.includes(sel.id)){
        updatePokebowlSauces(sel.id,parent.dataset.name);
      } else {
        setQty(parent.dataset.name,parseFloat(parent.dataset.price),val,parseFloat(parent.dataset.packaging||0));
      }
    });
  });
  document.querySelectorAll('.qty-minus').forEach(btn=>{
    if(['bubbleTeaQty','xBentoQty','xBowlQty',...ramenIds].includes(btn.dataset.target)) return;
    btn.addEventListener('click',()=>{
      const sel=document.getElementById(btn.dataset.target);
      let val=parseInt(sel.value);
      if(val>0) val--;
      sel.value=val;
      const parent=sel.closest('.menu-item');
      if(parent.dataset.name==='Bento Sushi Omakase'){
        changeOmakaseQty(0);
      } else if(parent.dataset.name==='Dragon Roll Omakase'){
        changeDragonQty(0);
      } else if(POKEBOWL_IDS.includes(sel.id)){
        updatePokebowlSauces(sel.id,parent.dataset.name);
      } else {
        setQty(parent.dataset.name,parseFloat(parent.dataset.price),val,parseFloat(parent.dataset.packaging||0));
      }
    });
  });

  const ramenCodes=['ebi','chicken','beef','ribeye','chasiu','zhai'];
  ramenCodes.forEach(code=>{
    const qty=document.getElementById(code+'Qty');
    populateSelect(qty);
    qty.value=0;
    document.querySelector(`.qty-plus[data-target="${code}Qty"]`).addEventListener('click',()=>{
      if(!isRamenValid(code)){alert('🍜 Kies eerst base en smaak voor je ramen.');return;}
      changeRamenQty(code,1);
    });
    document.querySelector(`.qty-minus[data-target="${code}Qty"]`).addEventListener('click',()=>{
      if(!isRamenValid(code)){alert('🍜 Kies eerst base en smaak voor je ramen.');return;}
      changeRamenQty(code,-1);
    });
    qty.addEventListener('change',()=>{
      if(!isRamenValid(code)){alert('🍜 Kies eerst base en smaak voor je ramen.');qty.value=0;return;}
      changeRamenQty(code,0);
    });
    document.getElementById(code+'New').addEventListener('click',()=>{
      document.getElementById(code+'Base').value='';
      document.getElementById(code+'Smaak').value='';
      qty.value=0;
    });
  });
  ['chopstickCount','soyCount','gemberCount','wasabiCount'].forEach(id=>{
    populateSelect(document.getElementById(id));
    document.getElementById(id).addEventListener('change',updateCart);
  });
  document.getElementById('discountType').addEventListener('change',updateCart);
  document.getElementById('discountValue').addEventListener('input',updateCart);
  const addCustomBtn=document.getElementById('addCustomPrice');
  if(addCustomBtn){
    addCustomBtn.addEventListener('click',addCustomPrice);
  }
  const toggleTodayBtn = document.getElementById('toggleToday');
  if (toggleTodayBtn) {
    toggleTodayBtn.addEventListener('click', toggleToday);
  }
  const todayToggleMobile=document.getElementById('todayToggleMobile');
  if(todayToggleMobile){
    todayToggleMobile.addEventListener('click',toggleToday);
  }
  document.getElementById('closeToday').addEventListener('click',toggleToday);
  document.getElementById('typePickup').addEventListener('change',toggleAddress);
  document.getElementById('typeDelivery').addEventListener('change',toggleAddress);
  document.getElementById('postcode').addEventListener('blur',fetchAddress);
  document.getElementById('houseNumber').addEventListener('blur',fetchAddress);
  document.getElementById('postcode').addEventListener('blur',updateQRCode);
  document.getElementById('houseNumber').addEventListener('blur',updateQRCode);
  document.getElementById('street').addEventListener('blur',updateQRCode);
  document.getElementById('city').addEventListener('blur',updateQRCode);
  document.getElementById('submitOrder').addEventListener('click',submitOrder);
  const cartToggle=document.getElementById('cartToggle');
  const cartPanel=document.getElementById('cartPanel');
  const closeCart=document.getElementById('closeCartPanel');
  if(cartToggle){
    cartToggle.addEventListener('click',()=>{
      cartPanel.classList.toggle('open');
    });
  }
  if(closeCart){
    closeCart.addEventListener('click',()=>cartPanel.classList.remove('open'));
  }
  if(cartPanel){
    cartPanel.addEventListener('click',e=>{
      if(e.target===cartPanel) cartPanel.classList.remove('open');
    });
  }
  updateOmakasePrefs();
  updateDragonPrefs();
  updateCart();
  toggleAddress();
  updateTodayBadge();

});

function toggleToday(){
  const panel=document.getElementById('todayOrders');
  panel.classList.toggle('visible');
  const open = panel.classList.contains('visible');
  document.body.classList.toggle('today-open', open);
  if(open){
    fetchOrders();
    newOrderCount = 0;
    hasNewOrder = false;
    updateTabTitle();
  }
  updateTodayBadge();
}


function showTodayOrders(){
  const panel=document.getElementById('todayOrders');
  if(!panel.classList.contains('visible')){
    panel.classList.add('visible');
    document.body.classList.add('today-open');
    fetchOrders();
  }
}

function toggleAddress(){
  const delivery=document.getElementById('typeDelivery').checked;
  document.getElementById('pickupFields').classList.toggle('hidden',delivery);
  document.getElementById('deliveryFields').classList.toggle('hidden',!delivery);
  document.getElementById('pickup_time').required=!delivery?true:false;
  document.getElementById('pickupPayment').required=!delivery?true:false;
  document.getElementById('postcode').required=delivery;
  document.getElementById('houseNumber').required=delivery;
  document.getElementById('deliveryPayment').required=delivery;
  if(!delivery){
    populateTimeOptions('pickup_time',30);
    document.getElementById('qrCodeContainer').classList.add('hidden');
  } else {
    populateTimeOptions('delivery_time',45);
    updateQRCode();
  }
  updateCart();
}
async function fetchAddress() {
  const pc = document.getElementById('postcode').value.trim();
  const num = document.getElementById('houseNumber').value.trim();
  if (!pc || !num) return;

  const url = `https://flask-order-api.onrender.com/api/postcode?postcode=${encodeURIComponent(pc)}&number=${encodeURIComponent(num)}`;
  try {
    const res = await fetch(url);
    if (res.ok) {
      const d = await res.json();
      if (d.street) document.getElementById('street').value = d.street;
      if (d.city) document.getElementById('city').value = d.city;
      updateQRCode();  // 成功后更新二维码
    } else {
      console.warn('API error:', res.status);
    }
  } catch (e) {
    console.warn('Adres ophalen mislukt', e);
  }
}


function updateQRCode(){
  const street=document.getElementById('street').value.trim();
  const house=document.getElementById('houseNumber').value.trim();
  const pc=document.getElementById('postcode').value.trim();
  const city=document.getElementById('city').value.trim();
  const container=document.getElementById('qrCodeContainer');
  const img=document.getElementById('qrCodePreview');
  const linkContainer=document.getElementById('mapsLinkContainer');
  if(street && house && pc && city){
    const address=`${street} ${house}, ${pc} ${city}`;
    const googleMapsLink=`https://www.google.com/maps?q=${encodeURIComponent(address)}`;
    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(googleMapsLink)}`;

    img.src=qrCodeUrl;
    linkContainer.innerHTML=`<a href="${googleMapsLink}" target="_blank" style="color: var(--accent-color); text-decoration: underline;">Open in Google Maps</a>`;
    container.classList.remove('hidden');
  }else{
    img.src='';
    linkContainer.innerHTML='';
    container.classList.add('hidden');
  }
}

function clearForm(){
  // 🟢 Ensure checkout fields are enabled for a new order
  document.querySelectorAll('#customer-info input, #customer-info select, #customer-info textarea')
    .forEach(el => { el.disabled = false; });

  ['custName','custPhone','pickup_time','delivery_time','postcode','houseNumber','street','city'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = '';
  });

  ['pickupPayment','deliveryPayment','chopstickCount','soyCount','gemberCount','wasabiCount'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = el.options[0].value;
  });

  document.getElementById('remark').value = '';

  // ✅ 清空打折类型和金额
  document.getElementById('discountType').value = 'amount';
  document.getElementById('discountValue').value = '';

  document.querySelectorAll('.product-list select').forEach(sel => { sel.selectedIndex = 0; });

  for (const k in cart) delete cart[k];
  updateCart();
  toggleAddress();
  const nameInput = document.getElementById('custName');
  if (nameInput) nameInput.focus();
}


function generateOrderNumber() {
  const now = new Date();
  const date = now.toISOString().slice(0,10).replace(/-/g, '');
  let rand = Math.random().toString(36).substring(2, 6).toUpperCase();

  // 判断是否 Z.S.M.
  const delivery = document.getElementById('typeDelivery').checked;
  const tijdslot = delivery ? document.getElementById('delivery_time').value
                            : document.getElementById('pickup_time').value;
  const raw = String(tijdslot || '').toLowerCase().replace(/\./g, '').trim();
  const isZsm = !raw || raw === 'zsm' || raw === 'asap';

  // 如果是 ZSM，最后一个字母设为 Z，否则避免以 Z 结尾
  if (isZsm) {
    rand = rand.slice(0, 3) + 'Z';
  } else if (rand.endsWith('Z')) {
    rand = rand.slice(0, 3) + 'X';
  }

  return `NV${date}-${rand}`;
}


function submitOrder() {
  const name = document.getElementById('custName').value.trim() || 'Guest';
  const phone = document.getElementById('custPhone').value.trim();

  const delivery = document.getElementById('typeDelivery').checked;



  if (Object.keys(cart).length === 0) {
    alert('Geen producten geselecteerd.');
    return;
  }

  const remark = document.getElementById('remark').value.trim();

  let orderText = Object.entries(cart).map(([name, item]) => {
    let line = `${name} x ${item.qty} (€${(item.qty * item.price).toFixed(2)})`;
    if(item.prefs){
      const pref = item.prefs.map((p,i)=>`${i+1}. ${p}`).join(' | ');
      line += ` [${pref}]`;
    }
    return line;
  }).join(', ');
  Object.keys(extras).forEach(id => {
    const qty = parseInt(document.getElementById(id).value || 0);
    if (qty > 0) orderText += `, ${extras[id].label} x ${qty}`;
  });
  if (remark) orderText += `, Opmerking: ${remark}`;

  const itemsToSend = { ...cart };
  Object.keys(extras).forEach(id => {
    const qty = parseInt(document.getElementById(id).value || 0);
    if (qty > 0) itemsToSend[extras[id].label] = { price: 0, qty };
  });

  const orderNumber = generateOrderNumber();

  // ✅ 获取结账明细数据
  const subtotal = Object.values(cart).reduce((sum, item) => sum + item.price * item.qty, 0);
  const packagingTotal = Object.values(cart).reduce((sum, item) => sum + (item.packaging || 0) * item.qty, 0);
  const deliveryCost = delivery ? 2.5 : 0;
  const discountType = document.getElementById('discountType').value;
  const discountVal = parseFloat(document.getElementById('discountValue').value) || 0;
  let discount = 0;
  if (discountType === 'amount') {
    discount = Math.min(discountVal, subtotal);
  } else if (discountType === 'percent') {
    discount = Math.min(100, discountVal) / 100 * subtotal;
  }
  const totalBeforeBtw = subtotal + packagingTotal + deliveryCost - discount;
  const btwBase = delivery ? totalBeforeBtw - deliveryCost : totalBeforeBtw;
  const btw = btwBase * 0.09;
  const total = totalBeforeBtw;

  const summary = {
    subtotal: parseFloat(subtotal.toFixed(2)),
    packaging: parseFloat(packagingTotal.toFixed(2)),
    delivery: parseFloat(deliveryCost.toFixed(2)),
    discountType,
    discountValue: parseFloat(discountVal.toFixed(2)),
    discountAmount: parseFloat(discount.toFixed(2)),
    btw: parseFloat(btw.toFixed(2)),
    total: parseFloat(total.toFixed(2))
  };

  const orderType = delivery ? 'bezorgen' : 'afhalen';
  const pickupSel = document.getElementById('pickup_time').value;
  const deliverySel = document.getElementById('delivery_time').value;
  const pickupVal = pickupSel === 'Z.S.M.' ? getAsapTime() : pickupSel;
  const deliveryVal = deliverySel === 'Z.S.M.' ? getAsapTime() : deliverySel;
  const tijdslotDisplay = delivery ? deliverySel : pickupSel;
  const payload = {
    orderType,
    name,
    phone,
    email: '',
    customerEmail: '',
    pickup_time: !delivery ? pickupVal : '',
    delivery_time: delivery ? deliveryVal : '',
    tijdslot_display: tijdslotDisplay,
    paymentMethod: delivery
      ? document.getElementById('deliveryPayment').value
      : document.getElementById('pickupPayment').value,
    postcode: delivery ? document.getElementById('postcode').value.trim() : '',
    house_number: delivery ? document.getElementById('houseNumber').value.trim() : '',
    street: delivery ? document.getElementById('street').value.trim() : '',
    city: delivery ? document.getElementById('city').value.trim() : '',
    order_number: orderNumber,
    items: itemsToSend,
    message: orderText,
    opmerking: remark,
    totaal: total.toFixed(2),

    summary  // ✅ 加入结账明细
  };

  // ✅ 提交到后端
  fetch('https://flask-order-api.onrender.com/submit_order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(res => {
      if (res.success || res.status === 'ok') {
        showToast('Bestelling succesvol verzonden! Bestelnummer: ' + orderNumber);
        clearForm();
        fetchOrders();
      } else {
        showToast('Er is een fout opgetreden bij het verzenden van uw bestelling. Probeer het opnieuw.');
      }
    })
    .catch(() => showToast('Verzendfout – server niet bereikbaar.'));
}




  // ✅ 提交到远程 Flask Render 后端

  function pad(num){
    return num.toString().padStart(2,'0');
  }

  function getAsapTime(){
    const d=new Date();
    d.setMinutes(d.getMinutes()+30);
    return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function populateTimeOptions(selectId,offsetMinutes){
    const select=document.getElementById(selectId);
    if(!select) return;
    select.innerHTML='';
    const asap=document.createElement('option');
    asap.value='Z.S.M.';
    asap.textContent='Z.S.M.';
    select.appendChild(asap);
    const now=new Date();
    now.setMinutes(now.getMinutes()+offsetMinutes);

    const open=new Date();
    open.setHours(12,0,0,0);
    const close=new Date();
    close.setHours(23,59,0,0);

    let start=now>open?now:open;
    start=new Date(start);
    start.setMinutes(Math.ceil(start.getMinutes()/15)*15,0,0);

    for(let t=start;t<=close;t.setMinutes(t.getMinutes()+15)){
      const hh=pad(t.getHours());
      const mm=pad(t.getMinutes());
      const timeStr=`${hh}:${mm}`;
      const opt=document.createElement('option');
      opt.value=timeStr;
      opt.textContent=timeStr;
      select.appendChild(opt);
    }
  }


</script>

<script>
function formatCurrency(value){
  if (typeof value === 'string') {
    value = value.replace('€', '').replace(',', '.').trim();
  }
  const num = parseFloat(value);
  return isNaN(num) ? "€0.00" : `€${num.toFixed(2)}`;
}
</script>

  
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socketUrl = (typeof process !== 'undefined' && process.env && process.env.SOCKET_URL) ? process.env.SOCKET_URL : 'https://flask-order-api.onrender.com';
  const socket = io(socketUrl, { transports: ['websocket'] });

  function applyMenuPrices(items){
    const map={};
    items.forEach(i=>{map[i.name]=i.price;});
    document.querySelectorAll('.menu-item').forEach(el=>{
      const name=el.dataset.name;
      if(name&&map[name]!==undefined){
        const p=parseFloat(map[name]);
        el.dataset.price=p;
        const pe=el.querySelector('p');
        if(pe) pe.textContent=`€${p.toFixed(2)}`;
      }
    });
  }

  function populateBubbleSelectors(){
    const baseSel=document.getElementById('bubbleType');
    const flavorSel=document.getElementById('bubbleFlavor');
    const toppingSel=document.getElementById('bubbleTopping');
    const curBase=baseSel.value,curFlavor=flavorSel.value,curTopping=toppingSel.value;
    baseSel.innerHTML='<option value="">Base</option>';
    bubbleOptions.base.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curBase) opt.selected=true;baseSel.appendChild(opt);});
    flavorSel.innerHTML='<option value="">Smaak</option>';
    bubbleOptions.smaak.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curFlavor) opt.selected=true;flavorSel.appendChild(opt);});
    toppingSel.innerHTML='<option value="">Topping</option>';
    bubbleOptions.topping.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curTopping) opt.selected=true;toppingSel.appendChild(opt);});
  }

  function populateXbentoSelectors(){
    const mainSel=document.getElementById('xBentoMain');
    const sideSel=document.getElementById('xBentoSide');
    const riceSel=document.getElementById('xBentoRice');
    const vegSel=document.getElementById('xBentoVeg');
    const curMain=mainSel.value,curSide=sideSel.value,curRice=riceSel.value,curVeg=vegSel.value;
    mainSel.innerHTML='<option value="">Hoofdgerecht</option>';
    xbentoOptions.main.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curMain) opt.selected=true;mainSel.appendChild(opt);});
    sideSel.innerHTML='<option value="">Bijgerecht</option>';
    xbentoOptions.side.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curSide) opt.selected=true;sideSel.appendChild(opt);});
    riceSel.innerHTML='<option value="">Rijstsoort</option>';
    xbentoOptions.rice.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curRice) opt.selected=true;riceSel.appendChild(opt);});
    vegSel.innerHTML='<option value="">Groente</option>';
    xbentoOptions.groente.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curVeg) opt.selected=true;vegSel.appendChild(opt);});
  }

  function updateBubbleCartPrices(){
    Object.entries(cart).forEach(([name,item])=>{
      const m=name.match(/^Bubble Tea \(([^,]+), ([^,]+), ([^)]+)\)$/);
      if(!m) return;
      const price=getOptionPrice('base',m[1])+getOptionPrice('smaak',m[2])+getOptionPrice('topping',m[3]);
      item.price=price;
    });
    updateCart();
  }

  function updateXbentoCartPrices(){
    Object.entries(cart).forEach(([name,item])=>{
      const m=name.match(/^Xbento \(([^,]+), ([^,]+), ([^,]+), ([^)]+)\)$/);
      if(!m) return;
      const price=getXbentoOptionPrice('main',m[1])+getXbentoOptionPrice('side',m[2])+getXbentoOptionPrice('rice',m[3])+getXbentoOptionPrice('groente',m[4]);
      item.price=price;
    });
    updateCart();
  }

  function fetchBubbleOptions(){
    fetch('/api/bubble_options').then(r=>r.json()).then(data=>{
      bubbleOptions=data;
      populateBubbleSelectors();
      updateMilkTeaDisplay();
      updateBubbleCartPrices();
    });
  }

  function fetchXbentoOptions(){
    fetch('/api/xbento_options').then(r=>r.json()).then(data=>{
      xbentoOptions=data;
      populateXbentoSelectors();
      updateXbentoDisplay();
      updateXbentoCartPrices();
    });
  }
  async function loadMenu(){
    const r=await fetch('/api/menu');
    if(r.ok){ const d=await r.json(); applyMenuPrices(d); }
  }
  loadMenu();
  fetch('/api/settings').then(r=>r.json()).then(s=>{
    if(s.milktea_price){ milkTeaPrice=parseFloat(s.milktea_price); updateMilkTeaDisplay(); }
    applyCrispyPrices(s);
  });
  fetchBubbleOptions();
  fetchXbentoOptions();
  socket.on('menu_update', applyMenuPrices);
  socket.on('milktea_price_update', data => {
    milkTeaPrice = parseFloat(data.price || data);
    updateMilkTeaDisplay();
  });
  socket.on('bubble_options_update', data => {
    bubbleOptions=data;
    populateBubbleSelectors();
    updateMilkTeaDisplay();
    updateBubbleCartPrices();
  });
  socket.on('xbento_options_update', data => {
    xbentoOptions=data;
    populateXbentoSelectors();
    updateXbentoDisplay();
    updateXbentoCartPrices();
  });
  socket.on('crispy_price_update', data => {
    applyCrispyPrices(data);
  });

  let pollTimer;
  const baseTitle = document.title;
  let newOrderCount = 0; // unseen orders for title
  let hasNewOrder = false;
  function updateTabTitle(){
    document.title = newOrderCount ? `${baseTitle} (${newOrderCount})` : baseTitle;
  }
  function getOrderCount(){
    const tbody = document.querySelector('.orders-panel tbody');
    return tbody ? tbody.children.length : 0;
  }
  function updateTodayBadge(){
    fetch('/pos/orders_today?json=1')
      .then(r => r.json())
      .then(data => {
        const count = Array.isArray(data) ? data.length : getOrderCount();
        document.querySelectorAll('.today-badge').forEach(badge => {
          badge.textContent = hasNewOrder ? 'New' : count;
        });
      })
      .catch(() => {
        const count = getOrderCount();
        document.querySelectorAll('.today-badge').forEach(badge => {
          badge.textContent = hasNewOrder ? 'New' : count;
        });
      });
  }

  
  function parseTimeToMinutes(str){
    if(!str) return Infinity;
    const parts = str.split(':');
    const h = parseInt(parts[0],10);
    const m = parseInt(parts[1],10);
    if(isNaN(h) || isNaN(m)) return Infinity;
    return h*60+m;
  }

  function getSortKey(order){
    const isDelivery = ['delivery','bezorgen'].includes(order.order_type);
    const t = isDelivery ? (order.delivery_time || order.deliveryTime)
                         : (order.pickup_time || order.pickupTime);
    return parseTimeToMinutes(t);
  }

  function insertSorted(tbody, tr){
    const val = parseFloat(tr.dataset.sortKey);
    const rows = Array.from(tbody.querySelectorAll('tr'));
    for(const row of rows){
      if(parseFloat(row.dataset.sortKey) > val){
        tbody.insertBefore(tr, row);
        return;
      }
    }
    tbody.appendChild(tr);
  }





function orderComplete(btn) {
  const row = btn.closest('.order-card');
  const status = row ? row.querySelector('.notify') : null;
  const orderType = btn.dataset.type;

  const orderData = row ? JSON.parse(row.dataset.order || '{}') : {};

  const payload = {
    order_number: orderData.order_number || btn.dataset.number,
    name: orderData.customer_name || btn.dataset.name,
    phone: orderData.phone || btn.dataset.phone,
    email: orderData.email || btn.dataset.email,
    order_type: orderType,
    tijdslot: orderData.tijdslot || orderData.delivery_time || orderData.pickup_time || '',
    street: orderData.street || '',
    house_number: orderData.house_number || '',
    postcode: orderData.postcode || '',
    city: orderData.city || '',
    opmerking: orderData.opmerking || '',
    totaal: orderData.totaal || orderData.total || '',
    payment_method: orderData.payment_method || '',
    created_at: orderData.created_at || ''
  };

  // 👇 如果是配送订单，弹出配送员选择菜单
  if (orderType === 'bezorg' && deliveryPersons.length > 0) {
  openDeliveryModal(btn);
  return; // 等待确认回调后再 fetch
}


  fetch('https://flask-order-api.onrender.com/api/order_complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(r => {
    if(status) status.textContent = r.ok ? 'Notificatie verzonden' : 'Notificatie mislukt';
  }).catch(() => {
    if(status) status.textContent = 'Notificatie mislukt';
  });
}

function toggleComplete(btn) {
  const wrapper = btn.closest('.order-card-wrapper');
  const row = wrapper ? wrapper.querySelector('.order-card') : null;
  if (!row) return;

  const id = btn.dataset.id || row.dataset.id;
  const done = !row.classList.contains('completed');

  fetch(`/api/orders/${id}/status`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ is_completed: done })
  }).then(r => r.json()).then(() => {
    if (done) orderComplete(btn);
    row.classList.toggle('completed', done);
    const notify = wrapper.querySelector('.notify');
    if (notify) notify.textContent = done ? 'Voltooid' : '';
  });
}

let deliveryPersons = [];

fetch('/static/delivery_persons.json')
  .then(res => res.json())
  .then(data => {
    deliveryPersons = data;
  });

let currentDeliveryBtn = null;

function openDeliveryModal(btn) {
  currentDeliveryBtn = btn;
  const select = document.getElementById('deliverySelect');
  select.innerHTML = '';

  deliveryPersons.forEach(p => {
    const option = document.createElement('option');
    option.value = p.chat_id;
    option.textContent = p.name;
    select.appendChild(option);
  });

  const modal = document.getElementById('deliveryModal');
  if (typeof modal.showModal === 'function') {
    modal.showModal();
  } else {
    modal.setAttribute('open', '');
  }
}

function closeDeliveryModal() {
  const modal = document.getElementById('deliveryModal');
  if (typeof modal.close === 'function') {
    modal.close();
  } else {
    modal.removeAttribute('open');
    modal.style.display = 'none';
  }
  currentDeliveryBtn = null;
}

function confirmDeliveryPerson() {
  const select = document.getElementById('deliverySelect');
  const chatId = select.value;
  const person = deliveryPersons.find(p => p.chat_id == chatId);
  if (!person || !currentDeliveryBtn) return;

  const btn = currentDeliveryBtn;
  const row = btn.closest('.order-card');
  const status = row ? row.querySelector('.notify') : null;

  const orderData = row ? JSON.parse(row.dataset.order || '{}') : {};

  const payload = {
    order_number: orderData.order_number || btn.dataset.number,
    name: orderData.customer_name || btn.dataset.name,
    phone: orderData.phone || btn.dataset.phone,
    email: orderData.email || btn.dataset.email,
    order_type: btn.dataset.type,
    tijdslot: orderData.tijdslot || orderData.delivery_time || orderData.pickup_time || '',
    street: orderData.street || '',
    house_number: orderData.house_number || '',
    postcode: orderData.postcode || '',
    city: orderData.city || '',
    opmerking: orderData.opmerking || '',
    totaal: orderData.totaal || orderData.total || '',
    payment_method: orderData.payment_method || '',
    created_at: orderData.created_at || '',
    delivery_person: person.name,
    delivery_chat_id: person.chat_id
  };

  fetch('https://flask-order-api.onrender.com/api/order_complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(r => {
    if (status) status.textContent = r.ok ? 'Notificatie verzonden' : 'Notificatie mislukt';
  }).catch(() => {
    if (status) status.textContent = 'Notificatie mislukt';
  });

  closeDeliveryModal();
}

document.getElementById('confirmDelivery').addEventListener('click', confirmDeliveryPerson);





function orderCancelNotify(btn) {
  const row = btn.closest('.order-card') || btn.closest('tr');
  const status = row ? row.querySelector('.notify') : null;
  const payload = {
    order_number: btn.dataset.number,
    name: btn.dataset.name,
    phone: btn.dataset.phone,
    email: btn.dataset.email,
    order_type: btn.dataset.type
  };

  fetch('https://flask-order-api.onrender.com/api/order_cancelled', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(r => {
    if (status) status.textContent = r.ok ? '' : '';
  }).catch(() => {
    if (status) status.textContent = '';
  });
}
function toggleCancel(btn) {
  const wrapper = btn.closest('.order-card-wrapper');
  const row = wrapper ? wrapper.querySelector('.order-card') : null;
  if (!row) return;

  const id = btn.dataset.id || row.dataset.id;
  const cancelled = !row.classList.contains('cancelled');

  fetch(`/api/orders/${id}/status`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ is_cancelled: cancelled })
  }).then(r => r.json()).then(() => {
    if (cancelled) orderCancelNotify(btn);
    row.classList.toggle('cancelled', cancelled);
    const notify = wrapper.querySelector('.notify');
    if (notify) notify.textContent = cancelled ? 'Geannuleerd' : '';
  });
}

function fetchOrders() {
  fetch('/pos/orders_today?json=1')
    .then(r => r.json())
    .then(data => {
      const container = document.querySelector('.orders-cards');
      if (!container) return;
      container.innerHTML = '';
      data.sort((a, b) => getSortKey(a) - getSortKey(b)).forEach(order => addRow(order));
    })
    .catch(err => {
      console.error("订单拉取失败", err);
    });
}


function parseItemsString(str, existing) {
  const result = {};
  if (!str) return result;
  str.split(',').forEach(part => {
    const [name, qty] = part.split('=').map(s => s.trim());
    const q = parseInt(qty, 10);
    if (name && q > 0) {
      const price = existing && existing[name] ? existing[name].price : 0;
      result[name] = { qty: q, price };
    }
  });
  return result;
}

function editOrder(btn) {
  const row = btn.closest('tr') || btn.closest('.order-card');
  if(!row) return;
  const id = btn.dataset.id || row.dataset.id;
  const data = JSON.parse(row.dataset.order || '{}');

  const name = prompt('Naam', data.customer_name || '');
  if (name === null) return;
  const phone = prompt('Telefoon', data.phone || '');
  if (phone === null) return;
  const email = prompt('Email', data.email || '');
  if (email === null) return;
  const street = prompt('Straat', data.street || '');
  if (street === null) return;
  const number = prompt('Huisnummer', data.house_number || '');
  if (number === null) return;
  const postcode = prompt('Postcode', data.postcode || '');
  if (postcode === null) return;
  const city = prompt('Plaats', data.city || '');
  if (city === null) return;
  const pickup = prompt('Afhaaltijd', data.pickup_time || '');
  if (pickup === null) return;
  const delivery = prompt('Bezorgtijd', data.delivery_time || '');
  if (delivery === null) return;

  const itemsStr = Object.entries(data.items || {}).map(([n,i])=>`${n}=${i.qty}`).join(', ');
  const newItemsInput = prompt('Items (naam=qty, gescheiden door komma)', itemsStr);
  if (newItemsInput === null) return;

  const payment = prompt('Betaalwijze', data.payment_method || '');
  if (payment === null) return;

  const totaal = prompt('Totaal', data.totaal != null ? data.totaal : '');
  if (totaal === null) return;

  const fooi = prompt('Fooi', data.fooi != null ? data.fooi : (data.tip || '0'));
  if (fooi === null) return;

  fetch(`/api/orders/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      customer_name: name, phone, email,
      street, house_number: number, postcode, city,
      pickup_time: pickup, delivery_time: delivery,
      items: parseItemsString(newItemsInput, data.items || {}),
      payment_method: payment,
      totaal: parseFloat(totaal) || 0,
      fooi: parseFloat(fooi) || 0
    })
  }).then(() => fetchOrders());
}

function addRow(order, highlight = false) {
  const container = document.querySelector('.orders-cards');
  if (!container) return;

  const isDelivery = ['delivery', 'bezorgen'].includes(order.order_type);

  const items = Object.entries(order.items || {})
    .sort(([, a], [, b]) => {
      const priceA = a.price || 0;
      const priceB = b.price || 0;
      if (priceA === 0 && priceB !== 0) return 1;
      if (priceA !== 0 && priceB === 0) return -1;
      const nameA = (a.displayName || a.name || '').toUpperCase();
      const nameB = (b.displayName || b.name || '').toUpperCase();
      return nameA.localeCompare(nameB);
    })
    .map(([n, i]) => {
      const isFree = (i.price || 0) === 0;
      const displayNameRaw = i.displayName || i.name || n;
      const displayName = isFree ? displayNameRaw.toLowerCase() : displayNameRaw.toUpperCase();
      const rowTotal = (i.qty * (i.price || 0)).toFixed(2).replace('.', ',');
      return `<li>${i.qty} x ${displayName} = €${rowTotal}</li>`;
    }).join('');

  let subtotal = 0;
  let verpakkingskosten = 0;
  Object.values(order.items || {}).forEach(i => {
    subtotal += (i.price || 0) * i.qty;
    verpakkingskosten += (i.packaging || 0) * i.qty;
  });

  const verpakkingDisplay = verpakkingskosten.toFixed(2).replace('.', ',');
  const bezorgkosten = parseFloat(order.bezorgkosten || order.delivery_cost || 0) || 0;
  const bezorgDisplay = bezorgkosten.toFixed(2).replace('.', ',');
  let fooi = parseFloat(order.fooi || order.tip || 0); if (isNaN(fooi)) fooi = 0;
  const fooiDisplay = fooi.toFixed(2).replace('.', ',');

  let totaal = parseFloat(order.totaal || order.total || 0);
  if (isNaN(totaal)) totaal = 0;
  const totaalDisplay = totaal.toFixed(2).replace('.', ',');

  const theoretischTotaal = subtotal + verpakkingskosten + bezorgkosten + fooi;
  let korting = theoretischTotaal - totaal;
  const showKorting = korting >= 0.01;
  const kortingDisplay = korting.toFixed(2).replace('.', ',');

  const address = isDelivery
    ? `${order.street || ''} ${order.house_number || ''}, ${order.postcode || ''} ${order.city || ''}`.trim()
    : '-';

  const tijdslotRaw = order.tijdslot_display || (isDelivery ? order.delivery_time : order.pickup_time);
  const tijdslot = order.is_zsm ? 'ZSM' : (tijdslotRaw || '').trim();
  const wrapper = document.createElement('div');
  wrapper.className = 'order-card-wrapper';

  const card = document.createElement('div');
  card.className = 'order-card';
  if (order.id) card.dataset.id = order.id;
  card.dataset.order = JSON.stringify(order);
  if (order.is_cancelled) card.classList.add('cancelled');
  else if (order.is_completed) card.classList.add('completed');
  if (highlight) {
    card.classList.add('new-order');
    setTimeout(() => card.classList.remove('new-order'), 10000);
  }

  card.innerHTML = `
    <div><strong>Ordernummer:</strong> ${order.order_number || ''}</div>
    <div class="tijdslot-hoofd">
      <div>
        <strong class="${isDelivery ? 'type-bezorging' : 'type-afhalen'}">
          ${isDelivery ? 'Bezorging' : 'Afhalen'}
        </strong>
        <span class="tijdslot" style="color: #e67e22; font-weight: bold; text-transform: uppercase;">
          ${tijdslot}
        </span>
        &nbsp;&nbsp;<span class="created-at" style="color: #888;">Besteld om: ${order.created_at || '-'}</span>
      </div>
    </div>
    <div><strong>Naam:</strong> ${order.customer_name || ''}</div>
    <div><strong>Telefoon:</strong> ${order.phone || ''}</div>
    ${order.email ? `<div><strong>Email:</strong> <a href="mailto:${order.email}">${order.email}</a></div>` : ''}
    <div><strong>Items:</strong><ul>${items}</ul></div>
    ${order.opmerking ? `<div><strong>Opmerking:</strong> ${order.opmerking}</div>` : ''}
    ${verpakkingskosten > 0 ? `<div><strong>Verpakkingskosten:</strong> €${verpakkingDisplay}</div>` : ''}
    ${bezorgkosten > 0 ? `<div><strong>Bezorgkosten:</strong> €${bezorgDisplay}</div>` : ''}
    ${showKorting ? `<div><strong>Korting:</strong> -€${kortingDisplay}</div>` : ''}
    <div><strong>Totaal:</strong> €${totaalDisplay}</div>
    ${fooi > 0 ? `<div><strong>Fooi:</strong> €${fooiDisplay}</div>` : ''}
    ${address !== '-' ? `<div><strong>Adres:</strong> ${address}
      <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}" target="_blank" style="margin-left:6px;">📍Maps</a>
    </div>` : ''}
    ${order.payment_method ? `<div><strong>Betaalwijze:</strong> ${order.payment_method}</div>` : ''}
  `;

  const actions = document.createElement('div');
  actions.className = 'card-actions';
  actions.innerHTML = `
    <button class="btn-klaar" onclick="toggleComplete(this)"
      data-number="${order.order_number}"
      data-name="${order.customer_name || ''}"
      data-phone="${order.phone || ''}"
      data-email="${order.email || ''}"
      data-type="${isDelivery ? 'bezorg' : 'afhaal'}">
      Klaar
    </button>
    <button class="btn-print" onclick="printThisOrder(this)" data-order='${JSON.stringify(order)}'>🖨️ Print</button>

    <button class="btn-annuleer" onclick="toggleCancel(this)"
      data-number="${order.order_number}"
      data-name="${order.customer_name || ''}"
      data-phone="${order.phone || ''}"
      data-email="${order.email || ''}"
      data-type="${isDelivery ? 'bezorg' : 'afhaal'}"
      data-id="${order.id}">
      Annuleer
    </button>
    <span class="notify"></span>
  `;

  wrapper.appendChild(card);
  wrapper.appendChild(actions);
  container.appendChild(wrapper);
}



const orderQueue = [];
let isModalActive = false;
let currentOrder = null;

socket.on('new_order', order => {
  console.log('🆕 Nieuwe bestelling ontvangen!', order);
  console.log("📦 实际推送内容:", order);
  // 检查 order 是否有编号
  if (!order || !order.order_number) {
    console.warn("❌ 接收到的订单无有效 order_number:", order);
  }

  // 播声音
  if (window.electronAPI?.playDing) {
    window.electronAPI.playDing();
  }

  // 尝试添加订单卡片
  try {
    const row = addRow(order, true);
    console.log("✅ 卡片添加成功", row);
  } catch (err) {
    console.error("❌ addRow 失败", err);
  }

  // 加入队列
  orderQueue.push(order);
  console.log("📥 已加入 orderQueue，当前队列长度:", orderQueue.length);

  // 显示弹窗
  if (!isModalActive) {
    console.log("📢 弹出订单提示框");
    showNextOrderModal();
  } else {
    console.log("⏳ 弹窗已激活，等待当前处理完成...");
  }
});


function showNextOrderModal() {
  if (orderQueue.length === 0) {
    console.log("📭 队列为空，不弹出弹窗");
    return;
  }

  currentOrder = orderQueue.shift();
  isModalActive = true;
  console.log("📦 显示弹窗订单:", currentOrder.order_number);

  // 填充订单信息
  document.getElementById('modal-order-id').textContent = currentOrder.order_number || '-';
  document.getElementById('modal-customer-name').textContent = currentOrder.customer_name || '-';
  document.getElementById('modal-address').textContent = currentOrder.street
    ? `${currentOrder.street} ${currentOrder.house_number} ${currentOrder.postcode} ${currentOrder.city}`
    : '-';
  document.getElementById('modal-items').innerHTML = Object.entries(currentOrder.items || {})
    .map(([name, i]) => `${name} x ${i.qty}`).join('<br>');
  document.getElementById('modal-remark').textContent = currentOrder.opmerking || '-';
  document.getElementById('modal-total').textContent = formatCurrency(currentOrder.totaal || currentOrder.total || 0);

  // ✅ 时间字段处理（优先显示 tijdslot，如果是 ZSM 则保持为 "Z.S.M."）
  const timeInput = document.getElementById('modal-time');
  timeInput.style.display = 'inline-block';

  let tijdslotRaw = currentOrder.tijdslot || '';
  if (tijdslotRaw.toLowerCase().includes('z')) {
    tijdslotRaw = 'Z.S.M.';
  } else if (!tijdslotRaw && currentOrder.pickup_time) {
    tijdslotRaw = currentOrder.pickup_time;
  } else if (!tijdslotRaw && currentOrder.delivery_time) {
    tijdslotRaw = currentOrder.delivery_time;
  }
  timeInput.value = tijdslotRaw;

  // ✅ 正确调用盖章逻辑（不提前显示）
  updateZSMBadge(currentOrder);

  // 显示弹窗
  document.getElementById('order-modal').style.display = 'flex';
  console.log("✅ 弹窗已显示！");
}

document.getElementById('modal-confirm').addEventListener('click', () => {
  console.log("✅ 用户点击了 Bevestigen");

  // 打印当前订单
  if (window.electronAPI?.printOrder && currentOrder) {
    window.electronAPI.printOrder(currentOrder);
  } else {
    console.warn("⚠️ electronAPI.printOrder 未定义或 currentOrder 为空");
  }

  // 关闭弹窗
  document.getElementById('order-modal').style.display = 'none';
  isModalActive = false;

  // 继续处理队列中下一个订单
  showNextOrderModal();
});

function printThisOrder(button) {
  const raw = button.getAttribute('data-order');
  let order;
  try {
    order = JSON.parse(raw);
  } catch (e) {
    console.error("❌ 无法解析订单 JSON:", e);
    return;
  }

  if (window.electronAPI?.printOrder && order) {
    window.electronAPI.printOrder(order);
    console.log("🖨️ 打印了订单:", order.order_number);
  } else {
    console.warn("⚠️ electronAPI.printOrder 不可用 或 order 无效");
  }
}


function updateZSMBadge(order) {
  const zsmDisplay = document.getElementById('Z.S.M.-display');

  if (!zsmDisplay) return;

  const endsWithZ = (order.order_number || '').endsWith('Z');

  if (endsWithZ) {
    zsmDisplay.style.display = 'inline-block';
    zsmDisplay.textContent = 'Z.S.M.';
  } else if (order.tijdslot) {
    zsmDisplay.style.display = 'inline-block';
    zsmDisplay.textContent = `Tijdslot: ${order.tijdslot}`;
  } else {
    zsmDisplay.style.display = 'none';
  }
}






document.getElementById('modal-confirm').addEventListener('click', async () => {
  const tijdslotOrigineel = currentOrder.pickup_time || currentOrder.delivery_time || '';
  const gekozenTijd = document.getElementById('modal-time').value || tijdslotOrigineel;

  if (window.electronAPI && window.electronAPI.stopDing) {
  window.electronAPI.stopDing(); // ✅ 不加 await
}


  // ⏱️ 时间未更改，跳过发送邮件
  if (gekozenTijd === tijdslotOrigineel) {
    console.log("⏳ 时间未更改，无需发送邮件。");
  } else {
    try {
      const response = await fetch('https://flask-order-api.onrender.com/api/order_time_changed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          order_number: currentOrder.order_number,
          name: currentOrder.customer_name,
          email: currentOrder.email,
          order_type: currentOrder.order_type,
          tijdslot: gekozenTijd
        })
      });

      if (!response.ok) {
        throw new Error(`服务器返回错误: ${response.status}`);
      }

      const msg = await response.text();
      console.log("📧 邮件响应:", msg);
    } catch (err) {
      console.warn("❌ 邮件发送失败", err);
    }
  }

  // ✅ 打印（可选是否放前面）
  // printOrder(currentOrder, gekozenTijd);

  // ✅ 关闭弹窗并处理下一个订单
  document.getElementById('order-modal').style.display = 'none';
  isModalActive = false;
  currentOrder = null;
  showNextOrderModal();
});


  // 断线后启用轮询
  socket.on('disconnect', () => {
    console.warn('⚠️ Socket verbroken – schakel over op polling');
    startPolling();
  });

  socket.on('connect', () => {
    console.log('✅ Socket verbonden');
    stopPolling();
  });

  socket.on('connect_error', () => {
    setTimeout(() => socket.connect(), 1000);
  });

  // 轮询作为备份
  


  function startPolling() {
    if (pollTimer) return;
    fetchOrders();
    pollTimer = setInterval(fetchOrders, 10000); // 每10秒
  }

  function stopPolling() {
    if (pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  }

  function showToast(msg) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = msg;
    document.body.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('visible'));
    setTimeout(() => {
      toast.classList.remove('visible');
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  const xbowlModal=document.getElementById('xBowlAddedModal');
  const againBtn=document.getElementById('xBowlAgain');
  const closeXBowlBtn=document.getElementById('xBowlClose');
  function showXBowlModal(){ if(xbowlModal) xbowlModal.style.display='flex'; }
  function hideXBowlModal(){ if(xbowlModal) xbowlModal.style.display='none'; }
  if(againBtn){ againBtn.addEventListener('click',()=>{ clearXBowlSet(); hideXBowlModal(); }); }
  if(closeXBowlBtn){ closeXBowlBtn.addEventListener('click', hideXBowlModal); }

  window.addEventListener('beforeunload', () => socket.disconnect());
  window.addEventListener('focus', () => { newOrderCount = 0; hasNewOrder = false; updateTabTitle(); updateTodayBadge(); });
</script>



 
  
</body></html>
