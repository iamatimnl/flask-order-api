


<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>POS Interface</title>
<style>
  body {
   
    padding: 20px;
    max-width: 1200px;
    margin: auto;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Helvetica Neue", sans-serif;
    color:  #111111;
    background:  #f2e0bdff;
    padding-top: 60px;
    text-align: center;
  }
  @media (max-width: 480px) {
    body { padding: 10px; }
  }



  .navbar-container::-webkit-scrollbar { display: none; }
  .navbar-container {
    -ms-overflow-style: none;
    scrollbar-width: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    padding: 0;
    margin: 0;
    background: rgba(255,255,255,0.65);
    backdrop-filter: blur(12px);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  
    z-index: 999;
  }
  .navbar {
    display: flex;
    flex-direction: row;
    white-space: nowrap;
    position: relative;
    width: 100vw;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    scroll-behavior: auto;
  }
  .nav-categories { display: flex; white-space: nowrap; }
  @media (min-width: 768px) { .nav-categories { margin: 0 auto; } }
  .navbar a {
    flex: 0 0 auto;
    padding: 14px 20px;
    color: var(--accent-color);
    text-decoration: none;
    font-weight: bold;
    border-radius: 24px;
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
  }
  @media (max-width: 480px) {
    .navbar a { padding: 10px 14px; font-size: 0.9rem; }
    .today-btn { padding: 8px 14px; }
  }
  .navbar a.active { color: white; }
 .today-btn {
  background: linear-gradient(to bottom, #d0f0e8, #a3e4ce);
  color: #1f2e2d;
  font-weight: 600;
  padding: 10px 18px;
  border: none;
  border-radius: 14px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.12),
              inset 0 1px 0 rgba(255, 255, 255, 0.4);
  backdrop-filter: blur(6px);
  transition: all 0.2s ease-in-out;
  cursor: pointer;
  font-size: 1rem;
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 10000;
}
.today-btn:hover {
  background: linear-gradient(to bottom, #b2eadd, #86dcc3);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
              inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

 
  .navbar::after { content: ""; flex: 0 0 50vw; }
  section {
    padding: 40px 20px;
    box-sizing: border-box;
    border-bottom: 1px solid #ccc;
    border-radius: 16px;
    background: var(--off-white);
    margin-bottom: 20px;
  }
  



  section:nth-child(even) { background: var(--section-alt-bg); }
  h1,h2,h3,h4,h5,h6,p { text-align: center; }
  .menu-item {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    padding: 16px;
    margin-bottom: 12px;
    border-radius: 16px;
    background: var(--off-white);
    border: 1px solid #f1ddb4ff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  img { max-width: 100%; height: auto; }
  .menu-item img { width: 100%; max-width: 120px; height: auto; object-fit: cover; border-radius: 12px; flex-shrink: 0; }
  .menu-item select, .menu-item button {
    margin-top: 8px;
    padding: 6px 8px;
    font-size: 0.85rem;
    height: 36px;
    border-radius: 10px;
    border: 1px solid #fad9a6ff;
  }
  /* Ensure Omakase preference dropdowns keep full width */
  #omakasePrefs select {
    width: 100%;
    max-width: 160px;
  }
  #dragonPrefs select {
    width: 100%;
    max-width: 160px;
  }
  .pokebowl-sauces select {
    width: 100%;
    max-width: 160px;
    margin-top: 4px;
  }
  .menu-item button {
    width: 2.2rem;
    height: 2.2rem;
    font-size: 1rem;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: none;
    background:#e5e5ea;
    color:#333;
    transition: background 0.2s ease;
  }
  .menu-item button:hover { background:#dcdce0; }
  .add-button { background:#b3d4ff; color:#333; }
  .add-button:hover { background:#a3c8ff; }
  .remove-button { background:#ffd6d6; color:#333; }
  .remove-button:hover { background:#ffc2c2; }
  .xbowl-summary{background:rgba(255,255,255,0.7);backdrop-filter:blur(6px);border-radius:8px;padding:4px 8px;margin:2px 0;font-size:0.8rem;}
  @media (max-width: 600px) {
    .menu-item button { width:1.8rem; height:1.8rem; font-size:0.9rem; }
    .menu-item img { max-width:80px; }
  }
  @media (max-width: 600px) { .menu-item { flex-direction: column; align-items: flex-start; } }
@media (max-width: 767px) {
  .menu-item[data-name="X-Bowl"] { aspect-ratio: auto; height: auto; }
  .menu-item[data-name="X-Bowl"] .menu-content { position: static; }
  .menu-item[data-name="X-Bowl"] img { position: static; width: 100%; height: auto; }
  .menu-item[data-name="X-Bowl"] .qty-box { position: static; transform: none; width: 100%; margin-top: 8px; }
  #xBowlMains, #xBowlToppings {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  #xBowlMains>div, #xBowlToppings>div {
    display: flex;
    align-items: center;
    flex: 0 0 calc(50% - 3px);
  }
  #xBowlMains select, #xBowlToppings select { width: 100%; }
  #xBowlMains button, #xBowlToppings button {
    width: 1.4rem;
    height: 1.4rem;
    font-size: 0.9rem;
  }
}


  .side-tools { width: 180px; }

  .checkout-panel {
  
  top: 80px; /* 与导航栏保持一定距离 */
  align-self: flex-start;
  flex: 1.4;
  max-width: 420px;
  backdrop-filter: blur(8px);
  border-radius: 16px;
  padding: 20px;
  background:#9ca37a; 
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 0, 0, 0.06);
}

 




 .checkout-panel button {
  background: linear-gradient(to bottom, #d8f4e7, #a9e5cd);
  color: #1a2e28;
  font-weight: 600;
  padding: 12px;
  width: 100%;
  font-size: 1.1rem;
  border: none;
  border-radius: 14px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12),
              inset 0 1px 0 rgba(255, 255, 255, 0.4);
  backdrop-filter: blur(6px);
  transition: all 0.2s ease-in-out;
  cursor: pointer;
}
  
  .checkout-panel button:hover {
    background: linear-gradient(to bottom, #b2eadd, #86dcc3);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
              inset 0 1px 0 rgba(255, 255, 255, 0.5);
  }

  .order-type-switch {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  .order-btn input {
    display: none;
  }
  .order-btn span {
    display: block;
    padding: 8px 16px;
    border: 1px solid var(--accent-color);
    border-radius: 8px;
    cursor: pointer;
  }
  .order-btn input:checked + span {
    background: var(--accent-color);
    color: #fff;
  }

  @media (max-width: 600px) {
    .checkout-panel { width:100%; }
  }
  .orders-slide {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #403030;
    backdrop-filter: blur(8px);
    overflow: auto;
    transform: translateX(-100%);
    transition: transform 0.3s;
    z-index: 9999;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  }
  .orders-slide.visible { transform: translateX(0); }
 
  @media (max-width: 768px) {
    .orders-panel table { display:block; overflow-x:auto; white-space:nowrap; }
  }
  .orders-panel th, .orders-panel td { border:1px solid #ddd; padding:8px; text-align:left; }
  .orders-panel th { background:#f2f2f2; }
  .orders-panel ul { margin:0; padding-left:20px; }
  input, select, textarea {
    border:1px solid rgba(255,255,255,0.4);
    border-radius:8px;
    padding:6px 10px;
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(6px);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    transition:border-color 0.2s, box-shadow 0.2s;
  }
  input:hover, select:hover, textarea:hover {
    border-color:#999;
  }
  input:focus, select:focus, textarea:focus {
    outline:none;
    border-color:var(--accent-color);
    box-shadow:0 0 0 2px rgba(63,92,75,0.2);
  }


.orders-header {
  position: sticky;
  top: 0;
  width: 100%;
  background-color: transparent; /* 修正拼写 */
  z-index: 1000;
  display: flex;
  margin-right: 65px;
  justify-content: flex-end;
 
}

#closeToday {
  background: linear-gradient(180deg, #0a84ff, #0066d6);
  color: white;
  border: none;
  height: 32px;
  padding: 0 8px;
  padding: 0 16px;
  font-size: 14px;
  line-height: 32px;
  cursor: pointer;
  margin-right: 12px;
  display: flex;
  margin-left: 0px;
  align-items: center;
  justify-content: center;
  /* 不要给按钮设置 margin-right 等外边距 */
}

#toggle-map-btn {
  background: linear-gradient(180deg, #0a84ff, #0066d6);
  color: white;
  border: none;
  margin-right: 0px;
  padding: 0 16px;
  height: 32px;
  margin-left: 0px;
  font-size: 14px;
  line-height: 33px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  /* 不要给按钮设置 margin-right 等外边距 */
}

#admin-orders-btn {
  background: linear-gradient(180deg, #0a84ff, #0066d6);
  color: white;
  border: none;
  height: 32px;
  padding: 0 16px;
  margin-right: 0px;
  font-size: 14px;
  line-height: 32px;
  margin-left: 0px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  /* 不要给按钮设置 margin-right 等外边距 */
}

/* 你的 navbar 容器 */
.orders-header{
  display:flex;
  align-items:center;
  color: transparent  !important; /* 隐藏文字 */
  margin-right: 0px;
  padding:3px 9px;
}

/* 使用你现有的 .btn-wissel 外观，下面只是补充一点间距与圆角一致性 */
.orders-header > button{
  border-radius:0px;
  line-height:1;
  margin-right:0px;
}

/* 统一补充更顺滑的过渡 */
#closeToday, #toggle-map-btn, #admin-orders-btn{
  transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.08s ease;
}

/* 1) 关闭/退出：悬停红色（微软关闭红系） */
#closeToday:hover{
  background: linear-gradient(180deg, #ff4557, #e81123);
  color:#fff;
}
#closeToday:active{
  background: linear-gradient(180deg, #d50f1f, #b20c18);
  transform: translateY(0.5px);
}

/* 2) 地图按钮：悬停更亮的蓝青，轻微内阴影强调 */
#toggle-map-btn:hover{
  background: linear-gradient(180deg, #1db9ff, #0a84ff);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25);
  color:#fff;
}
#toggle-map-btn:active{
  background: linear-gradient(180deg, #0a84ff, #095ec5);
  transform: translateY(0.5px);
}

/* 3) 订单按钮：悬停加深蓝色层次 */
#admin-orders-btn:hover{
  background: linear-gradient(180deg, #1db9ff, #0a84ff);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.25);
  color:#fff;
}
#admin-orders-btn:active{
  background: linear-gradient(180deg, #0860c0, #0750a3);
  transform: translateY(0.5px);
}

/* 可选：键盘可达性高亮 */
#closeToday:focus-visible,
#toggle-map-btn:focus-visible,
#admin-orders-btn:focus-visible{
  outline: 2px solid #ffffff;
  outline-offset: 2px;
}


#orders-header > button + button:active{
  background: linear-gradient(180deg, #0860c0, #0750a3);
  transform: translateY(0.5px);
}

.orders-panel {
  flex: 1;
  overflow-y: auto;
  padding: 20px 10px 20px;
}







  
  .supply-row {
    display:flex;
    align-items:center;
    gap:10px;
    margin:10px 0;
  }
  img.supply-img {
    width:40px;
    height:40px;
    object-fit:cover;
    border-radius:12px;
  }
  .supply-select {
    min-width:80px;
    padding:6px 10px;
    font-size:0.95rem;
    border-radius:10px;
    border:1px solid #ccc;
    background:white;
    appearance:none;
  }

  .cart-area button {
    width:100%;
    margin-top:10px;
    padding:12px;
    font-size:1.1rem;
    background:#b3d4ff;
    color:#333;
    border:none;
    border-radius:12px;
    transition: background 0.3s ease;
  }
  .cart-area button:hover { background:#a3c8ff; }
  .hidden { display:none; }
.cart-area {
  position: fixed;
  top: 80px;
  right: 480px; /* 420 + 40px 间距，确保不挤 */
  width: 400px; /* 稍微收窄，避免总宽超出页面 */
  max-height: calc(100vh - 100px);
  overflow-y: auto;
  background: linear-gradient(to bottom right, #fdfaf6, #f0e6d7);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 0, 0, 0.06);
  backdrop-filter: blur(8px);
  border-radius: 16px;
  padding: 20px;
  z-index: 1000;
}

.checkout-panel {
  position: fixed;
  top: 80px;
  right: 20px;
  width: 400px;  /* 也稍微收窄，避免太占空间 */
  max-height: calc(100vh - 100px);
  overflow-y: auto;
  backdrop-filter: blur(8px);
  border-radius: 16px;
  padding: 20px;
  background: linear-gradient(to bottom, #fdfaf6, #f0e6d7);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 0, 0, 0.06);
  z-index: 1000;
}

@media (max-width: 768px) {
  .cart-area {
    position: static !important;
    top: auto !important;
    right: auto !important;
    width: 100% !important;
    max-height: none !important;
    overflow: visible !important;
  }

  .checkout-panel {
    position: static !important;
    top: auto !important;
    right: auto !important;
    width: 100% !important;
    max-height: none !important;
    overflow: visible !important;
  }

  .cart-panel {
    display: none; /* 如果还在用可以保留 */
  }

  .cart-toggle { display: block; }
}

  


  .center-area {
    flex: 3;
    margin-right: 60px;
    max-width: 500px; 
  }


/* Floating cart and checkout panel */
  .cart-panel {
    position: sticky;
    top: 80px;
    align-self: flex-start;
    flex: 1.4;
    max-width: 420px;
  }
  .close-btn { display:none; }
  .cart-toggle {
    position: fixed;
    bottom: 20px;
    right: 16px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    background: #fff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    font-size: 1.2rem;
    cursor: pointer;
    z-index: 1100;
    display: none;
  }
  .cart-toggle .badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #ff3b30;
    color: #fff;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 0.75rem;
  }
  .today-toggle {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  font-size: 1.4rem;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
  border: none;
}

.emoji-wrapper {
  position: relative;  /* ✅ 必须有这行 */
  display: inline-block;
}





  #closeCartPanel {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #e5e5ea;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 1.2rem;
    cursor: pointer;
  }
  @media (max-width: 768px) {
    .cart-toggle { display: block; }
  
    .cart-panel {
      position: fixed;
      inset: 0;
      overflow-y: auto;
      background: rgba(255,255,255,0.95);
      padding: 20px;
      z-index: 1050;
      display: none;
    }
    .cart-panel.open { display: block; }
    .close-btn { display: block; }
    .cart-panel .cart-area { position: static; top: auto; }
    .pos-layout { flex-direction: column; align-items: center; }
    .center-area { width:100%; margin-right:0; }
  }

/* 默认隐藏圆按钮 */
.today-toggle {
  display: none;
}
body.today-open {
  overflow: hidden;
}

/* 手机显示圆按钮，隐藏长按钮 */
@media (max-width: 768px) {
  .today-btn { display: none; }
  .today-toggle { display: flex; }
}

/* 🔔 新订单闪烁效果 */
.new-order {
  animation: highlightBlink 1s ease-in-out;
  animation-iteration-count: 10;
}
@keyframes highlightBlink {
  0%,100% { background-color: #eaffea; }
  50% { background-color: #fff; }
}

/* 📋 Hide order buttons when orders panel is open */
body.today-open .today-btn,
body.today-open .today-toggle {
  display: none !important;
}

/* 桌面显示长按钮，确保隐藏圆按钮 */
@media (min-width: 768px) {
  .today-btn { display: block; }
  .today-toggle { display: none; }
}

dialog#deliveryModal {
  border: none;
  border-radius: 20px;
  padding: 20px 24px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  animation: popUp 0.25s ease;
}

dialog::backdrop {
  background: rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(4px);
}

.modal-select {
  width: 100%;
  padding: 10px 14px;
  font-size: 16px;
  margin: 20px 0;
  border-radius: 12px;
  border: 1px solid #ccc;
}

.modal-buttons {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}

.modal-buttons button {
  flex: 1;
  padding: 12px 0;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.modal-buttons button#confirmDelivery {
  background-color: #34c759;
  color: white;
}

.modal-buttons button:last-child {
  background-color: #e5e5ea;
  color: #333;
}

@keyframes popUp {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}




.modal-overlay {
  position: fixed;
  z-index: 9999;
  background: rgba(0,0,0,0.5);
  top: 0; left: 0;
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
}
.modal-box {
  background: #fff;
  padding: 20px 30px;
  border-radius: 8px;
  text-align: center;
}
.modal-select {
  margin: 15px 0;
  padding: 6px 12px;
  font-size: 16px;
}
.modal-buttons button {
  margin: 0 10px;
}
/* ✅ #order-modal */
#order-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  animation: popUp 0.25s ease;
}
#order-modal > div {
  background: #fff;
  border-radius: 20px;
  padding: 24px 28px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
  position: relative;
  animation: popUp 0.25s ease;
}
#order-modal h2 {
  font-size: 20px;
  margin-bottom: 15px;
}
#order-modal p {
  font-size: 16px;
  margin: 6px 0;
}
#modal-time {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;

  text-align: center;
  font-size: 14px;
  font-weight: 500;

  background-color: #f9f9f9;
  color: #333;

  border: 1px solid #ccc;
  border-radius: 16px;

  padding: 4px 8px;
  width: 90px;
  max-width: 100%;
  box-sizing: border-box;

  box-shadow: inset 0 1px 1px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  transition: all 0.2s ease;
}

#modal-time:focus {
  outline: none;
  border-color: #aaa;
  box-shadow: 0 0 0 2px rgba(100, 150, 250, 0.15);
}


#modal-confirm {
  width: 100%;
  background-color: #34c759;
  color: white;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  padding: 12px 0;
  cursor: pointer;
  margin-top: 20px;
  transition: background 0.2s ease;
}
#modal-confirm:hover {
  background-color: #28a745;
}


.form-row {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }
  .form-row label {
    flex: 0 0 110px;
    margin-right: 8px;
    font-weight: 500;
  }
  .form-row input,
  .form-row select {
    flex: 1;
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
 .order-type-switch {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  margin-left: 8px; /* 控制整体右移 */
}

.order-btn input {
  display: none;
}

.order-type-switch {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  margin-left: 8px; /* 右移一点 */
}

.order-btn input {
  display: none;
}

.order-btn span {
  display: block;
  padding: 8px 16px;
  border: 1px solid var(--accent-color);
  border-radius: 8px;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.5);
  color: #1a2e28;
  font-weight: 500;
  transition: background 0.2s ease, color 0.2s ease, transform 0.15s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

.order-btn span:hover {
  background: rgba(255, 255, 255, 0.7);
  transform: scale(1.03);
}

.order-btn input:checked + span {
  background: linear-gradient(to bottom, #d8f4e7, #a9e5cd);
  color: #1a2e28;
  font-weight: 600;
  border: none; /* ✅ 移除边框 */
  
}

 
.order-type-switch {
  margin-left: 88px; /* 你可以改成 12px / 16px 看效果 */
}
.checkout-panel label {
  display: block;
  text-align: left;
  font-weight: 500;
  margin-bottom: 4px;
}
.summary-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 6px 0;
}

.summary-row label {
  flex: 1;
  text-align: left;
  font-weight: 500;
  font-size: 0.95rem;
}

.discount-group,
.custom-price-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.discount-group select,
.discount-group input,
.custom-price-group input {
  padding: 6px 8px;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 8px;
  font-size: 0.95rem;
}
#addCustomPrice {
  padding: 6px 12px;
  font-size: 0.9rem;
  border-radius: 10px;
  background-color: #b3d4ff;
  color: #333;
  border: none;
   margin-top: -3px; /* 向上移动 */
  cursor: pointer;
  transition: background 0.2s ease;
}

#addCustomPrice:hover {
  background-color: #a3c8ff;
}

/* Toast notification */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(100%);
  background: rgba(0,0,0,0.8);
  color: #fff;
  padding: 10px 16px;
  border-radius: 8px;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  z-index: 10000;
}
.toast.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.zsm-badge {
  display: inline-block;
  background-color: #e53935; /* 温和红色 */
  color: white;
  font-size: 14px;
  font-weight: 600;
  padding: 6px 12px;
  margin-top: 8px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  animation: fadeIn 0.4s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}
.order-card {
  position: relative;
  padding-bottom: 140px; /* 为二维码腾出底部空间 */
}

.qr-wrapper {
  position: absolute;
  right: 10px;
  bottom: 10px;
}

.qr-wrapper img {
  width: 50px;
  height: 50px;
}
.btn-print {
  background: linear-gradient(#a2a2a7, #bebebe);
  color: #000;
  border: 1px solid #c6c6cc;
  border-radius: 12px;
  padding: 6px 14px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  transition: all 0.2s ease-in-out;/
}

.btn-print:hover {
  background: linear-gradient(#e5e5ea, #c7c7cc);
}

.btn-print:active {
  background: linear-gradient(#d1d1d6, #aeaeb2);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
}
/* 建议付款按钮 */
#wissel-suggest-btns button {
  appearance: none;
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
  transition: background .15s ease, transform .12s ease;
}
#wissel-suggest-btns button:hover {
  background: #f0f0f0;
}
#wissel-suggest-btns button:active {
  transform: translateY(1px);
}

/* 找零策略按钮 */
.wissel-strat {
  appearance: none;
  background: #f9f9f9;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 5px 10px;
  font-size: 13px;
  cursor: pointer;
  transition: background .15s ease, border-color .15s ease;
}
.wissel-strat:hover {
  background: #f0f0f0;
}
.wissel-strat.active {
  background: var(--ios-blue);
  border-color: var(--ios-blue);
  color: #fff;
  font-weight: 600;
}

/* 欠款提示 */
#wissel-short {
  margin-top: 6px;
  color: #b00;
  font-weight: 600;
  font-size: 14px;
}

/* 模态框的抖动动画 (不足额时 Enter 键触发) */
@keyframes shake {
  0%   { transform: translateX(0); }
  20%  { transform: translateX(-6px); }
  40%  { transform: translateX(6px); }
  60%  { transform: translateX(-4px); }
  80%  { transform: translateX(4px); }
  100% { transform: translateX(0); }
}
#wissel-modal.shake {
  animation: shake 0.3s;
}

.btn-wissel{
  appearance:none;
  background: linear-gradient(180deg, var(--ios-blue), var(--ios-blue-press));
  color:#fff;                            /* iOS 主按钮文字是白色 */
  border:none;
  border-radius:14px;
  padding:8px 14px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  box-shadow:
    0 1px 0 rgba(0,0,0,0.10),
    0 4px 10px rgba(10,132,255,0.25);    /* 柔和外阴影 */
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}
.btn-wissel:hover{ filter: brightness(1.05); }
.btn-wissel:active{
  transform: translateY(1px);
  box-shadow:
    inset 0 1px 2px rgba(0,0,0,0.25),
    0 0 0 rgba(0,0,0,0);
}
.btn-wissel:focus-visible{
  outline: none;
  box-shadow:
    0 0 0 2px #fff,
    0 0 0 4px var(--ios-blue);           /* 焦点环 */
}
/* 建议付款 & 策略按钮：统一 iOS 次按钮风格 */
#wissel-suggest-btns button,
.wissel-strat {
  appearance: none;
  background: linear-gradient(180deg, #fff, #f2f2f2);
  border: 1px solid #ccc;
  border-radius: 12px;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 500;
  color: #333;
  cursor: pointer;
  box-shadow:
    0 1px 0 rgba(0,0,0,0.06),
    0 2px 5px rgba(0,0,0,0.08);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, background .15s ease;
}

/* 悬停/按下效果 */
#wissel-suggest-btns button:hover,
.wissel-strat:hover {
  filter: brightness(1.03);
}
#wissel-suggest-btns button:active,
.wissel-strat:active {
  transform: translateY(1px);
  box-shadow:
    inset 0 1px 2px rgba(0,0,0,0.25),
    0 0 0 rgba(0,0,0,0);
}

/* 策略按钮激活态：蓝底白字 */
.wissel-strat.active {
  background: linear-gradient(180deg, var(--ios-blue), var(--ios-blue-press));
  border-color: var(--ios-blue);
  color: #fff;
  font-weight: 600;
  box-shadow:
    0 1px 0 rgba(0,0,0,0.10),
    0 4px 10px rgba(10,132,255,0.25);
}
/* 默认找零金额样式（灰色，低调） */
#wissel-change {
  color: #555;
  font-weight: 600;
  font-size: 18px;
}

/* 找零时（已达到应付金额后），加上苹果绿 */
#wissel-change.positive {
  color: #34C759; /* iOS 苹果绿 */
}

/* 欠款提示：苹果红 */
#wissel-short {
  margin-top: 6px;
  color: #FF3B30;  /* iOS Red */
  font-weight: 600;
  font-size: 14px;
}
/* 找零/还差 统一用一行显示 —— 基础样式 */
#wissel-change {
  color: #555;
  font-weight: 700;
  font-size: 18px;
}

/* 未达到应付：红色 */
#wissel-change.negative { color: #FF3B30; }

/* 正好 or 需要找零：苹果绿 */
#wissel-change.positive,
#wissel-change.exact { color: #34C759; }

/* （可选）不再单独用 #wissel-short */
#wissel-short { display: none; }


/* ===== 父页对话框（#wissel-modal-pos） ===== */
/* 只在 wissel 弹窗里启用深色+白字 & 大字号 */
#wissel-modal-pos{
  /* 全局变量在此作用域内覆写 */
  --ios-label: #fff;                     /* 默认文字白 */
  --ios-card:  #1c1c1e;                  /* 深色卡片底 */
  --ios-chip:  #2c2c2e;                  /* 深色胶囊底 */
  --ios-sep:   rgba(255,255,255,.18);    /* 细分隔线 */
  font-size: 18px;                       /* 整体字号放大 */
  border:0; padding:0; background:transparent;
}
/* 未 open 时不拦截点击 */
#wissel-modal-pos:not([open]){ display:none !important; pointer-events:none !important; }
#wissel-modal-pos::backdrop{ background:rgba(0,0,0,.45); backdrop-filter:blur(6px); }

/* 卡片容器 */
#wissel-modal-pos .card{
  background: var(--ios-card);
  color: white;                          /* ← 修正拼写 & 强制白字 */
  width: 360px;                          /* 略加宽更好看 */
  max-width: 92%;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 12px 30px rgba(0,0,0,.18);
  border: 1px solid var(--ios-sep);
  text-align: center;
}
#wissel-modal-pos h3{ margin:0 0 8px; font-size:22px; font-weight:700; }

/* 金额行更醒目 */
#pos-wissel-due, #pos-wissel-change{ font-size:20px; font-weight:700; }

/* 输入框：深底白字（含光标/占位符） */
#wissel-modal-pos input{
  width:100%; margin:12px 0; padding:12px 14px;
  font-size:20px; text-align:center;
  background:#2c2c2e;                   /* 深底 */
  color:#fff; caret-color:#fff;          /* 白字 + 白光标 */
  border:1px solid var(--ios-sep);
  border-radius:12px; outline:none; box-sizing:border-box;
  transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
}
#wissel-modal-pos input::placeholder{ color:rgba(255,255,255,.6); }
#wissel-modal-pos input:focus{
  border-color:#0a84ff;
  box-shadow:0 0 0 3px rgba(10,132,255,.25);
}

/* 快捷面额（胶囊）深底白字 */
#wissel-modal-pos .quick{
  display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:12px 0 8px;
}
#wissel-modal-pos .quick button{
  appearance:none;
  padding:9px 14px;
  border:1px solid var(--ios-sep);
  border-radius:9999px;
  background: var(--ios-chip);           /* 深色底 */
  color:#fff; cursor:pointer;
  font-weight:600;
  transition: transform .1s ease, background .12s ease, border-color .12s ease, filter .12s ease;
}
#wissel-modal-pos .quick button:hover{ filter: brightness(1.08); }
#wissel-modal-pos .quick button:active{ transform: scale(.98); }

/* 底部动作按钮 */
#wissel-modal-pos .actions{ display:flex; gap:12px; margin-top:16px; }
#wissel-modal-pos .btn{
  flex:1; padding:12px 12px; border:0; border-radius:12px;
  font-weight:700; cursor:pointer;
  transition: transform .1s ease, filter .12s ease, box-shadow .12s ease;
}
#wissel-modal-pos .btn-primary{
  background: linear-gradient(180deg, #0a84ff, #0066d6);
  color:#fff; box-shadow:0 6px 16px rgba(10,132,255,.28);
}
#wissel-modal-pos .btn-primary:hover{ filter:brightness(1.05); }
#wissel-modal-pos .btn-primary:active{ transform: translateY(1px); }

#wissel-modal-pos .btn-secondary{
  background: transparent;
  color:#fff; border:1px solid var(--ios-sep);
}
#wissel-modal-pos .btn-secondary:hover{
  background: rgba(255,255,255,.06);
}

/* 辅助文字也统一白色 */
#wissel-modal-pos .muted{ color:#fff; opacity:.8; font-size:16px; }

/* ===== Pin-betaling dialoog (#pin-modal-pos) ===== */
#pin-modal-pos{
  --ios-label:#fff;
  --ios-card:#1c1c1e;
  --ios-sep:rgba(255,255,255,.18);
  font-size:18px;
  border:0; padding:0; background:transparent;
}
#pin-modal-pos:not([open]){ display:none !important; pointer-events:none !important; }
#pin-modal-pos::backdrop{ background:rgba(0,0,0,.45); backdrop-filter:blur(6px); }
#pin-modal-pos .card{
  background:var(--ios-card);
  color:#fff;
  width:360px;
  max-width:92%;
  padding:20px;
  border-radius:16px;
  box-shadow:0 12px 30px rgba(0,0,0,.18);
  border:1px solid var(--ios-sep);
  text-align:center;
}
#pin-modal-pos h3{ margin:0 0 8px; font-size:22px; font-weight:700; }
#pin-modal-pos .actions{ display:flex; flex-direction:column; gap:12px; margin-top:16px; }
#pin-modal-pos .btn{
  padding:12px; border:0; border-radius:12px; font-weight:700; cursor:pointer;
}
#pin-modal-pos .btn-primary{ background:linear-gradient(180deg,#0a84ff,#0066d6); color:#fff; }
#pin-modal-pos .btn-secondary{ background:transparent; color:#fff; border:1px solid var(--ios-sep); }
#pin-modal-pos .btn-secondary:hover{ background:rgba(255,255,255,.06); }

/* 列表里的“Wissel”触发按钮：也可稍微放大一点 */
.btn-wissel{
  appearance:none;
  background: linear-gradient(180deg, #0a84ff, #0066d6);
  color:#fff; border:none; border-radius:14px;
  padding:9px 16px; font-size:15px; font-weight:700; cursor:pointer;
  box-shadow:0 1px 0 rgba(0,0,0,.10), 0 4px 10px rgba(10,132,255,0.25);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}
.btn-wissel:hover{ filter:brightness(1.05); }
.btn-wissel:active{ transform:translateY(1px); box-shadow: inset 0 1px 2px rgba(0,0,0,.25); }
.btn-wissel:focus-visible{
  outline:none; box-shadow:0 0 0 2px #fff, 0 0 0 4px #0a84ff;
}

.btn-afrekenen{
  appearance:none;
  background: linear-gradient(180deg, #0a84ff, #0066d6);
  color:#fff; border:none; border-radius:14px;
  padding:9px 16px; font-size:15px; font-weight:700; cursor:pointer;
  box-shadow:0 1px 0 rgba(0,0,0,.10), 0 4px 10px rgba(10,132,255,0.25);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}
.btn-afrekenen:hover{ filter:brightness(1.55); }
.btn-afrekenen:active{ transform:translateY(1px); box-shadow: inset 0 1px 2px rgba(0,0,0,.25); }

/* 提示颜色 & 禁用态 & 抖动 */
#wissel-modal-pos .hint{ margin-top:6px; font-size:14px; }
#wissel-modal-pos .hint.error{ color:#ff453a; } /* iOS Red */
#wissel-modal-pos .hint.ok{ color:#34c759; }    /* iOS Green */

#wissel-modal-pos .btn-primary.is-disabled,
#wissel-modal-pos .btn-primary:disabled{
  filter: grayscale(.3) opacity(.6);
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}

@keyframes posShake{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-4px)} 40%{transform:translateX(4px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
#wissel-modal-pos input.invalid{ animation: posShake .25s linear; }

/* —— 统一金额状态：不足/正好/找零 都在 #pos-wissel-change —— */

/* 基础：在深色卡片上更醒目一些 */
#pos-wissel-change{
  font-size: 22px;          /* 在你已设 20px 的基础上再略放大更清晰 */
  font-weight: 800;
  letter-spacing: .2px;
  color: #fff;              /* 默认白字（例如初始 0,– 时） */
}

/* 欠款（Te weinig）：iOS Red，保证深色底上高对比 */
#pos-wissel-change.negative{ color:#ff453a; }

/* 正好/找零：iOS Green（苹果绿） */
#pos-wissel-change.exact,
#pos-wissel-change.positive{ color:#34c759; }

/* 我们把旧提示行隐藏（不删除，保留结构以免影响布局/JS） */
#pos-wissel-hint{ display:none !important; }

/* 找零分解的行在深色底上也更清晰一些（可选） */
#pos-wissel-denoms{
  color:#fff; opacity:.9;
  font-weight: 600;
  line-height: 1.35;
}
/* 你的 navbar 容器 */


/* 给切换按钮一个轻微的“激活”提示（可选） */
#sort-toggle[data-mode="arrival"]{
  /* 到达顺序时稍微变亮一点，或加描边 */
  filter: brightness(1.05);
}


</style>
</head>
<body>
<div class="navbar-container" id="navbar-container">
  <nav class="navbar" id="navbar">
    <div class="nav-categories">
      <a href="#customer-info">Klant</a>
      <a href="#bubble">Bubble Tea</a>
      <a href="#bento">Bento Box</a>
      <a href="#Ramen">Ramen</a>
      <a href="#Teppanyaki">Teppanyaki Gebakken Rijst</a>
      <a href="#Pokebowl">Pokebowl</a>
      <a href="#sushi">Omakase Sushi</a>
      <a href="#sashimi">Sashimi</a>
      <a href="#Crispy-rice-sandwich">Crispy Rice</a>
      <a href="#snack">Snack</a>
      <a href="#dessert">Dessert</a>
      <a href="#drinks">Drinks</a>
      <a href="#vegan">Vegan</a>
    </div>
    <div class="indicator" id="indicator"></div>
  </nav>
</div>

<div class="pos-layout">
  <div class="side-tools">
    <div id="todayOrders" class="orders-slide">

      <!-- 固定导航栏 -->
      <div class="orders-header">
        <button id="sort-toggle" class="btn-wissel">🕓</button>
        <button id="admin-orders-btn">📙</button>
        <button id="toggle-map-btn">🗺️</button>
        <button id="closeToday">✕</button>
        
    
      </div>
     
      <!-- 可滚动订单列表 -->
      <div class="orders-panel">
        {% include 'orders_table.html' %}
      </div>

    </div>
  </div>
</div>

  <div class="center-area">
    <div class="product-list">
      {% include 'menu.html' %}
    </div>
  </div>
  <div id="cartPanel" class="cart-panel">
    <button id="closeCartPanel" class="close-btn">×</button>
    <div class="cart-area">
      <h2>Overzicht</h2>
      <ul id="cart"></ul>
      <div class="supply-row">
        <img alt="Stokjes" class="supply-img photo" src="{{ url_for('static', filename='images/chopsticks.png') }}"/>
        <div class="supply-content">
          <label for="chopstickCount">Aantal stokjes</label>
          <select id="chopstickCount" class="supply-select"></select>
        </div>
      </div>
      <div class="supply-row">
        <img alt="Sojasaus" class="supply-img photo" src="{{ url_for('static', filename='images/soja saus.webp') }}"/>
        <div class="supply-content">
          <label for="soyCount">Aantal sojasaus</label>
          <select id="soyCount" class="supply-select"></select>
        </div>
      </div>
      <div class="supply-row">
        <img alt="Gember" class="supply-img photo" src="{{ url_for('static', filename='images/gembeerr.png') }}"/>
        <div class="supply-content">
          <label for="gemberCount">Aantal gember</label>
          <select id="gemberCount" class="supply-select"></select>
        </div>
      </div>
      <div class="supply-row">
        <img alt="Wasabi" class="supply-img photo" src="{{ url_for('static', filename='images/wasabib.png') }}"/>
        <div class="supply-content">
          <label for="wasabiCount">Aantal wasabi</label>
          <select id="wasabiCount" class="supply-select"></select>
        </div>
      </div>
      <div class="summary-row">
  <label>Subtotaal:</label>
  <span id="summarySubtotal">€0,00</span>
</div>

<div class="summary-row">
  <label>Verpakkingskosten:</label>
  <span id="summaryPackaging">€0,00</span>
</div>

<div id="summaryStatiegeldRow" class="summary-row hidden">
  <label>Statiegeld:</label>
  <span id="summaryStatiegeld">€0,00</span>
</div>

<div id="summaryDeliveryRow" class="summary-row hidden">
  <label>Bezorgkosten:</label>
  <span id="summaryDelivery">€0,00</span>
</div>

<div class="summary-row">
  <label for="discountValue">Korting:</label>
  <div class="discount-group">
    <select id="discountType">
      <option value="amount">€</option>
      <option value="percent">%</option>
    </select>
    <input id="discountValue" type="number" value="0" min="0" step="0.01" />
    <span id="summaryDiscount">€0,00</span>
  </div>
</div>

<div class="summary-row">
  <label for="customPrice">Eigen Invoer:</label>
  <div class="custom-price-group">
    <input id="customPrice" type="number" min="0" step="0.01" />
    <button id="addCustomPrice" type="button">Toevoegen</button>
  </div>
</div>

<div class="summary-row" id="summaryBtw9Row" style="display:none;">
  <label>BTW 9%:</label>
  <span id="summaryBtw9">€0,00</span>
</div>

<div class="summary-row" id="summaryBtw21Row" style="display:none;">
  <label>BTW 21%:</label>
  <span id="summaryBtw21">€0,00</span>
</div>

<div class="summary-row">
  <label><strong>Totaal:</strong></label>
  <strong><span id="total">€0,00</span></strong>
</div>

<label for="remark" style="display:block;margin-top:10px;">Opmerking:</label>
<textarea id="remark" rows="2" placeholder="Bijv. geen komkomer, extra mayo"></textarea>

    </div>
    <div class="checkout-panel">
  <section id="customer-info">
    <div class="delivery-options">
      <h2 style="margin-bottom: 6px;">Besteltype</h2>
      <div class="order-type-switch">
        <label class="order-btn">
          <input type="radio" id="typePickup" name="orderType" value="pickup" checked />
          <span>Afhalen</span>
        </label>
        <label class="order-btn">
          <input type="radio" id="typeDelivery" name="orderType" value="delivery" />
          <span>Bezorging</span>
        </label>
      </div>

      <h2 style="margin-top: 16px;">Klantgegevens</h2>

      <div class="form-row">
        <label for="custName">Naam</label>
        <input id="custName" type="text" placeholder="Naam" />
      </div>

      <div class="form-row">
        <label for="custPhone">Telefoon</label>
        <input id="custPhone" type="tel" placeholder="Telefoonnummer" />
      </div>

      <!-- Pickup Fields -->
      <div id="pickupFields" style="margin-top: 10px;">
        <div class="form-row">
          <label for="pickup_time">Pickup Tijd*</label>
          <select id="pickup_time"></select>
        </div>
        <div class="form-row">
          <label for="pickupPayment">Betaalwijze*</label>
          <select id="pickupPayment">
            <option value="pin" selected>Pin</option>
            <option value="cash">Contant</option>
            <option value="oprekening">Oprekening</option>
          </select>
        </div>
      </div>

      <!-- Delivery Fields -->
      <div id="deliveryFields" class="hidden" style="margin-top:10px;">
        <div class="form-row">
          <label for="postcode">Postcode*</label>
          <input id="postcode" type="text" placeholder="1234AB" />
        </div>
        <div class="form-row">
          <label for="houseNumber">Huisnummer*</label>
          <input id="houseNumber" type="text" placeholder="1" />
        </div>
        <div class="form-row">
          <label for="street">Straat*</label>
          <input id="street" type="text" placeholder="Straat" />
        </div>
        <div class="form-row">
          <label for="city">Plaats*</label>
          <input id="city" type="text" placeholder="Plaats" />
        </div>
        <div class="form-row">
          <label for="delivery_time">Bezorgtijd</label>
          <select id="delivery_time"></select>
        </div>
        <div class="form-row">
          <label for="deliveryPayment">Betaalwijze*</label>
          <select id="deliveryPayment">
            <option value="pin" selected>Pin</option>
            <option value="cash">Contant</option>
            <option value="oprekening">Oprekening</option>
          </select>
        </div>
      </div>

      <!-- QR Code Section -->
      <div id="qrCodeContainer" class="hidden" style="margin-top:10px;">
        <p><strong>📍 Scan voor navigatie:</strong></p>
        <img id="qrCodePreview" src="" alt="QR Code" style="display:block; margin:auto;" />
        <div id="mapsLinkContainer" style="text-align:left; margin-top:4px;"></div>
      </div>
    </div>
  </section>

  

  <button id="submitOrder">Submit Order</button>
</div>
<button id="cartToggle" class="cart-toggle">🛒<span id="cartCount" class="badge">0</span></button>
<button id="toggleToday" class="today-btn">
  Bestelling Vandaag
  <span class="badge-text-only today-badge"></span>
</button>
<button id="todayToggleMobile" class="today-toggle">
  <span class="emoji-wrapper">
    📋
    <span class="badge-text-only today-badge"></span>
  </span>
</button>




<div id="xBowlAddedModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:1000;">
  <div style="background:white; padding:20px; border-radius:12px; text-align:center;">
    <p>Toegevoegd! Nieuwe maken?</p>
    <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
      <button id="xBowlAgain">Ja, graag</button>
      <button id="xBowlClose">Nee, bedankt</button>
    </div>
  </div>
</div>

<!-- 自定义新订单弹窗 -->
<div id="order-modal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; border-radius:10px; padding:20px; max-width:500px; width:90%; box-shadow:0 0 20px rgba(0,0,0,0.3); position:relative;">
    
    <!-- ✅ 放在这里 -->
    <div id="zsm-badge" style="display: none; position: absolute; top: 10px; right: 10px; background: red; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;">
      Z.S.M.
    </div>

    <h2>Nieuwe bestelling</h2>
    <p><strong>Bestelnummer:</strong> <span id="modal-order-id"></span></p>
    <p><strong>Klant:</strong> <span id="modal-customer-name"></span></p>
    <p><strong>Adres:</strong> <span id="modal-address"></span></p>
    <p><strong>Gerechten:</strong><br><span id="modal-items"></span></p>
    <p><strong>Opmerking:</strong> <span id="modal-remark"></span></p>
    <p><strong>Totaal:</strong> <span id="modal-total"></span></p>
    <label><strong>Afhaal-/bezorgtijd:</strong></label><br>
    <div id="modal-time-wrapper" style="margin-bottom:15px;">
      <input type="time" id="modal-time" />
      <div id="Z.S.M.-display" class="zsm-badge" style="display:none;">Z.S.M.</div>


    </div>

    <br>
    <button id="modal-confirm" style="padding:8px 16px;">Bevestigen 👌</button>
  </div>
</div>
<dialog id="deliveryModal">
  <form method="dialog">
    <h3>Kies een bezorger</h3>
    <select id="deliverySelect" class="modal-select"></select>
    <div class="modal-buttons">
      <button id="confirmDelivery" type="button">Bevestigen</button>
      <button type="button" onclick="document.getElementById('deliveryModal').close()">Annuleer</button>
    </div>
  </form>
</dialog>

<dialog id="wissel-modal-pos">
  <div class="card">
    <h3>Wissel</h3>
    <p>Te ontvangen: <strong id="pos-wissel-due">€0,00</strong></p>
    <input id="pos-wissel-paid" type="number" step="0.05" placeholder="Betaald bedrag" />
    <div class="quick">
      <button type="button" data-add="5">+5</button>
      <button type="button" data-add="10">+10</button>
      <button type="button" data-add="20">+20</button>
      <button type="button" data-add="50">+50</button>
      <button type="button" id="pos-wissel-exact">Exact</button>
    </div>
    <p>Wisselgeld: <strong id="pos-wissel-change">€0,00</strong></p>
    <div id="pos-wissel-denoms" class="muted"></div>
    <div class="actions">
      <button id="pos-wissel-close" class="btn btn-secondary">Sluiten</button>
      <button id="pos-wissel-pin" class="btn btn-secondary">Overschakelen naar PIN</button>
      <button id="pos-wissel-ok" class="btn btn-primary">Bevestigen</button>
    </div>
  </div>
</dialog>

<dialog id="pin-modal-pos">
  <div class="card">
    <h3>Pin Betaling</h3>
    <p>Te betalen: <strong id="pin-due">€0,00</strong></p>
    <p id="pin-status" class="muted"></p>
    <div class="actions">
      <button id="pin-send" class="btn btn-primary">Pinnen</button>
      <button id="pin-later" class="btn btn-secondary">Later betalen</button>
      <button id="pin-to-cash" class="btn btn-secondary">Overschakelen naar Contant (wisselen)</button>
    </div>
  </div>
</dialog>



<script>
const cart = {};
const extras = {
  chopstickCount: { label: 'Stokjes', price: 0 },
  soyCount: { label: 'Sojasaus', price: 0 },
  gemberCount: { label: 'Gember', price: 0 },
  wasabiCount: { label: 'Wasabi', price: 0 }
};
let milkTeaPrice = 0;
let bubbleOptions = {base: [], smaak: [], topping: []};
let xbentoOptions = {main: [], side: [], rice: [], groente: []};
let xbentoSetControls;
const xbowlBases=[
  {name:'Sushi rijst',price:4},
  {name:'IJsbergsla',price:5},
  {name:'Tempura crispy rijst',price:6}
];
const xbowlMains=[
  {name:'geen',price:0},
  {name:'Zalm',price:9},
  {name:'Tonijn',price:9},
  {name:'Gamba',price:8},
  {name:'Crispy chicken',price:8},
  {name:'Spicy crispy chicken',price:8},
  {name:'Teriyaki beef',price:9},
  {name:'Teriyaki chicken',price:9},
  {name:'Ribeye',price:9},
  {name:'Unagi',price:9},
  {name:'Spicy tuna',price:9},
  {name:'Krabstick',price:8}
];
const xbowlToppings=['geen','Komkommer','Avocado','Sojabonen','Mais','Zeewiersalade','Masago','Inari','Tamago'];
const XBOWL_TOPPING_PRICE=1.5;
const SAUCE_OPTIONS=['Geen','Japans mayo','Spicy mayo','Unagi saus','Spicy teriyaki saus','Korean chili saus','Cury mayo','Japans chili saus','Soy saus','Truffel mayo','Wasabi mayo'];
const POKEBOWL_IDS=['zalmBowlQty','tunaBowlQty','ebiFryBowlQty','chickenKaraageBowlQty','spicyChickenBowlQty','teriyakiChickenBowlQty','teriyakiBeefBowlQty','californiaBowlQty','vegaBowlQty','meatloverBowlQty','rainbowBowlQty','spicyTunaBowlQty','flamedZalmBowlQty','flamedTunaBowlQty','snackCount','ebiFryCount','ebikroketCount','spicyCrispyChickenCount','miniLoempiaCount','japansZalmNuggetCount','chickenLoempiaCount','gyozaCount','inktvisRingenCount'];
let currentXBowlName="";

function getOptionPrice(cat,name){
  const opt=(bubbleOptions[cat]||[]).find(o=>o.name===name);
  return opt?parseFloat(opt.price):0;
}

function getBubbleTeaPrice(){
  const type=document.getElementById('bubbleType').value;
  const flavor=document.getElementById('bubbleFlavor').value;
  const topping=document.getElementById('bubbleTopping').value;
  return getOptionPrice('base',type)+getOptionPrice('smaak',flavor)+getOptionPrice('topping',topping);
}

function updateMilkTeaDisplay(){
  milkTeaPrice=getBubbleTeaPrice();
  const item=document.querySelector('.menu-item[data-name="Bubble Tea"]');
  if(item){
    item.dataset.price=milkTeaPrice;
    const p=item.querySelector('p');
    if(p) p.textContent=`€${milkTeaPrice.toFixed(2)}`;
  }
}

function getXbentoOptionPrice(cat,name){
  const opt=(xbentoOptions[cat]||[]).find(o=>o.name===name);
  return opt?parseFloat(opt.price):0;
}

function getXbentoPrice(){
  const main=document.getElementById('xBentoMain').value;
  const side=document.getElementById('xBentoSide').value;
  const rice=document.getElementById('xBentoRice').value;
  const veg=document.getElementById('xBentoVeg').value;
  return getXbentoOptionPrice('main',main)+getXbentoOptionPrice('side',side)+getXbentoOptionPrice('rice',rice)+getXbentoOptionPrice('groente',veg);
}


function updateXbentoDisplay(){
  
  const main=document.getElementById('xBentoMain').value;
  const side=document.getElementById('xBentoSide').value;
  const rice=document.getElementById('xBentoRice').value;
  const veg=document.getElementById('xBentoVeg').value;

  const item=document.querySelector('.menu-item[data-name="Xbento"]');
  const p=item?.querySelector('p');

  if(!main && !side && !rice && !veg){
    if(p) p.textContent="Xbento Zelf Samenstellen";
    return;
  }

  const price=getXbentoPrice();
  if(item){
    item.dataset.price=price;
    
    if(p) p.textContent=`€ ${price.toFixed(2)}`;
  }
}

function getXBowlSelections(){
  const baseSel=document.getElementById('xBowlBase');
  const baseOpt=baseSel?baseSel.selectedOptions[0]:null;
  const mains=Array.from(document.querySelectorAll('#xBowlMains select')).map(s=>s.selectedOptions[0]).filter(o=>o&&o.value);
  const toppings=Array.from(document.querySelectorAll('#xBowlToppings select')).map(s=>s.value).filter(v=>v);
  return{baseOpt,mains,toppings};
}

function updateXBowlDisplay(){
  const {baseOpt,mains,toppings}=getXBowlSelections();
  let price=0;
  if(baseOpt&&baseOpt.dataset.price) price+=parseFloat(baseOpt.dataset.price);
  mains.forEach(o=>{price+=parseFloat(o.dataset.price||0);});
  const paidTops=toppings.filter(t=>t.toLowerCase()!=='geen');
  price+=paidTops.length*XBOWL_TOPPING_PRICE;
  const item=document.querySelector('.menu-item[data-name="X-Bowl"]');
  if(item){
    item.dataset.price=price;
    const p=document.getElementById('xBowlPrice');
    if(p) p.textContent=price?`€ ${price.toFixed(2)}`:'Prijs afhankelijk van keuzes';
    const info=document.getElementById('xBowlSummary');
    if(info){
      const mainNames=mains.map(o=>o.value).join(', ');
      const topNames=toppings.join(', ');
      let parts=[];
      if(baseOpt&&baseOpt.value) parts.push(baseOpt.value);
      if(mainNames) parts.push(mainNames);
      if(topNames) parts.push(topNames);
      const text=parts.join(' | ');
      info.textContent=text?`${text} - € ${price.toFixed(2)}`:'';
    }
  }
}

function getXBowlName(){
  const {baseOpt,mains,toppings}=getXBowlSelections();
  if(!baseOpt||!baseOpt.value||mains.length===0) return '';
  const mainNames=mains.map(o=>o.value).join(', ');
  const topNames=toppings.join(', ');
  return `X-Bowl (${baseOpt.value} | ${mainNames}${topNames?' | '+topNames:''})`;
}

function updateXBowlControls(){
  const wrap=document.getElementById('xBowlNewWrap');
  const qty=parseInt(document.getElementById('xBowlQty').value||0);
  if(isXbowlValid()&&qty>0) wrap.classList.remove('hidden');
  else wrap.classList.add('hidden');
}

function changeXbowlQty(delta){
  const sel=document.getElementById('xBowlQty');
  let val=parseInt(sel.value||0);
  const name=getXBowlName();
  if(!name) return;
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  updateXBowlDisplay();
  const price=parseFloat(document.querySelector('.menu-item[data-name="X-Bowl"]').dataset.price||0);
  if(currentXBowlName && currentXBowlName!==name && cart[currentXBowlName]){
    delete cart[currentXBowlName];
  }
  setQty(name,price,val,0.2);
  currentXBowlName=name;
  updateXBowlControls();
  if(delta>0 && val>0) showXBowlModal();
}

function createXBowlMainSelect(){
  const div=document.createElement('div');
  const sel=document.createElement('select');
  sel.innerHTML='<option value="">Hoofdingredient</option>';
  xbowlMains.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.dataset.price=o.price;opt.textContent=o.name;sel.appendChild(opt);});
  const del=document.createElement('button');del.type='button';del.textContent='❌';
  del.addEventListener('click',()=>{div.remove();ensureXBowlMain();updateXBowlDisplay();updateXBowlControls();changeXbowlQty(0);});
  sel.addEventListener('change',()=>{
    const val = sel.value.toLowerCase();
    if(sel.value && val !== 'geen' && div===document.querySelector('#xBowlMains').lastElementChild){
      if(confirm('Wil je extra portie?')){
        document.getElementById('xBowlMains').appendChild(createXBowlMainSelect());
      }
    }
    updateXBowlDisplay();
    updateXBowlControls();
    changeXbowlQty(0);
  });
  div.appendChild(sel);div.appendChild(del);return div;
}

function createXBowlToppingSelect(){
  const div=document.createElement('div');
  const sel=document.createElement('select');
  sel.innerHTML='<option value="">Topping</option>';
  xbowlToppings.forEach(n=>{const opt=document.createElement('option');opt.value=n;opt.textContent=n;sel.appendChild(opt);});
  const del=document.createElement('button');del.type='button';del.textContent='❌';
  del.addEventListener('click',()=>{div.remove();ensureXBowlTopping();updateXBowlDisplay();updateXBowlControls();changeXbowlQty(0);});
  sel.addEventListener('change',()=>{
    const val = sel.value.toLowerCase();
    if(sel.value && val !== 'geen' && div===document.querySelector('#xBowlToppings').lastElementChild){
      if(confirm('Wil je extra topping toevoegen?')){
        document.getElementById('xBowlToppings').appendChild(createXBowlToppingSelect());
      }
    }
    updateXBowlDisplay();
    updateXBowlControls();
    changeXbowlQty(0);
  });
  div.appendChild(sel);div.appendChild(del);return div;
}

function ensureXBowlMain(){
  const wrap=document.getElementById('xBowlMains');
  if(!wrap.querySelector('select')) wrap.appendChild(createXBowlMainSelect());
}

function ensureXBowlTopping(){
  const wrap=document.getElementById('xBowlToppings');
  if(!wrap.querySelector('select')) wrap.appendChild(createXBowlToppingSelect());
}

function clearXBowlSet(){
  document.getElementById('xBowlBase').value='';
  document.getElementById('xBowlMains').innerHTML='';
  document.getElementById('xBowlToppings').innerHTML='';
  document.getElementById('xBowlQty').value=0;
  ensureXBowlMain();
  ensureXBowlTopping();
  updateXBowlDisplay();
  updateXBowlControls();
  currentXBowlName="";
}

function applyCrispyPrices(prices){
  const map={
    'Zalm crispy rice sandwich': parseFloat(prices.price_zalm_crispy_rice_sandwich),
    'Spicytuna crispy rice sandwich': parseFloat(prices.price_spicytuna_crispy_rice_sandwich),
    'Ebi crispy rice sandwich': parseFloat(prices.price_ebi_crispy_rice_sandwich),
    'Beef crispy rice sandwich': parseFloat(prices.price_beef_crispy_rice_sandwich),
    'California crispy rice sandwich': parseFloat(prices.price_california_crispy_rice_sandwich),
    'Chicken crispy rice sandwich': parseFloat(prices.price_chicken_crispy_rice_sandwich)
  };
  Object.entries(map).forEach(([name,price])=>{
    if(isNaN(price)) return;
    const el=document.querySelector(`.menu-item[data-name="${name}"]`);
    if(el){
      el.dataset.price=price;
      const pe=el.querySelector('p');
      if(pe) pe.textContent=`€${price.toFixed(2)}`;
    }
  });
}

function changeBubbleQty(delta){
  const sel=document.getElementById('bubbleTeaQty');
  let val=parseInt(sel.value||0);
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  const type=document.getElementById('bubbleType').value;
  const flavor=document.getElementById('bubbleFlavor').value;
  const topping=document.getElementById('bubbleTopping').value;
  if(!type||!flavor||!topping) return;
  const name=`Bubble Tea (${type}, ${flavor}, ${topping})`;
  const price=getBubbleTeaPrice();
  setQty(name,price,val,0.2);
}

function changeXbentoQty(delta){
  const sel=document.getElementById('xBentoQty');
  let val=parseInt(sel.value||0);
  const main=document.getElementById('xBentoMain').value;
  const side=document.getElementById('xBentoSide').value;
  const rice=document.getElementById('xBentoRice').value;
  const veg=document.getElementById('xBentoVeg').value;
  if(!main||!side||!rice||!veg) return;
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  const price=getXbentoPrice();
  const name=`Xbento (${main}, ${side}, ${rice}, ${veg})`;
  setQty(name,price,val,0.2);
  if(xbentoSetControls) xbentoSetControls.update();
}

function changeOmakaseQty(delta){
  const sel=document.getElementById('sushiBentoCount');
  let val=parseInt(sel.value||0);
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  updateOmakasePrefs();
}

function updateOmakasePrefs(){
  const qty=parseInt(document.getElementById('sushiBentoCount').value||0);
  const container=document.getElementById('omakasePrefs');
  container.innerHTML='';

  const existing=(cart['Bento Sushi Omakase']&&cart['Bento Sushi Omakase'].prefs)||[];
  for(let i=1;i<=qty;i++){
    const sel=document.createElement('select');
    ['Geen voorkeur','Alleen vis','Alleen vlees','Alleen veggie'].forEach(opt=>{
      const o=document.createElement('option');o.value=opt;o.textContent=opt;sel.appendChild(o);});
    sel.value=existing[i-1]||'Geen voorkeur';
    sel.id=`omakasePref${i}`;
    sel.addEventListener('change',setOmakaseQty);
    container.appendChild(sel);
  }
  setOmakaseQty();
}

function setOmakaseQty(){
  const qty=parseInt(document.getElementById('sushiBentoCount').value||0);
  const prefs=[];

  for(let i=1;i<=qty;i++){
    prefs.push(document.getElementById(`omakasePref${i}`).value);
  }
  const price=parseFloat(document.querySelector('[data-name="Bento Sushi Omakase"]').dataset.price);
  setQty('Bento Sushi Omakase',price,qty,0.2,prefs);
}

function changeDragonQty(delta){
  const sel=document.getElementById('dragonRollCount');
  let val=parseInt(sel.value||0);
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  updateDragonPrefs();
}

function updateDragonPrefs(){
  const qty=parseInt(document.getElementById('dragonRollCount').value||0);
  const container=document.getElementById('dragonPrefs');
  container.innerHTML='';

  const existing=(cart['Dragon Roll Omakase']&&cart['Dragon Roll Omakase'].prefs)||[];
  for(let i=1;i<=qty;i++){
    const sel=document.createElement('select');
    ['Geen voorkeur','Alleen vis','Alleen vlees'].forEach(opt=>{
      const o=document.createElement('option');o.value=opt;o.textContent=opt;sel.appendChild(o);});
    sel.value=existing[i-1]||'Geen voorkeur';
    sel.id=`dragonPref${i}`;
    sel.addEventListener('change',setDragonQty);
    container.appendChild(sel);
  }
  setDragonQty();
}

function setDragonQty(){
  const qty=parseInt(document.getElementById('dragonRollCount').value||0);
  const prefs=[];
  for(let i=1;i<=qty;i++){
    prefs.push(document.getElementById(`dragonPref${i}`).value);
  }
  const price=parseFloat(document.querySelector('[data-name="Dragon Roll Omakase"]').dataset.price);
  setQty('Dragon Roll Omakase',price,qty,0.2,prefs);
}

function updatePokebowlSauces(id,name){
  const qty=parseInt(document.getElementById(id).value||0);
  const container=document.getElementById(id+'Sauces');
  if(!container) return;
  container.innerHTML='';
  const existing=(cart[name]&&cart[name].prefs)||[];
  for(let i=1;i<=qty;i++){
    const sel=document.createElement('select');
    SAUCE_OPTIONS.forEach(opt=>{const o=document.createElement('option');o.value=opt;o.textContent=opt;sel.appendChild(o);});
    sel.value=existing[i-1]||'Geen';
    sel.dataset.index=i;
    sel.addEventListener('change',()=>setPokebowlQty(id,name));
    container.appendChild(sel);
  }
  setPokebowlQty(id,name);
}

function setPokebowlQty(id,name){
  const sel=document.getElementById(id);
  const qty=parseInt(sel.value||0);
  const menuItem = sel.closest('.menu-item');
  const pack=parseFloat(menuItem.dataset.packaging||0);
  const deposit=parseFloat(menuItem.dataset.statiegeld||0);
  const price=parseFloat(menuItem.dataset.price||0);
  const container=document.getElementById(id+'Sauces');
  const prefs=[];
  for(let i=1;i<=qty;i++){
    const s=container.querySelector(`select[data-index="${i}"]`);
    prefs.push(s?s.value:'Geen');
  }
  setQty(name,price,qty,pack,prefs,deposit);
}

function isRamenValid(code){
  return document.getElementById(code+'Base').value && document.getElementById(code+'Smaak').value;
}


function updateRamenControls(code){
  const base=document.getElementById(code+'Base').value;
  const smaak=document.getElementById(code+'Smaak').value;
  const qty=parseInt(document.getElementById(code+'Qty').value||0);
  const wrap=document.getElementById(code+'NewWrap');
  if(wrap){
    if(base&&smaak&&qty>0) wrap.classList.remove('hidden');
    else wrap.classList.add('hidden');
  }
}
function isXbowlValid(){
  const base=document.getElementById('xBowlBase').value;
  const hasMain=Array.from(document.querySelectorAll('#xBowlMains select')).some(s=>s.value);
  return base&&hasMain;
}

function changeRamenQty(code,delta){
  const sel=document.getElementById(code+'Qty');
  let val=parseInt(sel.value||0);
  val=Math.max(0,Math.min(20,val+delta));
  sel.value=val;
  const item=document.querySelector(`.menu-item[data-code="${code}"]`);
  const base=document.getElementById(code+'Base').value;
  const smaak=document.getElementById(code+'Smaak').value;
  if(!base||!smaak) return;
  const name=item.dataset.name;
  const price=parseFloat(item.dataset.price);
  const pack=parseFloat(item.dataset.packaging||0);
  const fullName=`${name} - ${base} - ${smaak}`;
  setQty(fullName,price,val,pack);
   updateRamenControls(code);
}

function clearRamenSet(code){
  document.getElementById(code+'Base').value='';
  document.getElementById(code+'Smaak').value='';
  document.getElementById(code+'Qty').value=0;
  updateRamenControls(code);
}
function populateSelect(sel){
  for(let i=0;i<=20;i++){ const opt=document.createElement('option'); opt.value=i; opt.textContent=i; sel.appendChild(opt); }
}
function createSelect(current,onChange){
  const sel=document.createElement('select');
  for(let i=0;i<=20;i++){ const opt=document.createElement('option'); opt.value=i; opt.textContent=i; if(i===current) opt.selected=true; sel.appendChild(opt); }
  sel.addEventListener('change',()=>onChange(parseInt(sel.value))); return sel;
}
function setQty(name,price,qty,packaging=0,prefs=null,statiegeld=0){
  if(qty===0){
    delete cart[name];
  } else {
    cart[name]={price,qty,packaging,statiegeld};
    if(prefs) cart[name].prefs=prefs; else if(cart[name]&&cart[name].prefs) delete cart[name].prefs;
  }
  updateCart();
}
function updateCart() {
  const list = document.getElementById('cart');
  list.innerHTML = '';
  let subtotal = 0;
  let packagingTotal = 0;
  let statiegeldTotal = 0;
  let count = 0;

  Object.entries(cart).forEach(([name, item]) => {
    const li = document.createElement('li');

    const displayName = item.displayName || name;

    const rowTotal = item.qty * item.price;

    const label = document.createElement('span');
    label.textContent = `${displayName} x ${item.qty} - €${rowTotal.toFixed(2)} `;

    li.appendChild(label);

    if (item.custom) {
      const delBtn = document.createElement('button');
      delBtn.textContent = '🗑';
      delBtn.addEventListener('click', () => {
        delete cart[name];
        updateCart();
      });
      li.appendChild(delBtn);
    } else {
      const sel = createSelect(item.qty, val => {
        const menuItem = document.querySelector(`[data-name="${name}"]`);
        if (menuItem) {
          const qtyInput = menuItem.querySelector('select');
          if (qtyInput) qtyInput.value = val;
        }
        setQty(name, item.price, val, item.packaging, item.prefs, item.statiegeld);

        if (name === 'Bento Sushi Omakase') {
          document.getElementById('sushiBentoCount').value = val;
          updateOmakasePrefs();
        } else if (name === 'Dragon Roll Omakase') {
          document.getElementById('dragonRollCount').value = val;
          updateDragonPrefs();
        }
      });
      li.appendChild(sel);
    }

    if (item.prefs) {
      const title = document.createElement('div');
      title.textContent = 'Voorkeur:';
      const ul = document.createElement('ul');
      item.prefs.forEach((p, i) => {
        const liP = document.createElement('li');
        liP.textContent = `${i + 1}. ${p}`;
        ul.appendChild(liP);
      });
      li.appendChild(title);
      li.appendChild(ul);
    }

    list.appendChild(li);

    if (item.qty > 0) {
      subtotal += rowTotal;
      packagingTotal += (item.packaging || 0) * item.qty;
      statiegeldTotal += (item.statiegeld || 0) * item.qty;
    }

    count += item.qty;
  });

  const delivery = document.getElementById('typeDelivery').checked ? 2.5 : 0;

  const discountType = document.getElementById('discountType').value;
  let discountVal = parseFloat(document.getElementById('discountValue').value) || 0;
  let discount = 0;
  if (discountType === 'amount') {
    discount = Math.min(discountVal, subtotal);
  } else if (discountType === 'percent') {
    discount = Math.min(discountVal, 100) / 100 * subtotal;
  }
  if (discount < 0 || isNaN(discount)) discount = 0;

  const total = subtotal + packagingTotal + statiegeldTotal + delivery - discount;
  const heinekenTotal = Object.entries(cart).reduce((sum,[k,v])=>{
    const name = v.displayName || k;
    return sum + (/heineken/i.test(name) ? v.price * v.qty : 0);
  },0);
  const rate9 = 0.09;
  const rate21 = 0.21;
  const btw9 = (subtotal + packagingTotal + delivery - discount - heinekenTotal) * rate9 / (1 + rate9);
  const btw21 = heinekenTotal * rate21 / (1 + rate21);
  const btw = btw9 + btw21;

  const fmt = n => `€${n.toFixed(2).replace('.', ',')}`;

  document.getElementById('summarySubtotal').textContent = fmt(subtotal);
  document.getElementById('summaryPackaging').textContent = fmt(packagingTotal);
  document.getElementById('summaryStatiegeld').textContent = fmt(statiegeldTotal);
  document.getElementById('summaryStatiegeldRow').classList.toggle('hidden', !statiegeldTotal);
  document.getElementById('summaryDelivery').textContent = fmt(delivery);
  document.getElementById('summaryDeliveryRow').classList.toggle('hidden', !delivery);
  document.getElementById('summaryDiscount').textContent = discount ? `- ${fmt(discount)}` : '€0,00';
  document.getElementById('summaryBtw9').textContent = fmt(btw9);
  document.getElementById('summaryBtw21').textContent = fmt(btw21);
  document.getElementById('summaryBtw9Row').style.display = btw9>0 ? '' : 'none';
  document.getElementById('summaryBtw21Row').style.display = btw21>0 ? '' : 'none';
  document.getElementById('total').textContent = fmt(total);

  const badge = document.getElementById('cartCount');
  if (badge) badge.textContent = count;
}


function addCustomPrice(){
  const input=document.getElementById('customPrice');
  const val=parseFloat(input.value);
  if(isNaN(val)||val<=0) return;
  const key='custom_'+Date.now();
  cart[key]={price:val,qty:1,custom:true,displayName:'Eigen Invoer'};
  input.value='';
  updateCart();
}


function initNewSetControls({qtyId, wrapId, buttonId, fieldIds, onClear}){
  const qtyEl=document.getElementById(qtyId);
  const wrapEl=document.getElementById(wrapId);
  const btn=document.getElementById(buttonId);

  function update(){
    const filled=fieldIds.every(id=>document.getElementById(id).value);
    const qty=parseInt(qtyEl.value||0);
    if(filled && qty>0) wrapEl.classList.remove('hidden');
    else wrapEl.classList.add('hidden');
  }

  function clear(){
    fieldIds.forEach(id=>{document.getElementById(id).value='';});
    qtyEl.value=0;
    update();
    if(typeof onClear==='function') onClear();
  }

  fieldIds.forEach(id=>document.getElementById(id).addEventListener('change',update));
  qtyEl.addEventListener('change',update);
  if(btn) btn.addEventListener('click',clear);
  return{update,clear};
}



document.addEventListener('DOMContentLoaded',()=>{
  const skip=['bubbleTeaQty','bubbleType','bubbleFlavor','bubbleTopping','xBentoMain','xBentoSide','xBentoRice','xBentoVeg','xBowlBase','xBowlQty',
    'ebiBase','ebiSmaak','ebiQty','chickenBase','chickenSmaak','chickenQty','beefBase','beefSmaak','beefQty',
    'ribeyeBase','ribeyeSmaak','ribeyeQty','chasiuBase','chasiuSmaak','chasiuQty','zhaiBase','zhaiSmaak','zhaiQty'];
  document.querySelectorAll('.menu-item select').forEach(sel=>{
    if(!skip.includes(sel.id) && !sel.closest('#xBowlMains') && !sel.closest('#xBowlToppings')){
      populateSelect(sel);
      const parent=sel.closest('.menu-item');
      const name=parent.dataset.name;
      const price=parseFloat(parent.dataset.price);
      const pack=parseFloat(parent.dataset.packaging||0);
      const deposit=parseFloat(parent.dataset.statiegeld||0);
      if(name==='Bento Sushi Omakase'){
        sel.addEventListener('change',()=>changeOmakaseQty(0));
      } else if(name==='Dragon Roll Omakase'){
        sel.addEventListener('change',()=>changeDragonQty(0));
      } else if(POKEBOWL_IDS.includes(sel.id)){
        sel.addEventListener('change',()=>updatePokebowlSauces(sel.id,name));
        updatePokebowlSauces(sel.id,name);
      } else {
        sel.addEventListener('change',()=>{ setQty(name,price,parseInt(sel.value),pack,null,deposit); });
      }
    }
  });

  ['bubbleTeaQty','xBentoQty','xBowlQty'].forEach(id=>{
    const s=document.getElementById(id);
    for(let i=0;i<=20;i++){const opt=document.createElement('option');opt.value=i;opt.text=i;s.appendChild(opt);} s.value=0;
  });
  ['bubbleType','bubbleFlavor','bubbleTopping'].forEach(id=>{
    document.getElementById(id).addEventListener('change',()=>{updateMilkTeaDisplay();});
  });

  xbentoSetControls = initNewSetControls({
    qtyId:'xBentoQty',
    wrapId:'xBentoNewWrap',
    buttonId:'xBentoNew',
    fieldIds:['xBentoMain','xBentoSide','xBentoRice','xBentoVeg'],
    onClear:()=>updateXbentoDisplay()
  });
  xbentoSetControls.update();



  ['xBentoMain','xBentoSide','xBentoRice','xBentoVeg'].forEach(id=>{
    document.getElementById(id).addEventListener('change',()=>{updateXbentoDisplay();});
  });

  document.querySelector('.qty-plus[data-target="bubbleTeaQty"]').addEventListener('click',()=>{
    if(!document.getElementById('bubbleType').value||!document.getElementById('bubbleFlavor').value||!document.getElementById('bubbleTopping').value){alert('🧋 Kies eerst type, smaak en topping voor je bubble tea.');return;}changeBubbleQty(1);});
  document.querySelector('.qty-minus[data-target="bubbleTeaQty"]').addEventListener('click',()=>{
    if(!document.getElementById('bubbleType').value||!document.getElementById('bubbleFlavor').value||!document.getElementById('bubbleTopping').value){alert('🧋 Kies eerst type, smaak en topping voor je bubble tea.');return;}changeBubbleQty(-1);});
  document.getElementById('bubbleTeaQty').addEventListener('change',()=>{if(!document.getElementById('bubbleType').value||!document.getElementById('bubbleFlavor').value||!document.getElementById('bubbleTopping').value){alert('🧋 Kies eerst type, smaak en topping voor je bubble tea.');document.getElementById('bubbleTeaQty').value=0;return;}changeBubbleQty(0);});

  document.querySelector('.qty-plus[data-target="xBentoQty"]').addEventListener('click',()=>{
    if(!document.getElementById('xBentoMain').value||!document.getElementById('xBentoSide').value||!document.getElementById('xBentoRice').value||!document.getElementById('xBentoVeg').value){alert('🍱 Kies eerst hoofdgerecht, bijgerecht, rijstsoort en groente voor je Xbento.');return;}changeXbentoQty(1);});
  document.querySelector('.qty-minus[data-target="xBentoQty"]').addEventListener('click',()=>{
    if(!document.getElementById('xBentoMain').value||!document.getElementById('xBentoSide').value||!document.getElementById('xBentoRice').value||!document.getElementById('xBentoVeg').value){alert('🍱 Kies eerst hoofdgerecht, bijgerecht, rijstsoort en groente voor je Xbento.');return;}changeXbentoQty(-1);});
  document.getElementById('xBentoQty').addEventListener('change',()=>{if(!document.getElementById('xBentoMain').value||!document.getElementById('xBentoSide').value||!document.getElementById('xBentoRice').value||!document.getElementById('xBentoVeg').value){alert('🍱 Kies eerst hoofdgerecht, bijgerecht, rijstsoort en groente voor je Xbento.');document.getElementById('xBentoQty').value=0;return;}changeXbentoQty(0);});

  ensureXBowlMain();
  ensureXBowlTopping();
  document.getElementById('xBowlBase').addEventListener('change',()=>{updateXBowlDisplay();updateXBowlControls();changeXbowlQty(0);});
  document.getElementById('xBowlNew').addEventListener('click',clearXBowlSet);
  document.querySelector('.qty-plus[data-target="xBowlQty"]').addEventListener('click',()=>{if(!isXbowlValid()){alert('🥗 Basis en hoofdingrediënt vereist.');return;}changeXbowlQty(1);});
  document.querySelector('.qty-minus[data-target="xBowlQty"]').addEventListener('click',()=>{if(!isXbowlValid()){alert('🥗 Basis en hoofdingrediënt vereist.');return;}changeXbowlQty(-1);});
  document.getElementById('xBowlQty').addEventListener('change',()=>{if(!isXbowlValid()){alert('🥗 Basis en hoofdingrediënt vereist.');document.getElementById('xBowlQty').value=0;return;}changeXbowlQty(0);});

  const ramenIds=['ebiQty','chickenQty','beefQty','ribeyeQty','chasiuQty','zhaiQty'];
  document.querySelectorAll('.qty-plus').forEach(btn=>{
    if(['bubbleTeaQty','xBentoQty','xBowlQty',...ramenIds].includes(btn.dataset.target)) return;
    btn.addEventListener('click',()=>{
      const sel=document.getElementById(btn.dataset.target);
      let val=parseInt(sel.value);
      if(val<20) val++;
      sel.value=val;
      const parent=sel.closest('.menu-item');
      if(parent.dataset.name==='Bento Sushi Omakase'){
        changeOmakaseQty(0);
      } else if(parent.dataset.name==='Dragon Roll Omakase'){
        changeDragonQty(0);
      } else if(POKEBOWL_IDS.includes(sel.id)){
        updatePokebowlSauces(sel.id,parent.dataset.name);
      } else {
        const deposit=parseFloat(parent.dataset.statiegeld||0);
        setQty(parent.dataset.name,parseFloat(parent.dataset.price),val,parseFloat(parent.dataset.packaging||0),null,deposit);
      }
    });
  });
  document.querySelectorAll('.qty-minus').forEach(btn=>{
    if(['bubbleTeaQty','xBentoQty','xBowlQty',...ramenIds].includes(btn.dataset.target)) return;
    btn.addEventListener('click',()=>{
      const sel=document.getElementById(btn.dataset.target);
      let val=parseInt(sel.value);
      if(val>0) val--;
      sel.value=val;
      const parent=sel.closest('.menu-item');
      if(parent.dataset.name==='Bento Sushi Omakase'){
        changeOmakaseQty(0);
      } else if(parent.dataset.name==='Dragon Roll Omakase'){
        changeDragonQty(0);
      } else if(POKEBOWL_IDS.includes(sel.id)){
        updatePokebowlSauces(sel.id,parent.dataset.name);
      } else {
        const deposit=parseFloat(parent.dataset.statiegeld||0);
        setQty(parent.dataset.name,parseFloat(parent.dataset.price),val,parseFloat(parent.dataset.packaging||0),null,deposit);
      }
    });
  });

  const ramenCodes=['ebi','chicken','beef','ribeye','chasiu','zhai'];
  ramenCodes.forEach(code=>{
    const qty=document.getElementById(code+'Qty');
    populateSelect(qty);
    qty.value=0;
    updateRamenControls(code);
    document.getElementById(code+'Base').addEventListener('change',()=>updateRamenControls(code));
    document.getElementById(code+'Smaak').addEventListener('change',()=>updateRamenControls(code));
    document.querySelector(`.qty-plus[data-target="${code}Qty"]`).addEventListener('click',()=>{
      if(!isRamenValid(code)){alert('🍜 Kies eerst base en smaak voor je ramen.');return;}
      changeRamenQty(code,1);
    });
    document.querySelector(`.qty-minus[data-target="${code}Qty"]`).addEventListener('click',()=>{
      if(!isRamenValid(code)){alert('🍜 Kies eerst base en smaak voor je ramen.');return;}
      changeRamenQty(code,-1);
    });
    qty.addEventListener('change',()=>{
      if(!isRamenValid(code)){alert('🍜 Kies eerst base en smaak voor je ramen.');qty.value=0;return;}
      changeRamenQty(code,0);
    });
    document.getElementById(code+'New').addEventListener('click',()=>clearRamenSet(code));
  });
  ['chopstickCount','soyCount','gemberCount','wasabiCount'].forEach(id=>{
    populateSelect(document.getElementById(id));
    document.getElementById(id).addEventListener('change',updateCart);
  });
  document.getElementById('discountType').addEventListener('change',updateCart);
  document.getElementById('discountValue').addEventListener('input',updateCart);
  const addCustomBtn=document.getElementById('addCustomPrice');
  if(addCustomBtn){
    addCustomBtn.addEventListener('click',addCustomPrice);
  }
  const toggleTodayBtn = document.getElementById('toggleToday');
  if (toggleTodayBtn) {
    toggleTodayBtn.addEventListener('click', toggleToday);
  }
  const todayToggleMobile=document.getElementById('todayToggleMobile');
  if(todayToggleMobile){
    todayToggleMobile.addEventListener('click',toggleToday);
  }
  document.getElementById('closeToday').addEventListener('click',toggleToday);
  document.getElementById('typePickup').addEventListener('change',toggleAddress);
  document.getElementById('typeDelivery').addEventListener('change',toggleAddress);
  document.getElementById('postcode').addEventListener('blur',fetchAddress);
  document.getElementById('houseNumber').addEventListener('blur',fetchAddress);
  document.getElementById('postcode').addEventListener('blur',updateQRCode);
  document.getElementById('houseNumber').addEventListener('blur',updateQRCode);
  document.getElementById('street').addEventListener('blur',updateQRCode);
  document.getElementById('city').addEventListener('blur',updateQRCode);
  document.getElementById('submitOrder').addEventListener('click',submitOrder);
  const cartToggle=document.getElementById('cartToggle');
  const cartPanel=document.getElementById('cartPanel');
  const closeCart=document.getElementById('closeCartPanel');
  if(cartToggle){
    cartToggle.addEventListener('click',()=>{
      cartPanel.classList.toggle('open');
    });
  }
  if(closeCart){
    closeCart.addEventListener('click',()=>cartPanel.classList.remove('open'));
  }
  if(cartPanel){
    cartPanel.addEventListener('click',e=>{
      if(e.target===cartPanel) cartPanel.classList.remove('open');
    });
  }
  updateOmakasePrefs();
  updateDragonPrefs();
  updateCart();
  toggleAddress();
  updateTodayBadge();

});

function toggleToday(){
  const panel=document.getElementById('todayOrders');
  panel.classList.toggle('visible');
  const open = panel.classList.contains('visible');
  document.body.classList.toggle('today-open', open);
  if(open){
    fetchOrders();
    newOrderCount = 0;
    hasNewOrder = false;
    updateTabTitle();
  }
  updateTodayBadge();
}


function showTodayOrders(){
  const panel=document.getElementById('todayOrders');
  if(!panel.classList.contains('visible')){
    panel.classList.add('visible');
    document.body.classList.add('today-open');
    fetchOrders();
  }
}

function toggleAddress(){
  const delivery=document.getElementById('typeDelivery').checked;
  document.getElementById('pickupFields').classList.toggle('hidden',delivery);
  document.getElementById('deliveryFields').classList.toggle('hidden',!delivery);
  document.getElementById('pickup_time').required=!delivery?true:false;
  document.getElementById('pickupPayment').required=!delivery?true:false;
  document.getElementById('postcode').required=delivery;
  document.getElementById('houseNumber').required=delivery;
  document.getElementById('deliveryPayment').required=delivery;
  if(!delivery){
    populateTimeOptions('pickup_time',30);
    document.getElementById('qrCodeContainer').classList.add('hidden');
  } else {
    populateTimeOptions('delivery_time',45);
    updateQRCode();
  }
  updateCart();
}
async function fetchAddress() {
  const pc = document.getElementById('postcode').value.trim();
  const num = document.getElementById('houseNumber').value.trim();
  if (!pc || !num) return;

  const url = `https://flask-order-api.onrender.com/api/postcode?postcode=${encodeURIComponent(pc)}&number=${encodeURIComponent(num)}`;
  try {
    const res = await fetch(url);
    if (res.ok) {
      const d = await res.json();
      if (d.street) document.getElementById('street').value = d.street;
      if (d.city) document.getElementById('city').value = d.city;
      updateQRCode();  // 成功后更新二维码
    } else {
      console.warn('API error:', res.status);
    }
  } catch (e) {
    console.warn('Adres ophalen mislukt', e);
  }
}


function updateQRCode(){
  const street=document.getElementById('street').value.trim();
  const house=document.getElementById('houseNumber').value.trim();
  const pc=document.getElementById('postcode').value.trim();
  const city=document.getElementById('city').value.trim();
  const container=document.getElementById('qrCodeContainer');
  const img=document.getElementById('qrCodePreview');
  const linkContainer=document.getElementById('mapsLinkContainer');
  if(street && house && pc && city){
    const address=`${street} ${house}, ${pc} ${city}`;
    const googleMapsLink=`https://www.google.com/maps?q=${encodeURIComponent(address)}`;
    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(googleMapsLink)}`;

    img.src=qrCodeUrl;
    linkContainer.innerHTML=`<a href="${googleMapsLink}" target="_blank" style="color: var(--accent-color); text-decoration: underline;">Open in Google Maps</a>`;
    container.classList.remove('hidden');
  }else{
    img.src='';
    linkContainer.innerHTML='';
    container.classList.add('hidden');
  }
}

function clearForm(){
  // 🟢 Ensure checkout fields are enabled for a new order
  document.querySelectorAll('#customer-info input, #customer-info select, #customer-info textarea')
    .forEach(el => { el.disabled = false; });

  ['custName','custPhone','pickup_time','delivery_time','postcode','houseNumber','street','city'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = '';
  });

  ['pickupPayment','deliveryPayment','chopstickCount','soyCount','gemberCount','wasabiCount'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.value = el.options[0].value;
  });

  document.getElementById('remark').value = '';

  // ✅ 清空打折类型和金额
  document.getElementById('discountType').value = 'amount';
  document.getElementById('discountValue').value = '';

  document.querySelectorAll('.product-list select').forEach(sel => { sel.selectedIndex = 0; });

  for (const k in cart) delete cart[k];
  updateCart();
  toggleAddress();
  const nameInput = document.getElementById('custName');
  if (nameInput) nameInput.focus();
}



function generateOrderNumber() {
  const now = new Date();
  const date = now.toISOString().slice(0,10).replace(/-/g, '');
  let rand = Math.random().toString(36).substring(2, 6).toUpperCase();

  // 判断是否 Z.S.M.
  const delivery = document.getElementById('typeDelivery').checked;
  const tijdslot = delivery ? document.getElementById('delivery_time').value
                            : document.getElementById('pickup_time').value;
  const raw = String(tijdslot || '').toLowerCase().replace(/\./g, '').trim();
  const isZsm = !raw || raw === 'zsm' || raw === 'asap';

  // 如果是 ZSM，最后一个字母设为 Z，否则避免以 Z 结尾
  if (isZsm) {
    rand = rand.slice(0, 3) + 'Z';
  } else if (rand.endsWith('Z')) {
    rand = rand.slice(0, 3) + 'X';
  }

  return `NV${date}-${rand}`;
}

function isCashMethod(v) {
  const m = String(v || '').toLowerCase();
  return m === 'cash' || m === 'contant';
}

// 放到父页全局
const euroFmtPOS = new Intl.NumberFormat('nl-NL', { style:'currency', currency:'EUR' });
const r05POS = v => Math.round(v*20)/20;
const parseEuro = v => (typeof v === 'number') ? v :
  (Number.parseFloat(String(v).replace(/[^\d,.-]/g,'').replace(',', '.')) || 0);

function openWisselAwaitPOS(total) {
  return new Promise((resolve) => {
    const dlg = document.getElementById('wissel-modal-pos');
    if (!dlg) return resolve(null);

    const euroFmtPOS = new Intl.NumberFormat('nl-NL', { style:'currency', currency:'EUR' });
    const r05POS = v => Math.round(v*20)/20;
    const parseEuro = v => (typeof v === 'number')
      ? v : (parseFloat(String(v).replace(/[^\d,.-]/g,'').replace(',', '.')) || 0);

    const due = r05POS(parseEuro(total));
    const paid     = document.getElementById('pos-wissel-paid');
    const dueEl    = document.getElementById('pos-wissel-due');
    const changeEl = document.getElementById('pos-wissel-change');
    const denomsEl = document.getElementById('pos-wissel-denoms');
    const exactBtn = document.getElementById('pos-wissel-exact');
    const closeBtn = document.getElementById('pos-wissel-close');
    const pinBtn   = document.getElementById('pos-wissel-pin');
    const okBtn    = document.getElementById('pos-wissel-ok');
    const quickBox = dlg.querySelector('.quick');

    // 初始化
    dueEl.textContent = euroFmtPOS.format(due);
    paid.value = '';
    changeEl.textContent = euroFmtPOS.format(0);
    denomsEl.innerHTML = '';

    const recompute = () => {
      const p = r05POS(parseEuro(paid.value));
      const diff = r05POS(due - p);
      const c = diff < 0 ? r05POS(p - due) : 0;

      changeEl.classList.remove('positive','negative','exact');
      if (diff > 0) {
        changeEl.textContent = `Nog ${euroFmtPOS.format(diff)}`;
        changeEl.classList.add('negative');
        denomsEl.innerHTML = '';
      } else if (Math.abs(diff) < 1e-9) {
        changeEl.textContent = 'Exact';
        changeEl.classList.add('exact');
        denomsEl.innerHTML = '';
      } else {
        changeEl.textContent = `Wisselgeld ${euroFmtPOS.format(c)}`;
        changeEl.classList.add('positive');
      }
    };

    const finish = (confirmed) => {
      const p = r05POS(parseEuro(paid.value));
      const c = Math.max(0, r05POS(p - due));
      const diff = r05POS(due - p);

      cleanup();
      try { dlg.close(); } catch {}

      resolve({
        confirmed,            // ⬅️ true=Bevestigen / false=Sluiten
        method: 'cash',
        paid: p,
        change: c,
        due,
        status: diff > 0 ? 'underpaid' : (Math.abs(diff) < 1e-9 ? 'exact' : 'change'),
        underpaidBy: diff > 0 ? diff : 0
      });
    };

    const onBackdrop = e => { if (e.target === dlg) finish(false); };
    const onExact    = () => { paid.value = due.toFixed(2); recompute(); };
    const onOk       = () => finish(true);   // ⬅️ 确认键 → confirmed:true
    const onClose    = () => finish(false);  // ⬅️ Sluiten → confirmed:false
    const onKey      = (e) => {
      if (e.key==='Escape') finish(false);   // ⬅️ Esc → confirmed:false
    };
    const onPin      = () => {
      cleanup();
      try { dlg.close(); } catch {}
      resolve({ method:'pin', remaining: Math.max(0, r05POS(due - parseEuro(paid.value))) });
    };

    function cleanup() {
      paid.removeEventListener('input', recompute);
      dlg.removeEventListener('click', onBackdrop);
      exactBtn?.removeEventListener('click', onExact);
      closeBtn?.removeEventListener('click', onClose);
      okBtn?.removeEventListener('click', onOk);
      pinBtn?.removeEventListener('click', onPin);
      quickBox?.removeEventListener('click', onQuick);
      window.removeEventListener('keydown', onKey);
    }

    const onQuick = (e) => {
      const btn = e.target.closest('[data-add]');
      if (!btn) return;
      const inc = Number(btn.dataset.add) || 0;
      paid.value = r05POS(parseEuro(paid.value) + inc).toFixed(2);
      recompute();
    };

    paid.addEventListener('input', recompute);
    dlg.addEventListener('click', onBackdrop);
    exactBtn?.addEventListener('click', onExact);
    closeBtn?.addEventListener('click', onClose);
    okBtn?.addEventListener('click', onOk);
    pinBtn?.addEventListener('click', onPin);
    quickBox?.addEventListener('click', onQuick);
    window.addEventListener('keydown', onKey);

    dlg.showModal();
    paid.focus({ preventScroll:true });
  });
}



// 用你在 Render 上的后端地址
const API_BASE = 'https://flask-order-api.onrender.com';




function openPinModal(total, orderId) {
  return new Promise((resolve) => {
    const dlg = document.getElementById('pin-modal-pos');
    if (!dlg) return resolve({ later: true });

    const due = r05POS(parseEuro(total));
    const dueEl    = document.getElementById('pin-due');
    const statusEl = document.getElementById('pin-status');
    const sendBtn  = document.getElementById('pin-send');
    const laterBtn = document.getElementById('pin-later');
    const cashBtn  = document.getElementById('pin-to-cash');

    dueEl.textContent = euroFmtPOS.format(due);
    statusEl.textContent = '';

    // 每次打开都先解禁
    sendBtn.disabled = false;

    function cleanup(result) {
      sendBtn.disabled = false;
      sendBtn.removeEventListener('click', onSend);
      laterBtn.removeEventListener('click', onLater);
      cashBtn.removeEventListener('click', onCash);
      socket.off('payment_status', onStatus);
      statusEl.textContent = '';
      try { dlg.close(); } catch {}
      resolve(result);
    }

    function finishLater() {
      cleanup({ later: true });
    }

    function onStatus(data) {
      const oid = String(data?.payment_ordernumber || data?.order_id || '');
      const st  = String(data?.payment_status || data?.status || '').toLowerCase();
      if (oid !== String(orderId)) return;
      if (st === 'paid') {
        handlePaymentUpdate({ payment_ordernumber: oid, payment_status: 'paid', payment_id: data?.payment_id });
        cleanup('paid');
      } else if (['failed','canceled','expired'].includes(st)) {
        handlePaymentUpdate({ payment_ordernumber: oid, payment_status: 'unfinished', payment_id: data?.payment_id, error: st });
        statusEl.textContent = `PIN ${st}. Probeer opnieuw of kies een andere methode.`;
        sendBtn.disabled = false;
        socket.off('payment_status', onStatus);
      } else {
        handlePaymentUpdate({ payment_ordernumber: oid, payment_status: st, payment_id: data?.payment_id });
      }
    }

    async function onSend() {
      sendBtn.disabled = true;
      statusEl.textContent = 'Waiting for PIN result… (cancel/retry available)';
      const amountStr = Number(due).toFixed(2);
      try {
        const r = await fetch(`${API_BASE}/api/create_mollie_pin_payment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_number: orderId, amount: amountStr }) // ← 用 order_number
        });
        let data = {}; try { data = await r.json(); } catch {}
        if (!r.ok || data.ok === false) {
          showToast('PIN betaling mislukt' + (data?.error ? `: ${data.error}` : ''));
          sendBtn.disabled = false;
          statusEl.textContent = '';
          return;
        }
        const pid = data.payment_id || data.id;
        const card = document.querySelector(`.order-card[data-order-number="${orderId}"]`);
        if (card && pid) card.dataset.paymentId = pid;
        handlePaymentUpdate({ payment_ordernumber: orderId, payment_status: 'awaiting_pin_result', payment_id: pid });
        showToast('Naar terminal gestuurd…');
        window.api?.beep?.();
        socket.on('payment_status', onStatus);
      } catch (e) {
        showToast('PIN netwerkfout');
        sendBtn.disabled = false;
        statusEl.textContent = '';
      }
    }

    function onLater() { finishLater(); }
    function onCash()  { cleanup('cash'); }

    sendBtn.addEventListener('click', onSend);
    laterBtn.addEventListener('click', onLater);
    cashBtn.addEventListener('click', onCash);

    // 关闭/ESC/点击背景 → 当成 later
    dlg.addEventListener('cancel', (e) => { e.preventDefault(); finishLater(); });
    dlg.addEventListener('click', (e) => { if (e.target === dlg) finishLater(); });

    dlg.showModal();
  });
}



async function openCheckout(btn) {
  const wrapper = btn.closest('.order-card-wrapper');
  const card = wrapper ? wrapper.querySelector('.order-card') : null;
  if (!card) return;

  let order = {};
  try { order = JSON.parse(card.dataset.order || '{}'); } catch {}
  const id  = order.id || card.dataset.id || btn.dataset.orderId;
  const businessNo =
    order.order_number ||
    card.dataset.order ||  
    card.dataset.orderNumber ||
    null;

  let due = Number(btn.dataset.total || order.totaal || order.total || 0);
  let method = String(order.payment_method || '').toLowerCase();

  while (true) {
    if (isCashMethod(method)) {
      // === 现金流程 ===
      order.payment_method  = 'cash';
      order.status          = 'pending';
      order.payment_status  = 'pending';

      // UI 先显示 pending
      const statusEl = card.querySelector('.order-status');
      if (statusEl) statusEl.textContent = order.status;

      // 打开现金弹窗
      const res = await openWisselAwaitPOS(due);

      if (res && res.method === 'pin') { 
        method = 'pin'; 
        due = res.remaining; 
        continue; 
      }
      if (!res) {
        console.log("[POS] 现金订单取消/关闭:", id);
        return; // 不入库，不改 paid
      }

      if (res.confirmed) {
        order.status         = 'paid';
        order.payment_status = 'paid';
        console.log("[POS] 收银员确认现金已支付:", id);
      } else {
        order.status         = 'pending';
        order.payment_status = 'pending';
        console.log("[POS] 现金订单入库 pending (Sluiten):", id);
      }
      break;

    } else {
      // === PIN 流程 ===
      order.payment_method = 'pin';
      order.status         = 'awaiting_pin_result';
      order.payment_status = 'pending';

      const res = await openPinModal(due, businessNo || id);

      if (res === 'cash') {
        method = 'cash';
        continue;
      }

      if ((res && res.later) || res == null) {
        order.status         = 'pending';
        order.payment_status = 'pending';
        console.log("[POS] PIN later betalen → pending 入库:", id);
        break;
      }

      if (res === 'paid') {
        order.status         = 'paid';
        order.payment_status = 'paid';
        console.log("[POS] PIN 已支付:", id);
      }
      break;
    }
  }

  // === 本地 UI 同步 ===
  card.dataset.order = JSON.stringify(order);

  const pmEl = card.querySelector('.payment-method');
  if (pmEl) pmEl.textContent = order.payment_method;

  const statusEl = card.querySelector('.order-status');
  if (statusEl) statusEl.textContent = order.status;

  // === 可选：推送到本地存储/后端 ===
  if (id) {
    try {
      await window.pos?.updateOrderById?.(id, { 
        payment_method: order.payment_method, 
        status: order.status, 
        payment_status: order.payment_status 
      });
    } catch (err) {
      console.warn('local update failed', err);
    }
  }
}


async function finalizeOrder(payload) {
  try {
    const r = await fetch('https://flask-order-api.onrender.com/submit_order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const res = await r.json();
    if (res.success || res.status === 'ok') {
      showToast('Bestelling succesvol verzonden! Bestelnummer: ' + payload.order_number);
      clearForm();
      fetchOrders();
    } else {
      showToast('Er is een fout opgetreden bij het verzenden van uw bestelling. Probeer het opnieuw.');
    }
  } catch (err) {
    showToast('Verzendfout – server niet bereikbaar.');
  }
}

async function submitOrder() {
  const name = document.getElementById('custName').value.trim() || 'Guest';
  const phone = document.getElementById('custPhone').value.trim();
  const delivery = document.getElementById('typeDelivery').checked;

  if (Object.keys(cart).length === 0) {
    alert('Geen producten geselecteerd.');
    return;
  }

  const remark = document.getElementById('remark').value.trim();

  let orderText = Object.entries(cart).map(([name, item]) => {
    let line = `${name} x ${item.qty} (€${(item.qty * item.price).toFixed(2)})`;
    if (item.prefs) {
      const pref = item.prefs.map((p,i)=>`${i+1}. ${p}`).join(' | ');
      line += ` [${pref}]`;
    }
    return line;
  }).join(', ');
  Object.keys(extras).forEach(id => {
    const qty = parseInt(document.getElementById(id).value || 0);
    if (qty > 0) orderText += `, ${extras[id].label} x ${qty}`;
  });
  if (remark) orderText += `, Opmerking: ${remark}`;

  const itemsToSend = { ...cart };
  Object.keys(extras).forEach(id => {
    const qty = parseInt(document.getElementById(id).value || 0);
    if (qty > 0) itemsToSend[extras[id].label] = { price: 0, qty };
  });

  const orderNumber = generateOrderNumber();

  // ✅ 结算汇总
  const subtotal = Object.values(cart).reduce((sum, item) => sum + item.price * item.qty, 0);
  const packagingTotal = Object.values(cart).reduce((sum, item) => sum + (item.packaging || 0) * item.qty, 0);
  const statiegeldTotal = Object.values(cart).reduce((sum, item) => sum + (item.statiegeld || 0) * item.qty, 0);
  const deliveryCost = delivery ? 2.5 : 0;
  const discountType = document.getElementById('discountType').value;
  const discountVal = parseFloat(document.getElementById('discountValue').value) || 0;
  let discount = 0;
  if (discountType === 'amount') discount = Math.min(discountVal, subtotal);
  else if (discountType === 'percent') discount = Math.min(100, discountVal) / 100 * subtotal;

  const totalBeforeBtw = subtotal + packagingTotal + statiegeldTotal + deliveryCost - discount;
  const heinekenTotal = Object.entries(cart).reduce((sum,[k,v])=>{
    const name = v.displayName || k;
    return sum + (/heineken/i.test(name) ? v.price * v.qty : 0);
  },0);
  const rate9 = 0.09;
  const rate21 = 0.21;
  const btw9 = (subtotal + packagingTotal + deliveryCost - discount - heinekenTotal) * rate9 / (1 + rate9);
  const btw21 = heinekenTotal * rate21 / (1 + rate21);
  const btw = btw9 + btw21;
  const totalGross = totalBeforeBtw; // ← 含税总额（真正应收）

  const summary = {
    subtotal: parseFloat(subtotal.toFixed(2)),
    packaging: parseFloat(packagingTotal.toFixed(2)),
    delivery: parseFloat(deliveryCost.toFixed(2)),
    discountType,
    discountValue: parseFloat(discountVal.toFixed(2)),
    discountAmount: parseFloat(discount.toFixed(2)),
    btw: parseFloat(btw.toFixed(2)),
    btw_9: parseFloat(btw9.toFixed(2)),
    btw_21: parseFloat(btw21.toFixed(2)),
    btw_total: parseFloat(btw.toFixed(2)),
    btw_split: { '9': btw9.toFixed(2), '21': btw21.toFixed(2) },
    total: parseFloat(totalBeforeBtw.toFixed(2)), total_gross: parseFloat(totalGross.toFixed(2)) };

  if (statiegeldTotal > 0) summary.statiegeld = parseFloat(statiegeldTotal.toFixed(2));


  const orderType = delivery ? 'bezorgen' : 'afhalen';
  const pickupSel = document.getElementById('pickup_time').value;
  const deliverySel = document.getElementById('delivery_time').value;
  const tijdslotDisplay = delivery ? deliverySel : pickupSel;
  const raw = String(tijdslotDisplay || '').toLowerCase().replace(/\./g, '').trim();
  const isZsm = !raw || raw === 'zsm' || raw === 'asap';
  const pickupVal = !delivery && isZsm ? getAsapTime() : pickupSel;
  const deliveryVal = delivery && isZsm ? getAsapTime() : deliverySel;

  let paymentMethod = delivery
      ? document.getElementById('deliveryPayment').value
      : document.getElementById('pickupPayment').value;

  const payload = {
  orderType,
  name,
  phone,
  email: '',
  customerEmail: '',
  pickup_time: !delivery ? pickupVal : '',
  delivery_time: delivery ? deliveryVal : '',
  tijdslot_display: tijdslotDisplay,
  is_zsm: isZsm,
  paymentMethod,
  postcode: delivery ? document.getElementById('postcode').value.trim() : '',
  house_number: delivery ? document.getElementById('houseNumber').value.trim() : '',
  street: delivery ? document.getElementById('street').value.trim() : '',
  city: delivery ? document.getElementById('city').value.trim() : '',
  order_number: orderNumber,
  items: itemsToSend,
  message: orderText,
  opmerking: remark,

  // ✅ 与卡片一致：含税应收
  totaal: totalGross.toFixed(2),

  source: 'pos',
  summary
};


  if (statiegeldTotal > 0) {
    payload.statiegeld = parseFloat(statiegeldTotal.toFixed(2));
  }

  if (discount > 0) {
    payload.discountCode = 'KASSA';
    payload.discountAmount = parseFloat(discount.toFixed(2));
  }

 /* 支付处理：支持在现金、PIN、oprekening 间切换 */
let due = Number(payload.totaal) || parseEuro(payload.totaal) || 0;
let method = String(paymentMethod || '').toLowerCase();

while (true) {
  // === 1) OPREKENING：直接入库为 pending ===
  if (method === 'oprekening') {
    payload.payment_method = 'oprekening';
    payload.paymentMethod  = 'oprekening';
    payload.status         = 'pending';
    payload.payment_status = 'pending';
    console.log('[POS] OPREKENING → pending 入库:', payload.order_number);
    await finalizeOrder(payload);
    return;
  }

  // === 2) PIN：送终端；later=入库pending；成功由 webhook 回调 ===
  if (method === 'pin') {
    payload.payment_method = 'pin';
    payload.paymentMethod  = 'pin';
    payload.status         = 'awaiting_pin_result';
    payload.payment_status = 'pending';
    pendingPinOrders[orderNumber] = { payload, due };

    const res = await openPinModal(due, orderNumber);

    if (res === 'cash') {
      delete pendingPinOrders[orderNumber];
      method = 'cash';
      continue; // 进入现金分支
    }

    if ((res && res.later) || res == null) {
      delete pendingPinOrders[orderNumber];
      payload.status         = 'pending';
      payload.payment_status = 'pending';
      console.log('[POS] PIN later → pending 入库:', payload.order_number);
      await finalizeOrder(payload);
      return;
    }

    // 成功与失败都由 onStatus/webhook 驱动 UI 更新
    return;
  }

  // === 3) CASH：Bevestigen=paid；Sluiten=pending 入库 ===
  if (isCashMethod(method)) {
    payload.payment_method = 'cash';
    payload.paymentMethod  = 'cash';
    payload.status         = 'pending';
    payload.payment_status = 'pending';
    console.log('[POS] 新现金订单(待确认):', payload.order_number);

    const w = await openWisselAwaitPOS(due);
    if (!w) { // 真异常也先入库 pending
      await finalizeOrder(payload);
      return;
    }

    if (w.method === 'pin') { // 弹窗中切换到 PIN
      method = 'pin';
      due = w.remaining;
      continue;
    }

    if (w.confirmed !== true) {
      console.log('[POS] 现金未确认，pending 入库:', payload.order_number);
      await finalizeOrder(payload);
      return;
    }

    // 收银员确认现金已收
    payload._wissel        = w;
    payload._paid          = true;
    payload.status         = 'paid';
    payload.payment_status = 'paid';
    console.log('[POS] 现金已确认 paid:', payload.order_number);
    await finalizeOrder(payload);
    return;
  }

  // === 兜底：未知方式，按 pending 入库，避免误记 paid ===
  console.warn('[POS] 未识别支付方式，按 pending 入库:', method);
  payload.payment_method = method;
  payload.paymentMethod  = method;
  payload.status         = 'pending';
  payload.payment_status = 'pending';
  await finalizeOrder(payload);
  return;
}

}




  // ✅ 提交到远程 Flask Render 后端

  function pad(num){
    return num.toString().padStart(2,'0');
  }

  function getAsapTime(){
    const d=new Date();
    d.setMinutes(d.getMinutes()+30);
    return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function populateTimeOptions(selectId,offsetMinutes){
    const select=document.getElementById(selectId);
    if(!select) return;
    select.innerHTML='';
    const asap=document.createElement('option');
    asap.value='Z.S.M.';
    asap.textContent='Z.S.M.';
    select.appendChild(asap);
    const now=new Date();
    now.setMinutes(now.getMinutes()+offsetMinutes);

    const open=new Date();
    open.setHours(12,0,0,0);
    const close=new Date();
    close.setHours(23,59,0,0);

    let start=now>open?now:open;
    start=new Date(start);
    start.setMinutes(Math.ceil(start.getMinutes()/15)*15,0,0);

    for(let t=start;t<=close;t.setMinutes(t.getMinutes()+15)){
      const hh=pad(t.getHours());
      const mm=pad(t.getMinutes());
      const timeStr=`${hh}:${mm}`;
      const opt=document.createElement('option');
      opt.value=timeStr;
      opt.textContent=timeStr;
      select.appendChild(opt);
    }
  }


</script>

<script>
function formatCurrency(value){
  if (typeof value === 'string') {
    value = value.replace('€', '').replace(',', '.').trim();
  }
  const num = parseFloat(value);
  return isNaN(num) ? "€0.00" : `€${num.toFixed(2)}`;
}
</script>

  
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  // 全局单例：只初始化一次
  (function () {
    const BASE =
      (typeof API_BASE !== 'undefined' && API_BASE) 
        ? API_BASE 
        : 'https://flask-order-api.onrender.com';

    if (!window.__socket) {
      window.__socket = io(BASE, { transports: ['websocket'] });
      window.__socket.on('connect', () =>
        console.log('✅ Socket verbonden:', window.__socket.id)
      );
      window.__socket.on('connect_error', (e) =>
        console.warn('socket connect_error:', e?.message || e)
      );
    }

    // 提供一个安全的 getter
    window.getSocket = () => window.__socket;
  })();
</script>

<!-- 任意页面/任意脚本里这样用，不再重复定义 const socket -->
<script>
  const socket = getSocket();

  // 监听支付事件
  socket.on('payment_status', (p) => {
    console.log('📩 payment_status:', p);
    const key = p.payment_ordernumber || p.payment_id;
    if (!key) return;

    const card = document.querySelector(`.order-card[data-order-number="${key}"]`)
             || (p.payment_id && document.querySelector(`.order-card[data-payment-id="${p.payment_id}"]`));
    if (card) {
      card.dataset.paymentStatus = p.payment_status;
      if (p.payment_id) card.dataset.paymentId = p.payment_id;
      const badge = card.querySelector('.payment-badge');
      if (badge) badge.textContent = p.payment_status.toUpperCase();
    } else {
      console.warn('未找到订单卡片，可能 metadata 缺失', p);
    }
  });

  // 你的其它函数照常存在，不受影响
  function applyMenuPrices(items) {
    const map = {};
    items.forEach(i => { map[i.name] = i.price; });
    document.querySelectorAll('.menu-item').forEach(el => {
      const name = el.dataset.name;
      if (name && map[name] !== undefined) {
        const p = Number(map[name]) || 0;
        el.dataset.price = p;
        const pe = el.querySelector('p');
        if (pe) pe.textContent = `€${p.toFixed(2)}`;
      }
    });
  }



  function populateBubbleSelectors(){
    const baseSel=document.getElementById('bubbleType');
    const flavorSel=document.getElementById('bubbleFlavor');
    const toppingSel=document.getElementById('bubbleTopping');
    const curBase=baseSel.value,curFlavor=flavorSel.value,curTopping=toppingSel.value;
    baseSel.innerHTML='<option value="">Base</option>';
    bubbleOptions.base.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curBase) opt.selected=true;baseSel.appendChild(opt);});
    flavorSel.innerHTML='<option value="">Smaak</option>';
    bubbleOptions.smaak.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curFlavor) opt.selected=true;flavorSel.appendChild(opt);});
    toppingSel.innerHTML='<option value="">Topping</option>';
    bubbleOptions.topping.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curTopping) opt.selected=true;toppingSel.appendChild(opt);});
  }

  function populateXbentoSelectors(){
    const mainSel=document.getElementById('xBentoMain');
    const sideSel=document.getElementById('xBentoSide');
    const riceSel=document.getElementById('xBentoRice');
    const vegSel=document.getElementById('xBentoVeg');
    const curMain=mainSel.value,curSide=sideSel.value,curRice=riceSel.value,curVeg=vegSel.value;
    mainSel.innerHTML='<option value="">Hoofdgerecht</option>';
    xbentoOptions.main.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curMain) opt.selected=true;mainSel.appendChild(opt);});
    sideSel.innerHTML='<option value="">Bijgerecht</option>';
    xbentoOptions.side.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curSide) opt.selected=true;sideSel.appendChild(opt);});
    riceSel.innerHTML='<option value="">Rijstsoort</option>';
    xbentoOptions.rice.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curRice) opt.selected=true;riceSel.appendChild(opt);});
    vegSel.innerHTML='<option value="">Groente</option>';
    xbentoOptions.groente.forEach(o=>{const opt=document.createElement('option');opt.value=o.name;opt.textContent=o.name;if(o.name===curVeg) opt.selected=true;vegSel.appendChild(opt);});
  }

  function updateBubbleCartPrices(){
    Object.entries(cart).forEach(([name,item])=>{
      const m=name.match(/^Bubble Tea \(([^,]+), ([^,]+), ([^)]+)\)$/);
      if(!m) return;
      const price=getOptionPrice('base',m[1])+getOptionPrice('smaak',m[2])+getOptionPrice('topping',m[3]);
      item.price=price;
    });
    updateCart();
  }

  function updateXbentoCartPrices(){
    Object.entries(cart).forEach(([name,item])=>{
      const m=name.match(/^Xbento \(([^,]+), ([^,]+), ([^,]+), ([^)]+)\)$/);
      if(!m) return;
      const price=getXbentoOptionPrice('main',m[1])+getXbentoOptionPrice('side',m[2])+getXbentoOptionPrice('rice',m[3])+getXbentoOptionPrice('groente',m[4]);
      item.price=price;
    });
    updateCart();
  }

  function fetchBubbleOptions(){
    fetch('/api/bubble_options').then(r=>r.json()).then(data=>{
      bubbleOptions=data;
      populateBubbleSelectors();
      updateMilkTeaDisplay();
      updateBubbleCartPrices();
    });
  }

  function fetchXbentoOptions(){
    fetch('/api/xbento_options').then(r=>r.json()).then(data=>{
      xbentoOptions=data;
      populateXbentoSelectors();
      updateXbentoDisplay();
      updateXbentoCartPrices();
    });
  }
  async function loadMenu(){
    const r=await fetch('/api/menu');
    if(r.ok){ const d=await r.json(); applyMenuPrices(d); }
  }
  loadMenu();
  fetch('/api/settings').then(r=>r.json()).then(s=>{
    if(s.milktea_price){ milkTeaPrice=parseFloat(s.milktea_price); updateMilkTeaDisplay(); }
    applyCrispyPrices(s);
  });
  fetchBubbleOptions();
  fetchXbentoOptions();
  socket.on('menu_update', applyMenuPrices);
  socket.on('milktea_price_update', data => {
    milkTeaPrice = parseFloat(data.price || data);
    updateMilkTeaDisplay();
  });
  socket.on('bubble_options_update', data => {
    bubbleOptions=data;
    populateBubbleSelectors();
    updateMilkTeaDisplay();
    updateBubbleCartPrices();
  });
  socket.on('xbento_options_update', data => {
    xbentoOptions=data;
    populateXbentoSelectors();
    updateXbentoDisplay();
    updateXbentoCartPrices();
  });
  socket.on('crispy_price_update', data => {
    applyCrispyPrices(data);
  });

  
  // 可选：去重集合，避免重复事件反复更新/弹 toast
const _seenPaymentEvents = new Set();
// 待回传的 PIN 订单缓存：{ order_id: { payload, due } }
const pendingPinOrders = {};

async function handlePaymentUpdate(data) {
  if (!data) return;

  // ✅ 兼容新老字段：优先用 payment_ordernumber / payment_status
  const order_id_raw   = data.payment_ordernumber ?? data.order_id ?? '';
  const order_id       = String(order_id_raw || '');
  let payment_status   = String((data.payment_status ?? data.status ?? '')).toLowerCase();
  const payment_method = data.payment_method || 'pin';
  const payment_id     = data.payment_id;

  // 统一状态别名
  if (payment_status === 'approved') {
    payment_status = 'paid';
  } else if (['declined','canceled','timeout','failed','expired'].includes(payment_status)) {
    data.error = payment_status;
    payment_status = 'unfinished';
  } else if (['pending','open'].includes(payment_status)) {
    payment_status = 'awaiting_pin_result';
  }

  if (!order_id) return;

  // 去重：同一订单 + 同一状态，只处理一次（通常只对 paid 做去重就够）
  if (payment_status === 'paid') {
    const dedupeKey = `${order_id}:${payment_status}`;
    if (_seenPaymentEvents.has(dedupeKey)) return;
    _seenPaymentEvents.add(dedupeKey);
  }

  // 命中“待回传”缓存
  const pending = pendingPinOrders[order_id];
  if (pending) {
    if (payment_status === 'paid') {
      // ✅ 不覆盖业务流 status，写入 payment_status 更安全
      pending.payload.payment_status = 'paid';
      await finalizeOrder(pending.payload);
      delete pendingPinOrders[order_id];
      showToast(`Order ${order_id} PIN betaling geslaagd`);
    } else if (payment_status === 'unfinished') {
      pending.payload.payment_status = 'unfinished';
      showToast(`Order ${order_id} PIN betaling ${data.error || 'mislukt'}`);
    } else if (payment_status === 'awaiting_pin_result') {
      pending.payload.payment_status = 'awaiting_pin_result';
      showToast(`Order ${order_id} PIN betaling in behandeling`);
    }
  }

  // 遍历订单卡片并更新 UI
  document.querySelectorAll('.order-card').forEach(card => {
    let cardOrder = {};
    try { cardOrder = JSON.parse(card.dataset.order || '{}'); } catch {}

    // 多来源取订单号（保持原有容错）
    const cardOrderId = String(
      cardOrder.id ??
      card.dataset.id ??
      card.dataset.orderNumber ??
      ''
    );
    if (cardOrderId !== order_id) return;

    // ✅ 建议：只写 payment_status，不覆盖业务 status
    cardOrder.payment_method = payment_method;
    if (payment_status) cardOrder.payment_status = payment_status;
    if (payment_id) {
      cardOrder.payment_id = payment_id;
      card.dataset.paymentId = payment_id;
    }
    card.dataset.order = JSON.stringify(cardOrder);

    // 文案
    const pmEl = card.querySelector('.payment-method');
    if (pmEl) {
      let txt = payment_method || '';
      if (payment_status === 'paid')                    txt += ' (betaald)';
      else if (payment_status === 'unfinished')         txt += ` (${data.error || 'mislukt'})`;
      else if (payment_status === 'awaiting_pin_result')txt += ' (in behandeling)';
      pmEl.textContent = txt.trim();
    }

    // 状态徽章/样式（若你已有业务 status 样式，可保留；这里根据支付状态更新）
    const statusEl = card.querySelector('.order-status');
    if (statusEl && payment_status) {
      statusEl.textContent = payment_status;
      statusEl.classList.remove('paid','unfinished','awaiting_pin_result','open','expired');
      statusEl.classList.add(payment_status);
    }

    // 桥接到现有 POS 更新函数（可选）
    if (cardOrder.id) {
      try { window.pos?.updateOrderById?.(cardOrder.id, { payment_method, payment_status }); } catch {}
    }

    // Toast
    if      (payment_status === 'paid')             showToast(`Order ${order_id} PIN betaling geslaagd`);
    else if (payment_status === 'unfinished')       showToast(`Order ${order_id} PIN betaling ${data.error || 'mislukt'}`);
    else if (payment_status === 'awaiting_pin_result') showToast(`Order ${order_id} PIN betaling in behandeling`);
  });
}

// 事件监听保持不变
socket.on('payment_status', handlePaymentUpdate);



  let pollTimer;
  const baseTitle = document.title;
  let newOrderCount = 0; // unseen orders for title
  let hasNewOrder = false;
  function updateTabTitle(){
    document.title = newOrderCount ? `${baseTitle} (${newOrderCount})` : baseTitle;
  }
  function getOrderCount(){
    const tbody = document.querySelector('.orders-panel tbody');
    return tbody ? tbody.children.length : 0;
  }
  function updateTodayBadge(){
    fetch('/pos/orders_today?json=1')
      .then(r => r.json())
      .then(data => {
        const count = Array.isArray(data) ? data.length : getOrderCount();
        document.querySelectorAll('.today-badge').forEach(badge => {
          badge.textContent = hasNewOrder ? 'New' : count;
        });
      })
      .catch(() => {
        const count = getOrderCount();
        document.querySelectorAll('.today-badge').forEach(badge => {
          badge.textContent = hasNewOrder ? 'New' : count;
        });
      });
  }

  
  function parseTimeToMinutes(str){
    if(!str) return Infinity;
    const parts = str.split(':');
    const h = parseInt(parts[0],10);
    const m = parseInt(parts[1],10);
    if(isNaN(h) || isNaN(m)) return Infinity;
    return h*60+m;
  }

  function getSortKey(order){
    const isDelivery = ['delivery','bezorgen'].includes(order.order_type);
    const t = isDelivery ? (order.delivery_time || order.deliveryTime)
                         : (order.pickup_time || order.pickupTime);
    return parseTimeToMinutes(t);
  }

  function insertSorted(tbody, tr){
    const val = parseFloat(tr.dataset.sortKey);
    const rows = Array.from(tbody.querySelectorAll('tr'));
    for(const row of rows){
      if(parseFloat(row.dataset.sortKey) > val){
        tbody.insertBefore(tr, row);
        return;
      }
    }
    tbody.appendChild(tr);
  }





function orderComplete(btn) {
  const row = btn.closest('.order-card');
  const status = row ? row.querySelector('.notify') : null;
  const orderType = btn.dataset.type;

  const orderData = row ? JSON.parse(row.dataset.order || '{}') : {};

  const payload = {
    order_number: orderData.order_number || btn.dataset.number,
    name: orderData.customer_name || btn.dataset.name,
    phone: orderData.phone || btn.dataset.phone,
    email: orderData.email || btn.dataset.email,
    order_type: orderType,
    tijdslot: orderData.tijdslot || orderData.delivery_time || orderData.pickup_time || '',
    street: orderData.street || '',
    house_number: orderData.house_number || '',
    postcode: orderData.postcode || '',
    city: orderData.city || '',
    opmerking: orderData.opmerking || '',
    totaal: orderData.totaal || orderData.total || '',
    payment_method: orderData.payment_method || '',
    created_at: orderData.created_at || ''
  };

  // 👇 如果是配送订单，弹出配送员选择菜单
  if (orderType === 'bezorg' && deliveryPersons.length > 0) {
  openDeliveryModal(btn);
  return; // 等待确认回调后再 fetch
}


  fetch('https://flask-order-api.onrender.com/api/order_complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(r => {
    if(status) status.textContent = r.ok ? 'Notificatie verzonden' : 'Notificatie mislukt';
  }).catch(() => {
    if(status) status.textContent = 'Notificatie mislukt';
  });
}

function toggleComplete(btn) {
  const wrapper = btn.closest('.order-card-wrapper');
  const row = wrapper ? wrapper.querySelector('.order-card') : null;
  if (!row) return;

  const id = btn.dataset.id || row.dataset.id;
  const done = !row.classList.contains('completed');

  fetch(`/api/orders/${id}/status`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ is_completed: done })
  }).then(r => r.json()).then(() => {
    if (done) orderComplete(btn);
    row.classList.toggle('completed', done);
    const notify = wrapper.querySelector('.notify');
    let order = {};
try { order = JSON.parse(row.dataset.order || '{}'); } catch {}
order.is_completed = true;
order.is_cancelled = false;
row.dataset.order = JSON.stringify(order);

const mode = window.orderSortMode || 'service';
wrapper.dataset.sortKey = JSON.stringify(buildSortKeyByMode(order, mode));
const container = document.querySelector('.orders-cards');
if (container) reorderCards(container);
  });
}

let deliveryPersons = [];

fetch('/static/delivery_persons.json')
  .then(res => res.json())
  .then(data => {
    deliveryPersons = data;
  });

let currentDeliveryBtn = null;

function openDeliveryModal(btn) {
  currentDeliveryBtn = btn;
  const select = document.getElementById('deliverySelect');
  select.innerHTML = '';

  deliveryPersons.forEach(p => {
    const option = document.createElement('option');
    option.value = p.chat_id;
    option.textContent = p.name;
    select.appendChild(option);
  });

  const modal = document.getElementById('deliveryModal');
  if (typeof modal.showModal === 'function') {
    modal.showModal();
  } else {
    modal.setAttribute('open', '');
  }
}

function closeDeliveryModal() {
  const modal = document.getElementById('deliveryModal');
  if (typeof modal.close === 'function') {
    modal.close();
  } else {
    modal.removeAttribute('open');
    modal.style.display = 'none';
  }
  currentDeliveryBtn = null;
}

function confirmDeliveryPerson() {
  const select = document.getElementById('deliverySelect');
  const chatId = select.value;
  const person = deliveryPersons.find(p => p.chat_id == chatId);
  if (!person || !currentDeliveryBtn) return;

  const btn = currentDeliveryBtn;
  const row = btn.closest('.order-card');
  const status = row ? row.querySelector('.notify') : null;

  const orderData = row ? JSON.parse(row.dataset.order || '{}') : {};

  const payload = {
    order_number: orderData.order_number || btn.dataset.number,
    name: orderData.customer_name || btn.dataset.name,
    phone: orderData.phone || btn.dataset.phone,
    email: orderData.email || btn.dataset.email,
    order_type: btn.dataset.type,
    tijdslot: orderData.tijdslot || orderData.delivery_time || orderData.pickup_time || '',
    street: orderData.street || '',
    house_number: orderData.house_number || '',
    postcode: orderData.postcode || '',
    city: orderData.city || '',
    opmerking: orderData.opmerking || '',
    totaal: orderData.totaal || orderData.total || '',
    payment_method: orderData.payment_method || '',
    created_at: orderData.created_at || '',
    delivery_person: person.name,
    delivery_chat_id: person.chat_id
  };

  fetch('https://flask-order-api.onrender.com/api/order_complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(r => {
    if (status) status.textContent = r.ok ? 'Notificatie verzonden' : 'Notificatie mislukt';
  }).catch(() => {
    if (status) status.textContent = 'Notificatie mislukt';
  });

  closeDeliveryModal();
}

document.getElementById('confirmDelivery').addEventListener('click', confirmDeliveryPerson);





function orderCancelNotify(btn) {
  const row = btn.closest('.order-card') || btn.closest('tr');
  const status = row ? row.querySelector('.notify') : null;
  const payload = {
    order_number: btn.dataset.number,
    name: btn.dataset.name,
    phone: btn.dataset.phone,
    email: btn.dataset.email,
    order_type: btn.dataset.type
  };

  fetch('https://flask-order-api.onrender.com/api/order_cancelled', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(r => {
    if (status) status.textContent = r.ok ? '' : '';
  }).catch(() => {
    if (status) status.textContent = '';
  });
}
function toggleCancel(btn) {
  const wrapper = btn.closest('.order-card-wrapper');
  const row = wrapper ? wrapper.querySelector('.order-card') : null;
  if (!row) return;

  const id = btn.dataset.id || row.dataset.id;
  const cancelled = !row.classList.contains('cancelled');

  fetch(`/api/orders/${id}/status`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ is_cancelled: cancelled })
  }).then(r => r.json()).then(() => {
    if (cancelled) orderCancelNotify(btn);
    row.classList.toggle('cancelled', cancelled);
    const notify = wrapper.querySelector('.notify');
    
    // ★ 新增：更新排序所用的数据（data-order）
    let order = {};
    try { order = JSON.parse(row.dataset.order || '{}'); } catch {}
    order.is_cancelled = !!cancelled;
    if (cancelled) order.is_completed = false; // 取消与完成互斥
    row.dataset.order = JSON.stringify(order);

    // ★ 新增：按当前模式重算 sortKey 并重排
    const mode = window.orderSortMode || 'service';
    wrapper.dataset.sortKey = JSON.stringify(buildSortKeyByMode(order, mode));
    const container = document.querySelector('.orders-cards');
    if (container) reorderCards(container);

    // （可选）滚动到列表底部，方便看到它已被放到最后
    // container?.lastElementChild?.scrollIntoView({ behavior: 'smooth', block: 'end' });
  })
  .catch(err => {
    console.error('取消失败', err);
  });
}




async function fetchOrders() {
  try {
    const res = await fetch('/pos/orders_today?json=1', { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error('响应不是数组');

    // 先确保每个订单都有 status 字段
    data.forEach(o => {
      if (!o.status) o.status = o.payment_status || 'pending';
    });

    // 1) 渲染 UI
    const container = document.querySelector('.orders-cards');
    if (container) {
      container.innerHTML = '';
      data
        .slice()
        .sort((a, b) => getSortKey(a) - getSortKey(b))
        .forEach(order => addRow(order));
    }

    // 2) 同步到本地 SQLite（Electron 环境才执行）
    const upsertBatch = window?.electron?.ipcRenderer?.upsertBatch;
    if (typeof upsertBatch === 'function') {
      // 统一整理：保证 order_number / bron 存在
      const payload = data
        .filter(o => (o.order_number || o.orderNumber))     // 没有订单号的跳过
        .map(o => ({
          ...o,
          order_number: String(o.order_number || o.orderNumber).trim(),
          bron: (o.bron || o.source || 'pos')               // 兜底：没有就写 'pos'
        }));

      if (payload.length) {
        const stat = await upsertBatch(payload);
        // 可选：在页面弹个提示或写日志
        console.log(`[SQLite 同步] saved=${stat.saved}, skipped=${stat.skipped}`, stat.errors || []);
      } else {
        console.warn('[SQLite 同步] 无有效订单（缺少 order_number）');
      }
    } else {
      // 非 Electron 环境下不报错，静默跳过
      // console.debug('非 Electron 环境，跳过本地 SQLite 同步');
    }
  } catch (err) {
    console.error('订单拉取失败:', err);
    // TODO: 你也可以在这里给 UI 一个 toast 提示
  }
}


function parseItemsString(str, existing) {
  const result = {};
  if (!str) return result;
  str.split(',').forEach(part => {
    const [name, qty] = part.split('=').map(s => s.trim());
    const q = parseInt(qty, 10);
    if (name && q > 0) {
      const price = existing && existing[name] ? existing[name].price : 0;
      result[name] = { qty: q, price };
    }
  });
  return result;
}


// —— 安全工具（若已存在则不重复定义）
window.toNum = window.toNum || (v => (v === null || v === undefined || v === '' ? 0 : Number(v)));
window.fmt2  = window.fmt2  || (n => window.toNum(n).toFixed(2));

function addRow(order, highlight = false) {
  const container = document.querySelector('.orders-cards');
  if (!container) return null;

  // —— 基本信息
  const isDelivery = ['delivery', 'bezorgen'].includes(order.order_type);
  const address = isDelivery
    ? `${order.street || ''} ${order.house_number || ''}, ${order.postcode || ''} ${order.city || ''}`.trim()
    : '-';

  // —— 卡片编号（用于地图/显示）
  const map_id = document.querySelectorAll('.order-card-wrapper').length + 1;
  order.map_id = map_id;

  // —— 仅送餐且地址存在时做地理编码（不影响渲染）
  if (isDelivery && address.replace(/[,\s]/g, '').length && window.api?.getGoogleMapsKey) {
    (async () => {
      try {
        const key = await window.api.getGoogleMapsKey();
        const res = await fetch(
          `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${key}`
        );
        const data = await res.json();
        const loc = data.results?.[0]?.geometry?.location;
        if (loc) {
          window.deliveryOrders = window.deliveryOrders || [];
          window.deliveryOrders.push({
            order_number: order.order_number,
            customer_name: order.customer_name,
            lat: loc.lat,
            lng: loc.lng,
            map_id
          });
        }
      } catch (err) {
        console.error('Geocoding failed', err);
      }
    })();
  }

  // —— 菜品渲染（不改你原排序与“自定义项”显示逻辑）
  const items = Object.entries(order.items || {})
    .sort(([, a], [, b]) => {
      const priceA = a.price || 0;
      const priceB = b.price || 0;
      if (priceA === 0 && priceB !== 0) return 1;
      if (priceA !== 0 && priceB === 0) return -1;
      const nameA = (a.displayName || a.name || '').toUpperCase();
      const nameB = (b.displayName || b.name || '').toUpperCase();
      return nameA.localeCompare(nameB);
    })
    .map(([n, i]) => {
      const isFree = (i.price || 0) === 0;
      const displayNameRaw = i.displayName || i.name || n;
      const displayName = /^CUSTOM_/i.test(displayNameRaw)
        ? 'eigen invoer'
        : (isFree ? displayNameRaw.toLowerCase() : displayNameRaw.toUpperCase());
      const rowTotal = (window.toNum(i.qty) * window.toNum(i.price)).toFixed(2).replace('.', ',');
      return `<li>${i.qty} x ${displayName} = €${rowTotal}</li>`;
    }).join('');

  // —— 金额区（严格“只读订单包”，不重新计算）
  const subtotal      = window.toNum(order.subtotal ?? 0);
  const totaal        = window.toNum(order.totaal ?? order.total ?? 0);
  const packaging_fee = window.toNum(order.packaging_fee ?? 0);
  const statiegeld    = window.toNum(order.statiegeld ?? 0);
  const delivery_fee  = window.toNum(order.delivery_fee ?? order.bezorgkosten ?? 0);
  const tip           = window.toNum(order.tip ?? 0);
  const btw_9  = window.toNum(order.btw_9  ?? 0);
  const btw_21 = window.toNum(order.btw_21 ?? 0);

  // --- 本次使用的折扣（唯一标准：直接取订单包字段） ---
let usedKortingHtml = '';
const usedCode = order.discountCode; // 必须直接用订单包里的字段
const usedAmt  = window.toNum(order.discountAmount); // 必须直接用订单包里的字段

if ((usedCode && usedCode.trim() !== '') || usedAmt !== 0) {
  if (usedCode && usedCode.trim().toUpperCase() === 'KASSA') {
    // 特殊处理：现场收银手动优惠
    usedKortingHtml = `<div><strong>Kassa korting</strong></div>`;
  } else {
    const amtTxt = usedAmt !== 0 ? `-€${fmt2(usedAmt)}` : '';
    const codeTxt = usedCode && usedCode.trim() !== '' 
      ? ` <span style="color:#888; font-size:0.9em;">(Metcode: ${usedCode})</span>` 
      : '';
    usedKortingHtml = `<div><strong>Korting ${amtTxt}</strong>${codeTxt}</div>`;
  }
}



  // --- 下次奖励码（唯一标准：直接取订单包字段） ---
// --- 下次奖励码（唯一标准：直接取订单包字段） ---
let volgendeHtml = '';
const nextCode   = order.discount_code;       // 只取订单包字段
const nextAmtNum = window.toNum(order.discount_amount); // 直接转成数字

if (nextAmtNum !== 0) {
  const nextAmtTxt = `<strong>€${fmt2(nextAmtNum)}</strong>`; // 金额粗体
  const codeLine = (nextCode && String(nextCode).trim() !== '')
    ? `<div style="color:#666;font-size:0.9em;">Code: <strong>${nextCode}</strong></div>` 
    : '';

  volgendeHtml = `
    <div class="next-coupon" style="margin-top:6px; max-width:48%;">
      <div style="color:#666;font-size:0.9em; word-wrap:break-word;">
        Hier is uw korting ${nextAmtTxt} voor volgende bedrag
      </div>
      ${codeLine}
    </div>`;
}
  const pm = String(order.payment_method || order.betaalwijze || '')
  .toLowerCase()
  .trim();

// 仅当未取消/未完成，且原状态为空或为“未支付类”时，才自动标记为已支付
if (!order.is_cancelled && !order.is_completed) {
  const isUnpaidish = !order.status || /^(pending|unpaid|open|awaiting_pin_result)$/i.test(String(order.status));
  if (isUnpaidish && (pm === 'online betaald' || (pm.includes('online') && pm.includes('betaald')))) {
    order.status = 'paid';
  }
}




  // —— 时间显示（优先 tijdslot_display；ZSM 则显示 ZSM）
  const tijdslotRaw = order.tijdslot_display || (isDelivery ? order.delivery_time : order.pickup_time);
  const tijdslot = order.is_zsm ? 'ZSM' : (tijdslotRaw || '').trim();
  const status = order.payment_status || order.status || 'pending';
  order.status = order.status || status;
  order.payment_status = order.payment_status || status;

  // —— 组装 DOM
  const wrapper = document.createElement('div');
  wrapper.className = 'order-card-wrapper';

  const card = document.createElement('div');
  card.className = 'order-card';
  if (order.id) card.dataset.id = order.id;
  if (order.order_number) card.dataset.orderNumber = order.order_number;
  if (order.payment_id) card.dataset.paymentId = order.payment_id;
  card.dataset.order = JSON.stringify(order);
  if (order.is_cancelled) card.classList.add('cancelled');
  else if (order.is_completed) card.classList.add('completed');
  if (highlight) {
    card.classList.add('new-order');
    setTimeout(() => card.classList.remove('new-order'), 10000);
  }

  const mapIdDisplay = `<span class="map-id">#${map_id}</span> `;
  card.innerHTML = `
    <div><strong>${mapIdDisplay}Ordernummer:</strong> ${order.order_number || ''}</div>

    <div class="tijdslot-hoofd">
      <div>
        <strong class="${isDelivery ? 'type-bezorging' : 'type-afhalen'}">
          ${isDelivery ? 'Bezorging' : 'Afhalen'}
        </strong>
        <span class="tijdslot" style="color:#e67e22;font-weight:bold;text-transform:uppercase;">
          ${tijdslot || '-'}
        </span>
        &nbsp;&nbsp;<span class="created-at" style="color:#888;">Besteld om: ${order.created_at || '-'}</span>
      </div>
    </div>

    <div><strong>Naam:</strong> ${order.customer_name || ''}</div>
    <div><strong>Telefoon:</strong> ${order.phone || ''}</div>
    ${order.email ? `<div><strong>Email:</strong> <a href="mailto:${order.email}">${order.email}</a></div>` : ''}
    <div><strong>Betaalwijze:</strong> <span class="payment-method">${order.payment_method || ''}</span></div>
    <div><strong>Status:</strong> <span class="order-status">${status}</span></div>
    ${order.bron ? `<div><strong>Bron:</strong> ${order.bron}</div>` : ''}
    <div><strong>Items:</strong><ul>${items}</ul></div>
    ${order.opmerking ? `<div><strong>Opmerking:</strong> ${order.opmerking}</div>` : ''}

    ${subtotal      > 0 ? `<div><strong>Subtotal:</strong> €${fmt2(subtotal)}</div>` : ''}
    ${packaging_fee > 0 ? `<div><strong>Verpakkingskosten:</strong> €${fmt2(packaging_fee)}</div>` : ''}
    ${statiegeld    > 0 ? `<div><strong>Statiegeld:</strong> €${fmt2(statiegeld)}</div>` : ''}
    ${delivery_fee  > 0 ? `<div><strong>Bezorgkosten:</strong> €${fmt2(delivery_fee)}</div>` : ''}
    ${btw_9         > 0 ? `<div><strong>BTW 9%:</strong> €${fmt2(btw_9)}</div>` : ''}
    ${btw_21        > 0 ? `<div><strong>BTW 21%:</strong> €${fmt2(btw_21)}</div>` : ''}

    ${usedKortingHtml}

    
    ${tip > 0 ? `<div><strong>Fooi:</strong> €${fmt2(tip)}</div>` : ''}
    <div><strong>Totaal:</strong> <strong>€${fmt2(totaal)}</strong></div>

    ${address !== '-' ? `
  <div class="qr-address">
    <strong>Adres:</strong> <span style="font-size:0.9em;">${address}</span>
    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}" target="_blank" style="font-size:0.9em; margin-left:6px;">📍Maps</a>
  </div>
  <div class="qr-wrapper">
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent('https://www.google.com/maps?q=' + address)}" alt="QR Code">
  </div>
` : ''}


    

    ${volgendeHtml}
  `;
  const encodedOrder = encodeURIComponent(JSON.stringify(order));
  const actions = document.createElement('div');
  actions.className = 'card-actions';
  actions.innerHTML = `
  <button class="btn-klaar" onclick="toggleComplete(this)"
    data-number="${order.order_number}"
    data-name="${order.customer_name || ''}"
    data-phone="${order.phone || ''}"
    data-email="${order.email || ''}"
    data-type="${isDelivery ? 'bezorg' : 'afhaal'}">
    Klaar
  </button>

  <!-- ✅ 安全打印：把编码后的 JSON 放在 data-order 上 -->
  <button class="btn-print" onclick="printThisOrder(this)" data-order="${encodedOrder}">🖨️ Print</button>

  <button class="btn-afrekenen" data-order-id="${order.id || ''}" data-total="${totaal}" onclick="openCheckout(this)">Afrekenen</button>


  <button class="btn-annuleer" onclick="toggleCancel(this)"
    data-number="${order.order_number}"
    data-name="${order.customer_name || ''}"
    data-phone="${order.phone || ''}"
    data-email="${order.email || ''}"
    data-type="${isDelivery ? 'bezorg' : 'afhaal'}"
    data-id="${order.id}">
    Annuleer
  </button>
  <span class="notify"></span>
`;

 wrapper.appendChild(card);
  wrapper.appendChild(actions);
  container.appendChild(wrapper);

  const mode = window.orderSortMode || 'service';
  wrapper.dataset.sortKey = JSON.stringify(buildSortKeyByMode(order, mode));
  reorderCards(container);

  return wrapper;
}

// ===== 工具：时间解析 =====
function toTs(v){
  if(!v) return Number.POSITIVE_INFINITY;
  const s=String(v).trim();
  if(/^\d{1,2}:\d{2}$/.test(s)){
    const [h,m]=s.split(':').map(Number);
    const now=new Date();
    return new Date(now.getFullYear(),now.getMonth(),now.getDate(),h,m,0).getTime();
  }
  const t=Date.parse(s);
  return Number.isFinite(t)?t:Number.POSITIVE_INFINITY;
}

// ===== 从 DOM 反推订单字段（当 data-order 不存在时使用）=====
function extractOrderFromCard(card){
  const o = {};
  // 状态
  o.is_completed = card.classList.contains('completed');
  o.is_cancelled = card.classList.contains('cancelled');
  const statusEl = card.querySelector('.order-status');
  if (statusEl) o.status = statusEl.textContent.trim();

  // 类型：看有没有 .type-bezorging / .type-afhalen
  const typeEl = card.querySelector('.type-bezorging, .type-afhalen');
  if (typeEl) {
    o.order_type = typeEl.classList.contains('type-bezorging') ? 'bezorgen' : 'afhalen';
  }

  // 档期时间 & ZSM
  const slotEl = card.querySelector('.tijdslot');
  const slotTxt = slotEl ? slotEl.textContent.trim() : '';
  o.tijdslot_display = slotTxt || undefined;
  o.is_zsm = /^zsm$/i.test(slotTxt);

  // 创建时间：从 “Besteld om: ...” 里截取冒号后的部分
  const createdEl = card.querySelector('.created-at');
  if (createdEl) {
    const full = createdEl.textContent || '';
    const m = full.replace(/^.*?:\s*/, ''); // 去掉“Besteld om: ”
    o.created_at = m.trim() || undefined;
  }
  return o;
}

// ===== 排序键生成（与你已有一致）=====
function buildSortKeyService(order){
  const status = order.is_cancelled ? 2 : order.is_completed ? 1 : 0;
  const type = String(order.order_type || '').toLowerCase();
  const isDelivery = (type === 'delivery' || type === 'bezorgen') ? 0 : 1;
  const zsm = !!order.is_zsm;
  const rawSlot = order.tijdslot_display || (isDelivery === 0 ? order.delivery_time : order.pickup_time);
  let slotTs = toTs(rawSlot);
  if (zsm) slotTs = Number.NEGATIVE_INFINITY;  // ZSM 最前（保持不变）

  const createdTs = toTs(order.created_at || order.created_at_local); // ← 只改这行：最早在前
  return [status, slotTs, isDelivery, createdTs];
}


function buildSortKeyArrival(order){
  const createdDesc = -toTs(order.created_at || order.created_at_local);
  const status = order.is_cancelled?2:order.is_completed?1:0;
  return [createdDesc, status];
}

function buildSortKeyByMode(order, mode){
  return (mode==='arrival') ? buildSortKeyArrival(order) : buildSortKeyService(order);
}

function compareSortKey(aEl,bEl){
  let a=[],b=[];
  try{ a=JSON.parse(aEl.dataset.sortKey||'[]'); }catch{}
  try{ b=JSON.parse(bEl.dataset.sortKey||'[]'); }catch{}
  const L=Math.max(a.length,b.length);
  for(let i=0;i<L;i++){
    const ai=a[i]??0, bi=b[i]??0;
    if(ai<bi) return -1;
    if(ai>bi) return 1;
  }
  return 0;
}

function reorderCards(container){
  const nodes=[...container.querySelectorAll('.order-card-wrapper')];
  nodes.sort(compareSortKey).forEach(n=>container.appendChild(n));
}

// 重新给所有卡片计算 sortKey（优先 data-order，缺失则从 DOM 提取）
function resortAll(){
  const container=document.querySelector('.orders-cards');
  if(!container) return;
  const mode=window.orderSortMode||'service';

  container.querySelectorAll('.order-card-wrapper').forEach(w=>{
    const card=w.querySelector('.order-card');
    if(!card) return;
    let order = {};
    if (card.dataset.order) {
      try { order = JSON.parse(card.dataset.order); } catch {}
    }
    if (!order || Object.keys(order).length===0) {
      order = extractOrderFromCard(card);
    }
    w.dataset.sortKey = JSON.stringify(buildSortKeyByMode(order, mode));
  });

  reorderCards(container);
}
// 绑定 navbar 的 #sort-toggle，不生成任何元素
(function initSortToggle(){
  function setup(){
    const btn = document.getElementById('sort-toggle');
    const container = document.querySelector('.orders-cards');
    if (!btn || !container) return; // 等 DOM 或容器

    // 初始模式：优先取本地存储，其次取按钮 data-mode，默认 service
    let mode = localStorage.getItem('orderSortMode') || btn.dataset.mode || 'service';
    window.orderSortMode = mode;

    const syncBtn = () => {
      if (mode === 'service') {
        btn.textContent = '🧑‍🍳';
        btn.title = '出餐顺序';
        btn.dataset.mode = 'service';
      } else {
        btn.textContent = '🕓';
        btn.title = '来当顺序';
        btn.dataset.mode = 'arrival';
      }
    };

    btn.addEventListener('click', () => {
      mode = (mode === 'service') ? 'arrival' : 'service';
      window.orderSortMode = mode;
      localStorage.setItem('orderSortMode', mode);
      syncBtn();
      resortAll(); // 重算 sortKey 并重排
    });

    syncBtn();
    resortAll();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setup, { once: true });
  } else {
    setup();
  }
})();




const orderQueue = [];
let isModalActive = false;
let currentOrder = null;
const processed = new Set();

function normalizeOrder(o = {}) {
  const toNum = v => (v === null || v === undefined || v === '') ? null : Number(v);
  const method = String(o.payment_method || '').toLowerCase();
  const cash   = method === 'cash' || method === 'contant';
  const status = cash ? 'pending' : (o.status || o.payment_status || 'pending');

  return {
    // —— 这些与库里一一对应 ——
    order_id:        String(o.id ?? ''),               // 可选
    order_number:    String(o.order_number || o.orderNumber || ''),
    order_type:      String(o.order_type || ''),
    customer_name:   String(o.customer?.name ?? o.customer_name ?? ''),
    phone:           String(o.customer?.phone ?? o.phone ?? ''),
    email:           String(o.customer?.email ?? o.email ?? ''),
    pickup_time:     String(o.pickup_time ?? ''),
    delivery_time:   String(o.delivery_time ?? ''),
    payment_method:  String(o.payment_method ?? ''),
    postcode:        String(o.postcode ?? o.customer?.postcode ?? ''),
    house_number:    String(o.house_number ?? o.customer?.house_number ?? ''),
    street:          String(o.street ?? o.customer?.street ?? ''),
    city:            String(o.city ?? o.customer?.city ?? ''),
    opmerking:       String(o.opmerking ?? o.notes ?? ''),

    // ✅ 新增 bron
    bron:            String(o.bron ?? o.source ?? ''),

    // 金额专栏
    subtotal:        toNum(o.subtotal ?? o.summary?.subtotal),
    total:           toNum(o.total ?? o.summary?.total ?? o.totaal),
    packaging_fee:   toNum(o.packaging_fee ?? o.summary?.packaging_fee ?? o.verpakkingskosten),
    statiegeld:      toNum(o.statiegeld ?? o.summary?.statiegeld),
    delivery_fee:    toNum(o.delivery_fee  ?? o.summary?.delivery_fee  ?? o.bezorgkosten),
    tip:             toNum(o.tip),
    btw_9:           toNum(o.btw_9),
    btw_21:          toNum(o.btw_21),
    btw_total:       toNum(o.btw_total ?? o.btw),
    status:          status,
    payment_status:  status,

    // ✅ 下次优惠（库里就这一套列名）
    discountAmount:  toNum(o.discountAmount ?? null),
    discountCode:    String(o.discountCode ?? ''),

    discount_code:   (o.discount_code ?? null),
    discount_amount: (o.discount_amount ?? null),
    
    // 其余
    items:           JSON.stringify(Array.isArray(o.items) ? o.items : o.items ? o.items : []),
    data:            JSON.stringify(o),  // ⚠️ 必填：你的 data 列 NOT NULL
    // is_completed / is_cancelled 如需也可赋值
  };
}



function toUIOrder(o) {
  const src = o || {};
  // 1) 时间（优先 tijdslot；送餐显示 delivery_time，自取显示 pickup_time）
  const tijdslot = (src.tijdslot ?? src.timeslot ?? src.pickup_time ?? src.delivery_time ?? '').toString();
  const isDelivery = (src.order_type === 'bezorgen' || src.order_type === 'delivery');
  const uiPickup   = isDelivery ? '' : (src.pickup_time || tijdslot || '');
  const uiDelivery = isDelivery ? (src.delivery_time || tijdslot || '') : '';

  // 2) 金额：直接读取订单包字段，不做推导或容错
  const toNum = v => (v === null || v === undefined || v === '') ? 0 : Number(v);
  const totaal        = toNum(src.totaal ?? src.total ?? 0);
  const subtotal      = toNum(src.subtotal ?? 0);
  const packaging_fee = toNum(
    src.packaging_fee ??
    src.summary?.packaging_fee ??
    src.verpakkingskosten ??
    src.packaging ??
    src.package_fee ??
    0
  );
  const statiegeld = toNum(
    src.statiegeld ??
    src.summary?.statiegeld ??
    0
  );
  const delivery_fee  = isDelivery ? toNum(
    src.delivery_fee ??
    src.summary?.delivery_fee ??
    src.bezorgkosten ??
    0
  ) : 0;
  const fooi          = toNum(src.tip ?? 0);
  const btw_9         = toNum(src.btw_9 ?? 0);
  const btw_21        = toNum(src.btw_21 ?? 0);
  const btw_total     = toNum(src.btw_total ?? src.btw ?? 0);
  const discountAmount = toNum(
    src.discount_used_amount ??
    src.discountAmount ??
    0
  );
  const discountCode   =
    src.discount_used_code ??
    src.discountCode ??
    '';
  const nextDiscountAmount = toNum(
    src.discount_earned_amount ??
    src.discount_amount ??
    0
  );
  const nextDiscountCode   =
    src.discount_earned_code ??
    src.discount_code ??
    '';

  // 3) 明细：UI 现在用对象 { name: {qty, price,...} }；如果传来是数组就转对象
  let itemsObj = {};
  if (src.items && typeof src.items === 'object' && !Array.isArray(src.items)) {
    itemsObj = src.items; // 已是对象
  } else if (Array.isArray(src.items)) {
    itemsObj = src.items.reduce((acc, it) => {
      const name = it.name || it.title || 'Item';
      acc[name] = {
        qty: it.quantity ?? it.qty ?? 1,
        price: toNum(it.unit_price ?? it.price ?? 0),
        packaging: toNum(it.packaging ?? 0),
        statiegeld: toNum(it.statiegeld ?? 0),
        line_total: toNum(it.line_total ?? ((it.unit_price ?? it.price ?? 0) * (it.quantity ?? it.qty ?? 1)))
      };
      return acc;
    }, {});
  }

  // 4) 地址：送餐单通常会有这些；自取可能为空
  const method = String(src.payment_method || '').toLowerCase();
  let status = src.status || src.payment_status || 'pending';
  if (method === 'cash' || method === 'contant') {
    status = 'pending';
  }

  return {
    order_number: src.order_number || src.orderNumber || '',
    customer_name: src.customer?.name ?? src.customer_name ?? '',
    phone: src.customer?.phone ?? src.phone ?? '',
    email: src.customer?.email ?? src.email ?? '',
    street: src.street ?? src.customer?.street ?? '',
    house_number: src.house_number ?? src.customer?.house_number ?? '',
    postcode: src.postcode ?? src.customer?.postcode ?? '',
    city: src.city ?? src.customer?.city ?? '',

    totaal,
    subtotal,
    packaging_fee,
    statiegeld,
    delivery_fee,
    tip: fooi,
    btw_9,
    btw_21,
    btw_total,
    discountCode,
    discountAmount,
    discount_code: nextDiscountCode,
    discount_amount: nextDiscountAmount,

    status: status,

    tijdslot,                    // 原始显示
    pickup_time: uiPickup,       // 自取弹窗显示这个
    delivery_time: uiDelivery,   // 送餐弹窗显示这个
    opmerking: src.opmerking ?? src.notes ?? '',
    bron: src.bron ?? src.source ?? src.order_source ?? '', // 新增的bron处理

    items: itemsObj,             // UI 旧逻辑用对象
    __source: src                // 备用
  };
}


socket.on('new_order', async (order) => {
  try {
    console.log('🆕 Nieuwe bestelling ontvangen!', order);

    // UI 专用对象（兼容老字段：totaal/tijdslot/items{}）
    const uiOrder = toUIOrder(order);      // ✅ 用它给 UI
    // 入库专用对象（结构化、稳定）
    const norm    = normalizeOrder(order); // ✅ 用它写 DB

    if (!norm.order_number) {
      console.warn('❌ 无有效 order_number:', order);
      return;
    }
    if (processed.has(norm.order_number)) {
      console.log('↩️ 已处理过，跳过:', norm.order_number);
      return;
    }

    // 1) 播声音
    try { window.api?.playDing?.(); } catch {}

    // 2) 渲染卡片 —— 用 uiOrder（保持你原有 UI 字段）
    try {
      const row = addRow(uiOrder, true);
      row?.querySelector?.('.btn-print')?.setAttribute('data-number', uiOrder.order_number);
      console.log('✅ 卡片添加成功', row);
    } catch (err) {
      console.error('❌ addRow 失败', err);
    }

    // 3) 入队 & 弹窗 —— 也用 uiOrder（showNextOrderModal 才能读到正确字段）
    orderQueue.push(uiOrder);
    console.log('📥 已加入 orderQueue，当前队列长度:', orderQueue.length);
    if (!isModalActive) {
      console.log('📢 弹出订单提示框');
      showNextOrderModal();
    } else {
      console.log('⏳ 弹窗已激活，等待当前处理完成...');
    }

    // 4) 本地 SQLite 落库 —— 用 norm（结构化入库）
    if (!window.pos?.saveOrder) {
      console.warn('⚠️ window.pos.saveOrder 不存在，检查 preload.js 是否正确暴露');
      return;
    }
    console.log('[R->IPC] will save', norm.order_number);
    const res = await window.pos.saveOrder(norm);
    console.log('[R->IPC] done', res);
    if (res?.ok) {
      processed.add(norm.order_number);
      console.log('💾 已保存到本地 SQLite:', norm.order_number);
    } else {
      console.warn('⚠️ 保存失败，未加入去重集:', norm.order_number, res);
    }

  } catch (e) {
    console.warn('⚠️ 处理 new_order 失败（不影响其它流程）:', e);
  }
});

function showNextOrderModal() {
  if (orderQueue.length === 0) {
    console.log("📭 队列为空，不弹出弹窗");
    return;
  }

  currentOrder = orderQueue.shift();
  isModalActive = true;
  console.log("📦 显示弹窗订单:", currentOrder.order_number);

  // 填充订单信息
  document.getElementById('modal-order-id').textContent = currentOrder.order_number || '-';
  document.getElementById('modal-customer-name').textContent = currentOrder.customer_name || '-';
  document.getElementById('modal-address').textContent = currentOrder.street
    ? `${currentOrder.street} ${currentOrder.house_number} ${currentOrder.postcode} ${currentOrder.city}`
    : '-';
  document.getElementById('modal-items').innerHTML = Object.entries(currentOrder.items || {})
    .map(([name, i]) => `${name} x ${i.qty}`).join('<br>');
  document.getElementById('modal-remark').textContent = currentOrder.opmerking || '-';
  document.getElementById('modal-total').textContent = formatCurrency(currentOrder.totaal || currentOrder.total || 0);

  // ✅ 时间字段处理（优先显示 tijdslot，如果是 ZSM 则保持为 "Z.S.M."）
  const timeInput = document.getElementById('modal-time');
  timeInput.style.display = 'inline-block';

  let tijdslotRaw = currentOrder.tijdslot || '';
  if (tijdslotRaw.toLowerCase().includes('z')) {
    tijdslotRaw = 'Z.S.M.';
  } else if (!tijdslotRaw && currentOrder.pickup_time) {
    tijdslotRaw = currentOrder.pickup_time;
  } else if (!tijdslotRaw && currentOrder.delivery_time) {
    tijdslotRaw = currentOrder.delivery_time;
  }
  timeInput.value = tijdslotRaw;

  // ✅ 正确调用盖章逻辑（不提前显示）
  updateZSMBadge(currentOrder);

  // 显示弹窗
  document.getElementById('order-modal').style.display = 'flex';
  console.log("✅ 弹窗已显示！");
}

window.printThisOrder = async function(btn) {
  try {
    const raw = btn.getAttribute('data-order');
    if (!raw) { alert('❌ 缺少 data-order'); return; }

    // 解码 + 还原订单对象
    const order = JSON.parse(decodeURIComponent(raw));

    // 走你已有的打印通道（preload 暴露的）
    if (window.api?.printReceipt) {
      window.api.printReceipt(JSON.stringify(order));
      console.log('🖨️ 打印订单：', order.order_number || '(未知订单号)');
    } else {
      alert('打印接口不可用：window.api.printReceipt 未暴露');
    }
  } catch (e) {
    console.error('❌ 打印失败：', e);
    alert('打印失败：' + (e?.message || e));
  }
};







function updateZSMBadge(order) {
  const zsmDisplay = document.getElementById('Z.S.M.-display');

  if (!zsmDisplay) return;

  const endsWithZ = (order.order_number || '').endsWith('Z');

  if (endsWithZ) {
    zsmDisplay.style.display = 'inline-block';
    zsmDisplay.textContent = 'Z.S.M.';
  } else if (order.tijdslot) {
    zsmDisplay.style.display = 'inline-block';
    zsmDisplay.textContent = `Tijdslot: ${order.tijdslot}`;
  } else {
    zsmDisplay.style.display = 'none';
  }
}






document.getElementById('modal-confirm').addEventListener('click', async () => {
  if (!currentOrder) return;

  console.log("✅ 用户点击了 Bevestigen");
  const tijdslotOrigineel = currentOrder.pickup_time || currentOrder.delivery_time || '';
  const gekozenTijd = document.getElementById('modal-time').value || tijdslotOrigineel;

  // 如果选择现金支付，直接标记为已支付
  const paidByCash = isCashMethod(currentOrder.payment_method);
  if (paidByCash) {
    currentOrder.status = 'paid';
    currentOrder.payment_status = 'paid';
  }

  if (window.api?.stopDing) {
    window.api.stopDing();
  }

  // 打印小票
  if (window.api?.printReceipt) {
    try {
      window.api.printReceipt(JSON.stringify(currentOrder));
      console.log("🖨️ 当前订单已发送打印请求:", currentOrder.order_number);
    } catch (e) {
      console.warn('打印失败', e);
    }
  }

  // 标记确认并入库
  try {
    currentOrder.is_confirmed = 1;
    const patch = { is_confirmed: 1 };
    if (paidByCash) {
      patch.status = 'paid';
      patch.payment_status = 'paid';
    }
    await window.pos?.updateOrderByNumber?.(currentOrder.order_number, patch);
  } catch (err) {
    console.warn('本地确认标记失败', err);
  }

  // 通知服务器/广播
  try {
    socket.emit('order_confirmed', {
      order_number: currentOrder.order_number,
      is_confirmed: true,
      payment_method: currentOrder.payment_method,
      ...(paidByCash ? { status: 'paid', payment_status: 'paid' } : {})
    });
  } catch (err) {
    console.warn('socket.emit order_confirmed failed', err);
  }

  try {
    await fetch('https://flask-order-api.onrender.com/api/order_confirmed', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        order_number: currentOrder.order_number,
        tijdslot: gekozenTijd,
        is_confirmed: true,
        ...(paidByCash ? { status: 'paid', payment_status: 'paid' } : {})
      })
    });
  } catch (err) {
    console.warn('确认状态发送失败', err);
  }

  // ⏱️ 如果时间更改则发送通知邮件
  if (gekozenTijd !== tijdslotOrigineel) {
    try {
      const response = await fetch('https://flask-order-api.onrender.com/api/order_time_changed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          order_number: currentOrder.order_number,
          name: currentOrder.customer_name,
          email: currentOrder.email,
          order_type: currentOrder.order_type,
          tijdslot: gekozenTijd
        })
      });
      if (!response.ok) throw new Error(`服务器返回错误: ${response.status}`);
      const msg = await response.text();
      console.log("📧 邮件响应:", msg);
    } catch (err) {
      console.warn("❌ 邮件发送失败", err);
    }
  } else {
    console.log("⏳ 时间未更改，无需发送邮件。");
  }

  // 关闭弹窗并处理下一单
  document.getElementById('order-modal').style.display = 'none';
  isModalActive = false;
  currentOrder = null;
  showNextOrderModal();
});


  // 断线后启用轮询
  socket.on('disconnect', () => {
    console.warn('⚠️ Socket verbroken – schakel over op polling');
    startPolling();
  });

  socket.on('connect', () => {
    console.log('✅ Socket verbonden');
    stopPolling();
  });

  socket.on('connect_error', () => {
    setTimeout(() => socket.connect(), 1000);
  });

  // 轮询作为备份
  


  function startPolling() {
    if (pollTimer) return;
    fetchOrders();
    pollTimer = setInterval(fetchOrders, 10000); // 每10秒
  }

  function stopPolling() {
    if (pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  }

  function showToast(msg) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = msg;
    document.body.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('visible'));
    setTimeout(() => {
      toast.classList.remove('visible');
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }



  // —— Wissel (找零) 功能 ——
// 保留你原来的格式器
const euroFmt = new Intl.NumberFormat('nl-NL', { style: 'currency', currency: 'EUR' });

// 更稳健的 0.05 现金四舍五入：用分为单位，避免浮点误差
const toCents = v => Math.round(v * 100);
const centsToEuro = c => c / 100;
// 四舍五入到 5 分（0.05）
const round05Safe = v => {
  let c = toCents(v);
  const r = c % 5;
  if (r >= 3) c += (5 - r);
  else c -= r;
  return centsToEuro(c);
};

// 解析任意输入（允许 €、空格、逗号小数点等）
function parseEuroLoose(input) {
  if (input == null) return 0;
  const s = String(input)
    .replace(/[€\s]/g, '')
    .replace(',', '.');
  const num = parseFloat(s);
  return Number.isFinite(num) ? num : 0;
}

const round05 = v => round05Safe(v); // 保留原名以兼容旧逻辑

let wisselDue = 0;

// —— 动态 UI 附加：建议付款区 + 策略切换 + 欠款提示 ——
// 在 openWissel 时保证这些容器存在
function ensureExtraZones() {
  const modal = document.getElementById('wissel-modal');
  if (!modal) return;

  // 建议付款容器
  if (!document.getElementById('wissel-suggest')) {
    const suggest = document.createElement('div');
    suggest.id = 'wissel-suggest';
    suggest.style.marginTop = '8px';
    suggest.innerHTML = '<div style="font-size:.9em;opacity:.8;margin-bottom:4px">建议付款：</div><div id="wissel-suggest-btns" style="display:flex;flex-wrap:wrap;gap:6px"></div>';
    // 插在找零组合（denoms）之前，更靠上更实用
    const changeRow = document.getElementById('wissel-change')?.parentElement || modal;
    modal.querySelector('#wissel-denoms')?.parentElement?.insertBefore(suggest, document.getElementById('wissel-denoms'));
  }

  // 策略容器（tabs）
  if (!document.getElementById('wissel-strategy')) {
    const strategy = document.createElement('div');
    strategy.id = 'wissel-strategy';
    strategy.style.cssText = 'margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap';
    strategy.innerHTML = `
      <span style="font-size:.9em;opacity:.8">找零策略：</span>
      <button type="button" class="wissel-strat" data-strat="minPieces">最少张/枚</button>
      <button type="button" class="wissel-strat" data-strat="fewCoins">少硬币</button>
      <button type="button" class="wissel-strat" data-strat="fewBills">少纸币</button>
    `;
    document.getElementById('wissel-denoms')?.parentElement?.insertBefore(strategy, document.getElementById('wissel-denoms'));
  }

  // 欠款提示
  if (!document.getElementById('wissel-short')) {
    const shortDiv = document.createElement('div');
    shortDiv.id = 'wissel-short';
    shortDiv.style.cssText = 'margin-top:6px;color:#b00;font-weight:600;display:none';
    shortDiv.textContent = '还需支付：—';
    const paidEl = document.getElementById('wissel-paid');
    (paidEl?.parentElement || modal).appendChild(shortDiv);
  }
}

// —— 建议付款按钮（基于应收金额生成常用面额与就近更高面额） ——
function buildSuggestPayments(due) {
  const btnBox = document.getElementById('wissel-suggest-btns');
  if (!btnBox) return;
  btnBox.innerHTML = '';

  // 常见现金面额
  const common = [5, 10, 20, 50, 100, 200];
  const candidates = new Set();

  // 1) 向上取整到 0.05（现金四舍五入后的精确应收）
  candidates.add(round05Safe(due));

  // 2) 向上凑整到下一个 5、10、20、50、100、200
  for (const d of common) {
    const k = Math.ceil(due / d) * d;
    if (k >= due) candidates.add(round05Safe(k));
  }

  // 3) 适当加一点硬币：+0.50、+1、+2（常见找零组合更好拿）
  [0.5, 1, 2].forEach(x => {
    const k = round05Safe(due + x);
    if (k >= due) candidates.add(k);
  });

  // 排序，限制 8 个以内
  const list = Array.from(candidates).sort((a,b)=>a-b).slice(0,8);

  for (const val of list) {
    const b = document.createElement('button');
    b.type = 'button';
    b.textContent = euroFmt.format(val);
    b.style.cssText = 'padding:6px 10px;border-radius:8px;border:1px solid #ddd;cursor:pointer';
    b.dataset.pay = val.toFixed(2);
    b.addEventListener('click', () => {
      const paidInput = document.getElementById('wissel-paid');
      paidInput.value = Number(b.dataset.pay).toFixed(2);
      updateWissel(); // 复用你的函数
    });
    btnBox.appendChild(b);
  }
}

// —— 找零拆分策略 ——
// 面额表
const BILLS = [500, 200, 100, 50, 20, 10, 5];
const COINS = [2, 1, 0.5, 0.2, 0.1, 0.05];

function makeChange(amount, strategy = 'minPieces') {
  // 使用分（以 5 分为最小单位）来避免误差
  let remaining = round05Safe(amount);
  if (remaining <= 0) return [];

  let denoms;
  switch (strategy) {
    case 'fewCoins':
      // 更倾向纸币：先纸币后硬币（你原来的顺序就是这个，但我们做一次“强偏好”）
      denoms = [...BILLS, ...COINS];
      break;
    case 'fewBills':
      // 更倾向硬币：先硬币后纸币
      denoms = [...COINS, ...BILLS];
      break;
    default:
      // 最少张/枚：其实对欧元组合贪心已近似最优，这里仍用贪心
      denoms = [...BILLS, ...COINS];
  }

  const lines = [];
  for (const d of denoms) {
    // 用分进行整除
    const cnt = Math.floor((toCents(remaining) + 1e-6) / toCents(d));
    if (cnt > 0) {
      lines.push({ d, cnt });
      remaining = round05Safe(remaining - cnt * d);
      if (remaining <= 0) break;
    }
  }
  return lines;
}

function renderChangeLines(lines) {
  return lines.map(({ d, cnt }) => `${cnt} × ${euroFmt.format(d)}`).join('<br>');
}

// —— 打开、关闭、更新 ——（保留原函数名，内部增强）
function openWissel(btn) {
  // 兼容旧 data-total，同时允许 data-total-cents（可选）
  const total = btn?.dataset?.totalCents
    ? centsToEuro(parseInt(btn.dataset.totalCents, 10))
    : Number(btn?.dataset?.total || 0);

  wisselDue = round05Safe(total);

  const modal = document.getElementById('wissel-modal');
  document.getElementById('wissel-due').textContent = euroFmt.format(wisselDue);
  const paid = document.getElementById('wissel-paid');
  paid.value = '';
  document.getElementById('wissel-change').textContent = euroFmt.format(0);
  document.getElementById('wissel-denoms').innerHTML = '';
  ensureExtraZones();
  buildSuggestPayments(wisselDue);

  modal.style.display = 'flex';
  paid.focus();

  // 键盘增强：Esc 关闭，Enter 确认（关闭）
  const onKey = (e) => {
    if (modal.style.display !== 'flex') return;
    if (e.key === 'Escape') closeWissel();
    if (e.key === 'Enter') {
      // 若未足额不关闭，给予抖动提示
      const change = round05Safe(parseEuroLoose(paid.value) - wisselDue);
      if (change < 0) {
        modal.classList.add('shake');
        setTimeout(()=>modal.classList.remove('shake'), 300);
      } else {
        closeWissel();
      }
    }
  };
  // 避免重复绑定
  document.removeEventListener('keydown', onKey);
  document.addEventListener('keydown', onKey, { once: false });
}

function closeWissel() {
  const modal = document.getElementById('wissel-modal');
  modal.style.display = 'none';
}

function updateWissel() {
  const paidInput = document.getElementById('wissel-paid');
  let paid = round05Safe(parseEuroLoose(paidInput.value));
  const change = round05Safe(paid - wisselDue);

  const changeEl = document.getElementById('wissel-change');
  const denomsDiv = document.getElementById('wissel-denoms');

  // 清除状态类
  changeEl.classList.remove('positive','negative','exact');

  if (change < 0) {
    // 还没达到应付 —— 显示“还差 €x,xx”红色
    const deficit = round05Safe(-change);
    changeEl.textContent = `还差 ${euroFmt.format(deficit)}`;
    changeEl.classList.add('negative');
    denomsDiv.innerHTML = '';  // 没到金额前不显示找零组合
  } else if (change === 0) {
    // 刚好 —— 显示“正好/Exact”绿色
    changeEl.textContent = '正好 (Exact)';
    changeEl.classList.add('exact');
    denomsDiv.innerHTML = '';
  } else {
    // 需要找零 —— 显示“找零 €x,xx”绿色，并给出找零组合
    changeEl.textContent = `找零 ${euroFmt.format(change)}`;
    changeEl.classList.add('positive');

    // 当前策略
    const activeBtn = document.querySelector('#wissel-strategy .wissel-strat.active');
    const strat = activeBtn?.dataset?.strat || 'minPieces';
    const lines = makeChange(change, strat);
    denomsDiv.innerHTML = renderChangeLines(lines);
  }
}


// —— 你原有的事件绑定（保留） ——
document.getElementById('wissel-paid').addEventListener('input', updateWissel);
document.getElementById('wissel-close').addEventListener('click', closeWissel);
document.getElementById('wissel-modal').addEventListener('click', e => { if (e.target.id === 'wissel-modal') closeWissel(); });
document.getElementById('wissel-exact').addEventListener('click', () => {
  const paidInput = document.getElementById('wissel-paid');
  paidInput.value = wisselDue.toFixed(2);
  updateWissel();
});
document.querySelectorAll('#wissel-modal [data-add]').forEach(btn => {
  btn.addEventListener('click', () => {
    const paidInput = document.getElementById('wissel-paid');
    const current = parseEuroLoose(paidInput.value || 0);
    const newVal = round05Safe(current + Number(btn.dataset.add));
    paidInput.value = newVal.toFixed(2);
    updateWissel();
  });
});

// —— 新增：策略按钮激活态处理 ——
// 用事件委托避免重复绑定
document.addEventListener('click', (e) => {
  const b = e.target.closest('.wissel-strat');
  if (!b) return;
  document.querySelectorAll('.wissel-strat').forEach(x => x.classList.remove('active'));
  b.classList.add('active');
  updateWissel();
});

  const xbowlModal=document.getElementById('xBowlAddedModal');
  const againBtn=document.getElementById('xBowlAgain');
  const closeXBowlBtn=document.getElementById('xBowlClose');
  function showXBowlModal(){ if(xbowlModal) xbowlModal.style.display='flex'; }
  function hideXBowlModal(){ if(xbowlModal) xbowlModal.style.display='none'; }
  if(againBtn){ againBtn.addEventListener('click',()=>{ clearXBowlSet(); hideXBowlModal(); }); }
  if(closeXBowlBtn){ closeXBowlBtn.addEventListener('click', hideXBowlModal); }

  window.addEventListener('beforeunload', () => socket.disconnect());
  window.addEventListener('focus', () => { newOrderCount = 0; hasNewOrder = false; updateTabTitle(); updateTodayBadge(); });
</script>




 
  
</body></html>
