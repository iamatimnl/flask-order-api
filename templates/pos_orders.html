<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bestellingen Vandaag</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    ul { margin: 0; padding-left: 20px; }
    td:last-child,
th:last-child {
  padding-right: 20px;
}

  </style>
</head>
<body>
  <h1>Bestellingen Vandaag</h1>
<table>
  <thead>
    <tr>
      <th>Datum</th>
      <th>Tijd</th>
      <th>Type</th>
      <th>Klant</th>
      <th>Telefoon</th>
      <th>Email</th>
      <th>Items</th>
      <th>Opmerking</th>
      <th>Totaal (&euro;)</th>  <!-- ‚úÖ Âè™‰øùÁïô‰∏ÄÂàó‰ª∑Ê†º -->
      <th>Adres</th>
      <th>Tijdslot</th>
      <th>Betaling</th>
      <th>Bestelnummer</th>
    </tr>
  </thead>
  <tbody>
  {% for order in orders %}
    <tr>
      <td>{{ order.created_at_local.strftime('%Y-%m-%d') }}</td>
      <td>{{ order.created_at_local.strftime('%H:%M') }}</td>
      <td>{{ order.order_number or '' }}</td>
      
      {% set is_delivery = order.order_type in ['delivery', 'bezorgen'] %}
      <td>{{ 'Bezorgen' if is_delivery else 'Afhalen' }}</td>

      <td>{{ order.customer_name or '' }}</td>
      <td>{{ order.phone or '' }}</td>
      <td>{{ order.email or '-' }}</td>

      <td>
        <ul>
        {% for name, item in order.items_dict.items() %}
          <li>{{ name }} x {{ item['qty'] }}</li>
        {% endfor %}
        </ul>
      </td>

      <td>{{ order.opmerking or '-' }}</td>

      <!-- ‚úÖ Âè™ÊòæÁ§∫ √©√©n prijswaarde -->
      <td>‚Ç¨{{ '%.2f' % (order.totaal or 0) }}</td>

      <td>
        {% if is_delivery %}
          {{ order.street }} {{ order.house_number }} {{ order.postcode }} {{ order.city }}
          {% if order.maps_link %}
            <a href="{{ order.maps_link }}" target="_blank">üìçMaps</a>
          {% endif %}
        {% else %}-{% endif %}
      </td>

      <td>
        {% if is_delivery %}
          {{ order.delivery_time or '-' }}
        {% else %}
          {{ order.pickup_time or '-' }}
        {% endif %}
      </td>

      <td>{{ order.payment_method or '-' }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
  <p><a href="{{ url_for('pos') }}">Terug naar POS</a></p>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io({transports:['websocket']});
    let pollTimer;
    window.addEventListener('beforeunload',()=>socket.disconnect());
    socket.on('connect_error',()=>{setTimeout(()=>socket.connect(),1000);});
    socket.on('disconnect', startPolling);
    socket.on('connect', stopPolling);
    function formatCurrency(value) {
  if (typeof value === 'string') {
    value = value.replace(/[^\d,.-]/g, '').replace(',', '.').trim();
  }
  const num = parseFloat(value);
  return isNaN(num) ? "‚Ç¨0.00" : `‚Ç¨${num.toFixed(2)}`;
}

     


    function addRow(order) {
  const tbody = document.querySelector('table tbody');
  const tr = document.createElement('tr');
  const isDelivery = ['delivery','bezorgen'].includes(order.order_type);
  const items = Object.entries(order.items || {}).map(([n,i]) => `<li>${n} x ${i.qty}</li>`).join('');

  // ÂÆâÂÖ®Ëé∑Âèñ subtotal
  let subtotal = parseFloat(order.subtotal);
  if (isNaN(subtotal)) {
    subtotal = Object.values(order.items || {}).reduce(
      (s, i) => s + (parseFloat(i.price || 0) * parseInt(i.qty || 0)),
      0
    );
  }

  // ÂÆâÂÖ®Ëé∑Âèñ totaal ÂÄº
  let totaalVal = order.totaal ?? order.total ?? subtotal;
  if (typeof totaalVal === 'string') {
    totaalVal = parseFloat(totaalVal.replace(/[^\d,.-]/g, '').replace(',', '.').trim());
  }

  const remark = order.opmerking || order.remark || '';
  const pickup = order.pickup_time || order.pickupTime;
  const delivery = order.delivery_time || order.deliveryTime;

  tr.innerHTML = `
  <td>${order.created_date || ''}</td>
  <td>${order.created_at || ''}</td>
  <td>${isDelivery ? 'Bezorgen' : 'Afhalen'}</td>
  <td>${order.customer_name || ''}</td>
  <td>${order.phone || ''}</td>
  <td>${order.email || '-'}</td>
  <td><ul>${items}</ul></td>
  <td>${remark || '-'}</td>
  <td>${formatCurrency(totaalVal)}</td>
  <td>${isDelivery ? `${order.street} ${order.house_number} ${order.postcode} ${order.city}${order.maps_link ? ` <a href="${order.maps_link}" target="_blank">üìçMaps</a>` : ''}` : '-'}</td>
  <td>${isDelivery ? (delivery || '-') : (pickup || '-')}</td>
  <td>${order.payment_method || '-'}</td>
  <td>${order.order_number || ''}</td>
`;



  tbody.prepend(tr);
}

    socket.on('new_order', order => {
      console.log(order);
      if(!('totaal' in order) && !('total' in order)){
        console.warn('‚ö†Ô∏è totaal Â≠óÊÆµÁº∫Â§±ÔºåËØ∑ËÅîÁ≥ªÂêéÁ´Ø');
      }
      addRow(order);
    });

    function fetchOrders(){
      fetch('/pos/orders_today?json=1').then(r=>r.json()).then(data=>{
        const tbody = document.querySelector('table tbody');
        if(!tbody) return;
        tbody.innerHTML='';
        data.forEach(addRow);
      }).catch(()=>{});
    }

    function startPolling(){
      if(pollTimer) return;
      fetchOrders();
      pollTimer = setInterval(fetchOrders,10000);
    }

    function stopPolling(){
      if(pollTimer){
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }
  </script>
</body>
</html>
